# =============================================================================
# DIVE V3 Deployment Timeout Configuration
# =============================================================================
# Purpose: Centralized timeout values for deployment orchestration
# Usage: Automatically loaded by orchestration-framework.sh
#        Override via environment: TIMEOUT_KEYCLOAK=300 ./dive hub deploy
# =============================================================================
# Date: 2026-01-25
# Based on: P99 startup times + 50-100% safety margin
# =============================================================================

# ---------------------------------------------------------------------------
# SERVICE STARTUP TIMEOUTS (seconds)
# ---------------------------------------------------------------------------
# Rationale: Based on observed P99 startup times with appropriate margins
# Formula: timeout = P99 * (1 + safety_margin)

# Database Services (typically fast, small margins)
TIMEOUT_POSTGRES=60              # P99: 40s,  Margin: 50%  (reliable, predictable)
TIMEOUT_MONGODB=90               # P99: 60s,  Margin: 50%  (replica set initialization)
TIMEOUT_REDIS=30                 # P99: 15s,  Margin: 100% (very fast, generous margin)
TIMEOUT_REDIS_BLACKLIST=30       # P99: 15s,  Margin: 100% (shared blacklist Redis)

# Identity & Authorization Services (complex initialization, larger margins)
TIMEOUT_KEYCLOAK=180             # P99: 120s, Margin: 50%  (realm import, migrations)
TIMEOUT_OPA=30                   # P99: 15s,  Margin: 100% (policy loading is fast)
TIMEOUT_AUTHZFORCE=90            # P99: 60s,  Margin: 50%  (XACML PDP initialization)

# Application Services (dependency-heavy, moderate margins)
TIMEOUT_BACKEND=120              # P99: 90s,  Margin: 33%  (DB connections, OPA health)
TIMEOUT_FRONTEND=90              # P99: 60s,  Margin: 50%  (Next.js build, dependencies)
TIMEOUT_KAS=60                   # P99: 45s,  Margin: 33%  (key service initialization)

# Policy Distribution Services
TIMEOUT_OPAL_SERVER=60           # P99: 40s,  Margin: 50%  (OPAL hub server)
TIMEOUT_OPAL_CLIENT=30           # P99: 20s,  Margin: 50%  (spoke OPAL client)
TIMEOUT_OPAL_DATA_SOURCE=30      # P99: 20s,  Margin: 50%  (policy data API)

# Monitoring & Observability Services
TIMEOUT_OTEL_COLLECTOR=30        # P99: 20s,  Margin: 50%  (telemetry collector)
TIMEOUT_PROMETHEUS=45            # P99: 30s,  Margin: 50%  (metrics DB)
TIMEOUT_GRAFANA=45               # P99: 30s,  Margin: 50%  (dashboard server)
TIMEOUT_LOKI=45                  # P99: 30s,  Margin: 50%  (log aggregation)
TIMEOUT_TEMPO=45                 # P99: 30s,  Margin: 50%  (trace backend)

# Infrastructure Services
TIMEOUT_NGINX=20                 # P99: 10s,  Margin: 100% (static server, very fast)
TIMEOUT_CLOUDFLARED=30           # P99: 20s,  Margin: 50%  (tunnel establishment)

# ---------------------------------------------------------------------------
# ORCHESTRATION TIMEOUTS (seconds)
# ---------------------------------------------------------------------------
# Timeouts for orchestration operations (not individual services)

# State Management
TIMEOUT_LOCK_ACQUISITION=30      # PostgreSQL advisory lock acquisition
TIMEOUT_STATE_TRANSITION=10      # File-based state writes (should be instant)
TIMEOUT_CHECKPOINT_CREATE=60     # Creating deployment checkpoints

# Health Checking
TIMEOUT_HEALTH_CHECK=5           # Single health check attempt per service
TIMEOUT_ALL_HEALTHY=300          # Wait for all services to become healthy (5 min)

# Circuit Breaker
TIMEOUT_CIRCUIT_BREAKER=60       # Auto-transition OPEN â†’ HALF_OPEN
CIRCUIT_FAILURE_THRESHOLD=3      # Open circuit after N failures
CIRCUIT_SUCCESS_THRESHOLD=2      # Close circuit after N successes in HALF_OPEN

# Deployment Phases
TIMEOUT_PHASE_PREFLIGHT=60       # Pre-deployment validation checks
TIMEOUT_PHASE_INIT=120           # Directory creation, secret loading
TIMEOUT_PHASE_DEPLOY=300         # Service startup phase (5 min)
TIMEOUT_PHASE_CONFIG=180         # Terraform apply, client configuration
TIMEOUT_PHASE_VERIFY=60          # Post-deployment health verification
TIMEOUT_PHASE_COMPLETE=30        # Finalization tasks

# Total Deployment Timeouts
TIMEOUT_HUB_DEPLOY=600           # Total hub deployment (10 min max)
TIMEOUT_SPOKE_DEPLOY=480         # Total spoke deployment (8 min max)

# ---------------------------------------------------------------------------
# RETRY CONFIGURATION
# ---------------------------------------------------------------------------
# Controls retry behavior for transient failures

# Retry Attempts (max retries before giving up)
MAX_RETRIES_HEALTH_CHECK=10      # Health check retries per service
MAX_RETRIES_SECRET_FETCH=15      # GCP Secret Manager fetch retries
MAX_RETRIES_NETWORK=5            # Network operation retries
MAX_RETRIES_KEYCLOAK=5           # Keycloak API operation retries
MAX_RETRIES_FEDERATION=3         # Federation link retries

# Retry Delays (base delay in seconds, backoff applied)
RETRY_DELAY_HEALTH_CHECK=5       # Linear backoff: 5s, 10s, 15s...
RETRY_DELAY_SECRET_FETCH=2       # Exponential backoff: 2s, 4s, 8s...
RETRY_DELAY_NETWORK=3            # Exponential + jitter
RETRY_DELAY_KEYCLOAK=5           # Progressive backoff
RETRY_DELAY_FEDERATION=10        # Fixed + jitter

# ---------------------------------------------------------------------------
# PERFORMANCE TARGETS
# ---------------------------------------------------------------------------
# These are goals, not enforced timeouts (for metrics/alerting)

TARGET_HUB_DEPLOY_TIME=300       # Hub should deploy in < 5 minutes
TARGET_SPOKE_DEPLOY_TIME=240     # Spoke should deploy in < 4 minutes
TARGET_HEALTH_CONVERGENCE=90     # All services healthy in < 90s after start

# ---------------------------------------------------------------------------
# FAILURE THRESHOLDS
# ---------------------------------------------------------------------------
# When to trigger automatic rollback or escalation

# Error accumulation thresholds
ERROR_THRESHOLD_CRITICAL=1       # Rollback immediately on any critical error
ERROR_THRESHOLD_HIGH=3           # Rollback after 3 high-severity errors
ERROR_THRESHOLD_MEDIUM=10        # Log warning after 10 medium errors (continue)

# Time-based thresholds
MAX_DEPLOYMENT_AGE=3600          # Deployment state older than 1 hour = stale
MAX_UNHEALTHY_DURATION=300       # Service unhealthy for 5 min = failed

# Predictive thresholds
FAILURE_PROBABILITY_WARN=50      # Warn when failure probability > 50%
FAILURE_PROBABILITY_ABORT=80     # Abort when failure probability > 80%

# ---------------------------------------------------------------------------
# ENVIRONMENT-SPECIFIC OVERRIDES
# ---------------------------------------------------------------------------
# These can be overridden per environment (dev/staging/prod)

# Development: Shorter timeouts for faster feedback
if [ "${DIVE_ENV:-production}" = "development" ]; then
    TIMEOUT_KEYCLOAK=120
    TIMEOUT_BACKEND=90
    TIMEOUT_FRONTEND=60
    TIMEOUT_HUB_DEPLOY=420
fi

# Production: Longer timeouts for reliability
if [ "${DIVE_ENV:-production}" = "production" ]; then
    TIMEOUT_KEYCLOAK=240
    TIMEOUT_BACKEND=150
    TIMEOUT_FRONTEND=120
    TIMEOUT_HUB_DEPLOY=720
fi

# ---------------------------------------------------------------------------
# NOTES
# ---------------------------------------------------------------------------
#
# Health Check Intervals vs Timeouts:
#   - Health check intervals are in docker-compose.yml (not here)
#   - These timeouts control orchestration logic (shell scripts)
#   - Example: TIMEOUT_KEYCLOAK=180 means wait up to 180s for Keycloak
#     container to show "healthy" status (Docker health checks run internally)
#
# Tuning Guidelines:
#   1. Monitor actual P99 times: ./dive metrics deployment-times
#   2. Adjust margins based on failure rate (too many timeouts = increase)
#   3. Consider environment (dev vs prod, local vs cloud)
#   4. Account for cold starts (first deployment after reboot is slower)
#
# Common Timeout Scenarios:
#   - Keycloak timeout: Increase if running migrations or large realm imports
#   - Backend timeout: Increase if MongoDB slow to establish connections
#   - Frontend timeout: Increase if npm install runs (shouldn't in production)
#   - Full deployment timeout: Sum of critical path + buffer
#
# =============================================================================
# END OF CONFIGURATION
# =============================================================================
