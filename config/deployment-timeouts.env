# DIVE V3 Deployment Timeout Configuration
# =============================================================================
# All timeout values in seconds
# Format: TIMEOUT_<SERVICE>=<seconds>
# Each timeout is calculated as: P99 startup time + safety margin
# =============================================================================

# =============================================================================
# SERVICE STARTUP TIMEOUTS
# =============================================================================
# Rationale: Based on observed P99 startup times with appropriate safety margins
# Margins: 50% for stable services, 60-100% for services with variable startup

# Core Infrastructure Services
TIMEOUT_POSTGRES=60          # P99: 40s, Margin: 50% (stable startup)
TIMEOUT_MONGODB=90           # P99: 60s, Margin: 50% (replica set initialization)
TIMEOUT_REDIS=30             # P99: 15s, Margin: 100% (fast, but cache warming varies)

# Identity & Access Management
TIMEOUT_KEYCLOAK=240         # P99: 150s, Margin: 60% (realm import, theme compilation)
                             # Note: Largest bottleneck, future optimization target

# Application Services
TIMEOUT_BACKEND=120          # P99: 90s, Margin: 33% (JWT verification, DB connections)
TIMEOUT_FRONTEND=60          # P99: 45s, Margin: 33% (Next.js build, static generation)

# Policy & Authorization Services
TIMEOUT_OPA=30               # P99: 15s, Margin: 100% (policy compilation)
TIMEOUT_OPAL_SERVER=45       # P99: 30s, Margin: 50% (policy data sync)
TIMEOUT_OPAL_CLIENT=30       # P99: 20s, Margin: 50% (policy subscription)

# Security & Encryption Services
TIMEOUT_KAS=60               # P99: 45s, Margin: 33% (key initialization)
TIMEOUT_AUTHZFORCE=60        # P99: 40s, Margin: 50% (policy engine startup)

# Monitoring & Observability Services
TIMEOUT_PROMETHEUS=45        # P99: 30s, Margin: 50% (metrics initialization)
TIMEOUT_GRAFANA=45           # P99: 30s, Margin: 50% (dashboard loading)
TIMEOUT_LOKI=45              # P99: 30s, Margin: 50% (log aggregation setup)
TIMEOUT_TEMPO=45             # P99: 30s, Margin: 50% (trace storage init)

# Network & Proxy Services
TIMEOUT_NGINX=30             # P99: 20s, Margin: 50% (config validation)
TIMEOUT_CLOUDFLARED=30       # P99: 20s, Margin: 50% (tunnel establishment)

# =============================================================================
# ORCHESTRATION TIMEOUTS
# =============================================================================

# Deployment Lock Management
TIMEOUT_LOCK_ACQUISITION=30  # PostgreSQL advisory lock acquisition
                             # Sufficient for normal operations, fails fast if stuck

# Health Check Configuration
TIMEOUT_HEALTH_CHECK=5       # Single health check HTTP request
                             # Short timeout to fail fast and retry quickly
HEALTH_CHECK_INTERVAL=2      # Seconds between health check attempts
HEALTH_CHECK_MAX_ATTEMPTS=30 # Max attempts before declaring failure

# Circuit Breaker Configuration
TIMEOUT_CIRCUIT_BREAKER=60   # Seconds before auto-reset from OPEN to HALF_OPEN
                             # Balance between giving service time to recover and failing fast
CIRCUIT_FAILURE_THRESHOLD=3  # Failures before opening circuit
CIRCUIT_SUCCESS_THRESHOLD=2  # Successes in HALF_OPEN before closing

# Deployment Phase Timeouts
TIMEOUT_PHASE_PREFLIGHT=60   # Preflight checks (Docker, disk space, dependencies)
TIMEOUT_PHASE_INIT=120       # Initialization (directories, configs, secrets)
TIMEOUT_PHASE_DEPLOYMENT=600 # Service deployment (sum of parallel service startups)
TIMEOUT_PHASE_CONFIG=300     # Configuration (Terraform, Keycloak realm, federation)
TIMEOUT_PHASE_VALIDATION=120 # Post-deployment validation and health checks
TIMEOUT_PHASE_SEEDING=180    # Database seeding (test users, resources)

# =============================================================================
# RETRY CONFIGURATION
# =============================================================================

# Smart Retry Settings
RETRY_MAX_ATTEMPTS=3         # Maximum retry attempts for transient failures
RETRY_BASE_DELAY=5           # Base delay in seconds between retries
RETRY_BACKOFF_MULTIPLIER=2   # Exponential backoff multiplier (5s, 10s, 20s)
RETRY_MAX_DELAY=30           # Maximum delay between retries (cap exponential growth)

# Context-Aware Retry Delays (override base delay for specific operations)
RETRY_DELAY_KEYCLOAK=10      # Keycloak operations need more time to stabilize
RETRY_DELAY_MONGODB=8        # MongoDB replica set operations
RETRY_DELAY_FEDERATION=5     # Federation operations (usually permanent failures)
RETRY_DELAY_SECRET=3         # GCP secret operations (usually fast)

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Parallel Startup Configuration
PARALLEL_STARTUP_ENABLED=true    # Enable parallel service startup by dependency level
PARALLEL_MAX_CONCURRENT=10       # Max services to start concurrently (prevent resource exhaustion)
PARALLEL_LEVEL_DELAY=5           # Seconds to wait between dependency levels

# Dynamic Timeout Configuration
DYNAMIC_TIMEOUT_ENABLED=false    # Use historical data for adaptive timeouts (Phase 3)
DYNAMIC_TIMEOUT_MIN_SAMPLES=3    # Minimum samples required for dynamic calculation
DYNAMIC_TIMEOUT_MARGIN=50        # Percentage margin above P95 for dynamic timeouts

# =============================================================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# =============================================================================
# Users can override any timeout by setting environment variables before deployment:
#
# Example: Increase Keycloak timeout for slow environments
#   export TIMEOUT_KEYCLOAK=360
#   ./dive deploy hub
#
# Example: Disable parallel startup for debugging
#   export PARALLEL_STARTUP_ENABLED=false
#   ./dive deploy hub
#
# Example: Reduce timeouts for fast environments (CI/CD)
#   export TIMEOUT_KEYCLOAK=180
#   export TIMEOUT_BACKEND=90
#   ./dive deploy hub
# =============================================================================

# =============================================================================
# TIMEOUT CALCULATION GUIDELINES
# =============================================================================
# When adding new services or adjusting timeouts, follow these guidelines:
#
# 1. Measure P99 startup time over 20+ deployments
# 2. Apply appropriate margin based on service characteristics:
#    - Stable services (DB, cache): 30-50% margin
#    - Variable services (Keycloak, backend): 50-100% margin
#    - Fast services (OPA, nginx): 100% margin (still short absolute time)
#
# 3. Document rationale in comments above timeout
# 4. Test with 10 consecutive deployments to verify no false failures
# 5. Monitor and adjust based on production data
#
# Formula: TIMEOUT = P99_STARTUP_TIME * (1 + MARGIN_PERCENTAGE/100)
# =============================================================================

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
# If deployments are timing out:
#
# 1. Check actual startup times:
#    docker logs dive-hub-<service> --timestamps
#
# 2. Review orchestration metrics:
#    ./dive orch-db status
#    SELECT * FROM deployment_steps WHERE step_name LIKE 'start_%' ORDER BY duration_seconds DESC;
#
# 3. Increase timeout temporarily for testing:
#    export TIMEOUT_<SERVICE>=<higher_value>
#    ./dive deploy hub
#
# 4. If consistently hitting timeout, update this file with new P99 data
# =============================================================================
