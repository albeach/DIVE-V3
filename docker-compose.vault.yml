# ============================================================================
# DIVE V3 - Docker Compose Vault Integration Override
# ============================================================================
# This override file adds GCP Secret Manager integration for Keycloak.
# Use with: docker compose -f docker-compose.yml -f docker-compose.vault.yml up
#
# Prerequisites:
# 1. GCP service account key file at ./gcp/service-account.json
# 2. INSTANCE environment variable set (usa, fra, gbr, deu)
# 3. Secrets uploaded to GCP Secret Manager
# ============================================================================

services:
  # ==========================================================================
  # VAULT SYNC INIT CONTAINER
  # ==========================================================================
  # Syncs secrets from GCP Secret Manager to the vault directory
  # Runs before Keycloak starts
  keycloak-vault-sync:
    image: google/cloud-sdk:slim
    container_name: dive-v3-vault-sync
    volumes:
      - keycloak_vault:/opt/keycloak/vault
      - ./config:/config:ro
      - ./scripts/vault/sync-secrets-to-files.sh:/sync.sh:ro
      - ${GCP_SA_KEY_FILE:-./gcp/${INSTANCE:-usa}-sa-key.json}:/gcp/service-account.json:ro
    environment:
      INSTANCE: ${INSTANCE:-usa}
      REALM: dive-v3-broker
      VAULT_DIR: /opt/keycloak/vault
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-dive25}
      GOOGLE_APPLICATION_CREDENTIALS: /gcp/service-account.json
      REGISTRY_FILE: /config/federation-registry.json
    entrypoint: ["/bin/bash", "-c"]
    command: ["gcloud auth activate-service-account --key-file=/gcp/service-account.json && /sync.sh"]
    restart: "no"
    networks:
      - dive-network

  # ==========================================================================
  # KEYCLOAK WITH VAULT SPI
  # ==========================================================================
  keycloak:
    depends_on:
      keycloak-vault-sync:
        condition: service_completed_successfully
    volumes:
      # Add vault directory mount
      - keycloak_vault:/opt/keycloak/vault:ro
    # Override command to enable vault
    command: >
      start-dev
      --spi-login-protocol-openid-connect-suppress-logout-confirmation-screen=true
      --features=scripts
      --vault=file
      --vault-dir=/opt/keycloak/vault
      --spi-vault-file-key-resolvers=REALM_UNDERSCORE_KEY

# ==========================================================================
# VOLUMES
# ==========================================================================
volumes:
  keycloak_vault:
    driver: local

# ==========================================================================
# NETWORKS
# ==========================================================================
# Use existing networks from docker-compose.yml - do not create new ones
networks:
  dive-network:
    external: true
    name: dive-v3_dive-network

