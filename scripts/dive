#!/usr/bin/env bash
# =============================================================================
# DIVE V3 - Unified Instance Manager
# =============================================================================
# Best Practice: Single entry point for all instance operations
# Usage: ./scripts/dive <command> [instance] [options]
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================================================
# CONFIGURATION
# =============================================================================

# Known instances (add new ones here)
declare -A INSTANCES=(
    ["usa"]="USA|docker-compose.yml|3000|4000|8443"
    ["fra"]="France|instances/fra/docker-compose.yml|3001|4001|8444"
    ["deu"]="Germany|instances/deu/docker-compose.yml|3002|4002|8445"
)

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

log_info()  { echo -e "${BLUE}[INFO]${NC} $1"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

get_instance_config() {
    local code="${1^^}"
    local key="$2"
    local config="${INSTANCES[${code,,}]:-}"
    
    if [[ -z "$config" ]]; then
        return 1
    fi
    
    IFS='|' read -r name compose frontend backend keycloak <<< "$config"
    
    case "$key" in
        name) echo "$name" ;;
        compose) echo "$compose" ;;
        frontend) echo "$frontend" ;;
        backend) echo "$backend" ;;
        keycloak) echo "$keycloak" ;;
        *) return 1 ;;
    esac
}

# =============================================================================
# COMMANDS
# =============================================================================

cmd_up() {
    local instance="${1:-all}"
    
    if [[ "$instance" == "all" ]]; then
        for code in "${!INSTANCES[@]}"; do
            cmd_up "$code"
        done
        return
    fi
    
    local code="${instance,,}"
    local name=$(get_instance_config "$code" name) || { log_error "Unknown instance: $instance"; return 1; }
    local compose=$(get_instance_config "$code" compose)
    
    log_info "Starting $name instance..."
    
    cd "$PROJECT_ROOT"
    
    # Use project name for network isolation
    if [[ "$code" == "usa" ]]; then
        docker-compose -p "dive-usa" -f "$compose" up -d
    else
        docker-compose -p "dive-$code" -f "$compose" up -d
    fi
    
    log_ok "$name instance started"
}

cmd_down() {
    local instance="${1:-all}"
    
    if [[ "$instance" == "all" ]]; then
        for code in "${!INSTANCES[@]}"; do
            cmd_down "$code"
        done
        return
    fi
    
    local code="${instance,,}"
    local name=$(get_instance_config "$code" name) || { log_error "Unknown instance: $instance"; return 1; }
    local compose=$(get_instance_config "$code" compose)
    
    log_info "Stopping $name instance..."
    
    cd "$PROJECT_ROOT"
    docker-compose -p "dive-$code" -f "$compose" down
    
    log_ok "$name instance stopped"
}

cmd_restart() {
    local instance="${1:-all}"
    cmd_down "$instance"
    sleep 2
    cmd_up "$instance"
}

cmd_status() {
    set +e  # Disable exit on error for health checks
    
    echo ""
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║              DIVE V3 - Instance Health Dashboard              ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Quick status table
    echo "INST   FRONTEND   BACKEND    KEYCLOAK   IdPs   EXTERNAL URL"
    echo "────   ────────   ───────    ────────   ────   ─────────────────────────"
    
    for inst in "USA|3000|4000|8443|usa" "FRA|3001|4001|8444|fra" "DEU|3002|4002|8445|deu"; do
        IFS='|' read -r name fp bp kp code <<< "$inst"
        
        # Check services
        fe=$(curl -sk "https://localhost:$fp" -o /dev/null -w "%{http_code}" --max-time 3 2>/dev/null)
        be=$(curl -sk "https://localhost:$bp/health" -o /dev/null -w "%{http_code}" --max-time 2 2>/dev/null)
        kc=$(curl -sk "https://localhost:$kp/realms/dive-v3-broker" -o /dev/null -w "%{http_code}" --max-time 2 2>/dev/null)
        idps=$(curl -sk "https://localhost:$bp/api/idps/public" --max-time 2 2>/dev/null | grep -o '"total":[0-9]*' | cut -d: -f2)
        
        [[ -z "$fe" ]] && fe="---"
        [[ -z "$be" ]] && be="---"
        [[ -z "$kc" ]] && kc="---"
        [[ -z "$idps" ]] && idps="?"
        
        # Color code status
        [[ "$fe" == "200" ]] && fe_out="${GREEN}✓ 200${NC}" || fe_out="${RED}✗ $fe${NC}"
        [[ "$be" == "200" ]] && be_out="${GREEN}✓ 200${NC}" || be_out="${RED}✗ $be${NC}"
        [[ "$kc" == "200" ]] && kc_out="${GREEN}✓ 200${NC}" || kc_out="${RED}✗ $kc${NC}"
        
        echo -e "$name     $fe_out     $be_out     $kc_out     $idps      https://${code}-app.dive25.com"
    done
    
    set -e  # Re-enable
    
    echo ""
    echo -e "${CYAN}━━━ Cloudflare Tunnels ━━━${NC}"
    cloudflared tunnel list 2>/dev/null | grep -E "dive-v3-(tunnel|fra|deu)" | while read line; do
        local conns=$(echo "$line" | awk '{print $NF}')
        if [[ -n "$conns" && "$conns" =~ ^[0-9] ]]; then
            echo -e "  ${GREEN}●${NC} $(echo "$line" | awk '{print $2}'): Active ($conns)"
        else
            echo -e "  ${YELLOW}○${NC} $(echo "$line" | awk '{print $2}'): No connections"
        fi
    done
    
    echo ""
    echo -e "${CYAN}━━━ Quick Commands ━━━${NC}"
    echo "  ./scripts/dive up [usa|fra|deu|all]    Start instance(s)"
    echo "  ./scripts/dive down [usa|fra|deu|all]  Stop instance(s)"
    echo "  ./scripts/dive logs <instance>         View logs"
    echo ""
}

cmd_logs() {
    local instance="${1:-usa}"
    local service="${2:-}"
    
    local code="${instance,,}"
    local compose=$(get_instance_config "$code" compose) || { log_error "Unknown instance: $instance"; return 1; }
    
    cd "$PROJECT_ROOT"
    
    if [[ -n "$service" ]]; then
        docker-compose -p "dive-$code" -f "$compose" logs -f "$service"
    else
        docker-compose -p "dive-$code" -f "$compose" logs -f
    fi
}

cmd_tunnel() {
    local instance="${1:-usa}"
    local action="${2:-start}"
    
    case "$action" in
        start)
            log_info "Starting tunnel for $instance..."
            case "${instance,,}" in
                usa)
                    nohup cloudflared tunnel --config ~/.cloudflared/config.yml run > /tmp/tunnel-usa.log 2>&1 &
                    ;;
                fra)
                    nohup cloudflared tunnel --config "$PROJECT_ROOT/instances/fra/cloudflared/config.yml" run > /tmp/tunnel-fra.log 2>&1 &
                    ;;
                deu)
                    nohup cloudflared tunnel --config "$PROJECT_ROOT/instances/deu/cloudflared/config.yml" run > /tmp/tunnel-deu.log 2>&1 &
                    ;;
            esac
            sleep 2
            log_ok "Tunnel started"
            ;;
        stop)
            pkill -f "cloudflared.*$instance" 2>/dev/null || true
            log_ok "Tunnel stopped"
            ;;
        *)
            log_error "Unknown action: $action (use start/stop)"
            ;;
    esac
}

cmd_help() {
    cat << EOF
${CYAN}DIVE V3 Instance Manager${NC}

${YELLOW}Usage:${NC}
  ./scripts/dive <command> [instance] [options]

${YELLOW}Commands:${NC}
  up [instance]       Start instance(s)       ./scripts/dive up fra
  down [instance]     Stop instance(s)        ./scripts/dive down all
  restart [instance]  Restart instance(s)     ./scripts/dive restart usa
  status              Show all instance status
  logs <instance>     View instance logs      ./scripts/dive logs fra keycloak
  tunnel <instance>   Manage CF tunnel        ./scripts/dive tunnel fra start

${YELLOW}Instances:${NC}
  usa    United States (primary)
  fra    France
  deu    Germany
  all    All instances

${YELLOW}Examples:${NC}
  ./scripts/dive up usa          # Start USA only
  ./scripts/dive up all          # Start all instances
  ./scripts/dive status          # Health dashboard
  ./scripts/dive logs fra        # Stream FRA logs
  ./scripts/dive tunnel fra start # Start FRA tunnel

EOF
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    local cmd="${1:-help}"
    shift || true
    
    case "$cmd" in
        up)      cmd_up "$@" ;;
        down)    cmd_down "$@" ;;
        restart) cmd_restart "$@" ;;
        status)  cmd_status "$@" ;;
        logs)    cmd_logs "$@" ;;
        tunnel)  cmd_tunnel "$@" ;;
        help|--help|-h) cmd_help ;;
        *)
            log_error "Unknown command: $cmd"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"

