#!/usr/bin/env bash
# =============================================================================
# DIVE V3 - Unified Instance Manager
# =============================================================================
# Frictionless management of all DIVE V3 instances for demo/pilot.
#
# Usage:
#   ./scripts/dive [command] [instance]
#
# Examples:
#   ./scripts/dive up              # Start USA (default)
#   ./scripts/dive up fra          # Start France
#   ./scripts/dive up all          # Start all instances
#   ./scripts/dive status          # Show all instance status
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Project root
DIVE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$DIVE_ROOT"

# Load secrets
if [ -f ".env.secrets" ]; then
    source .env.secrets 2>/dev/null
fi

# Default instance
DEFAULT_INSTANCE="usa"

# Helper: Get compose file for instance
get_compose() {
    case "$1" in
        usa) echo "docker-compose.yml" ;;
        fra) echo "instances/fra/docker-compose.yml" ;;
        deu) echo "instances/deu/docker-compose.yml" ;;
        *) echo "" ;;
    esac
}

# Helper: Get URL for instance
get_url() {
    case "$1" in
        usa) echo "https://usa-app.dive25.com" ;;
        fra) echo "https://fra-app.dive25.com" ;;
        deu) echo "https://deu-app.dive25.com" ;;
        *) echo "" ;;
    esac
}

# Helper: Get IdP URL for instance
get_idp() {
    case "$1" in
        usa) echo "https://usa-idp.dive25.com" ;;
        fra) echo "https://fra-idp.dive25.com" ;;
        deu) echo "https://deu-idp.dive25.com" ;;
        *) echo "" ;;
    esac
}

# Command: up - Start instance(s)
cmd_up() {
    local instance="${1:-$DEFAULT_INSTANCE}"
    
    if [ "$instance" = "all" ]; then
        echo -e "${CYAN}Starting ALL instances...${NC}"
        for inst in usa fra deu; do
            echo -e "\n${YELLOW}Starting $inst...${NC}"
            docker compose -f "$(get_compose $inst)" up -d
        done
    else
        local compose=$(get_compose "$instance")
        if [ -z "$compose" ]; then
            echo -e "${RED}Unknown instance: $instance${NC}"
            echo "Available: usa, fra, deu, all"
            exit 1
        fi
        echo -e "${CYAN}Starting ${instance^^} instance...${NC}"
        docker compose -f "$compose" up -d
        echo -e "\n${GREEN}✓ ${instance^^} is starting${NC}"
        echo -e "  Frontend: $(get_url $instance)"
        echo -e "  Keycloak: $(get_idp $instance)"
    fi
}

# Command: down - Stop instance(s)
cmd_down() {
    local instance="${1:-$DEFAULT_INSTANCE}"
    
    if [ "$instance" = "all" ]; then
        echo -e "${CYAN}Stopping ALL instances...${NC}"
        for inst in usa fra deu; do
            echo -e "${YELLOW}Stopping $inst...${NC}"
            docker compose -f "$(get_compose $inst)" down 2>/dev/null || true
        done
    else
        local compose=$(get_compose "$instance")
        echo -e "${CYAN}Stopping ${instance^^}...${NC}"
        docker compose -f "$compose" down
    fi
    echo -e "${GREEN}✓ Done${NC}"
}

# Command: restart - Restart instance
cmd_restart() {
    local instance="${1:-$DEFAULT_INSTANCE}"
    cmd_down "$instance"
    sleep 2
    cmd_up "$instance"
}

# Command: logs - View logs
cmd_logs() {
    local instance="${1:-$DEFAULT_INSTANCE}"
    local service="${2:-}"
    local compose=$(get_compose "$instance")
    
    if [ -n "$service" ]; then
        docker compose -f "$compose" logs -f "$service"
    else
        docker compose -f "$compose" logs -f
    fi
}

# Command: status - Show all instance status
cmd_status() {
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║              DIVE V3 Instance Status                          ║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════════╣${NC}"
    
    for instance in usa fra deu; do
        local url=$(get_url "$instance")
        local status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "$url" 2>/dev/null || echo "000")
        
        if [ "$status" = "200" ] || [ "$status" = "302" ]; then
            echo -e "${CYAN}║${NC}  ${GREEN}●${NC} ${instance^^}  ${GREEN}ONLINE${NC}   $url"
        else
            echo -e "${CYAN}║${NC}  ${RED}○${NC} ${instance^^}  ${RED}OFFLINE${NC}  $url"
        fi
    done
    
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    
    echo -e "\n${YELLOW}Container Status:${NC}"
    docker ps --filter "name=dive-v3" --format "table {{.Names}}\t{{.Status}}" 2>/dev/null | head -20
}

# Command: terraform - Apply Terraform to instance
cmd_terraform() {
    local instance="${1:-$DEFAULT_INSTANCE}"
    local action="${2:-apply}"
    
    echo -e "${CYAN}Running Terraform ${action} for ${instance^^}...${NC}"
    
    cd "$DIVE_ROOT/terraform/instances"
    
    # Select workspace
    terraform workspace select "$instance" 2>/dev/null || terraform workspace new "$instance"
    
    # Run Terraform
    case "$action" in
        plan)
            terraform plan -var-file="${instance}.tfvars"
            ;;
        apply)
            terraform apply -var-file="${instance}.tfvars" -auto-approve
            ;;
        destroy)
            terraform destroy -var-file="${instance}.tfvars" -auto-approve
            ;;
        *)
            echo -e "${RED}Unknown Terraform action: $action${NC}"
            exit 1
            ;;
    esac
}

# Command: open - Open instance in browser
cmd_open() {
    local instance="${1:-$DEFAULT_INSTANCE}"
    local target="${2:-app}"
    
    case "$target" in
        app)
            open "$(get_url $instance)"
            ;;
        idp|keycloak)
            open "$(get_idp $instance)/admin"
            ;;
        *)
            echo -e "${RED}Unknown target: $target${NC}"
            exit 1
            ;;
    esac
}

# Command: creds - Show credentials
cmd_creds() {
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║              DIVE V3 Credentials Quick Reference              ║${NC}"
    echo -e "${CYAN}╠═══════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}Admin Credentials (all instances):${NC}"
    echo -e "${CYAN}║${NC}    Username: ${GREEN}admin${NC}"
    echo -e "${CYAN}║${NC}    Password: ${GREEN}DivePilot2025!${NC}"
    echo -e "${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}Test Users (NUMERIC - easy to remember):${NC}"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-1${NC}  →  UNCLASSIFIED"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-2${NC}  →  CONFIDENTIAL"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-3${NC}  →  SECRET"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-4${NC}  →  TOP_SECRET"
    echo -e "${CYAN}║${NC}    Password: ${GREEN}Password123!${NC}"
    echo -e "${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}  ${YELLOW}Test Users (NAMED - self-documenting):${NC}"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-unclass${NC}       →  UNCLASSIFIED"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-confidential${NC}  →  CONFIDENTIAL"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-secret${NC}        →  SECRET"
    echo -e "${CYAN}║${NC}    ${GREEN}testuser-{usa|fra|deu}-ts${NC}            →  TOP_SECRET"
    echo -e "${CYAN}║${NC}    Password: ${GREEN}Password123!${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
}

# Command: demo - Quick demo setup
cmd_demo() {
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║              DIVE V3 Demo Quick Start                         ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════╝${NC}"
    
    echo -e "\n${YELLOW}Step 1: Starting all instances...${NC}"
    cmd_up all
    
    echo -e "\n${YELLOW}Step 2: Waiting for services to be ready (30s)...${NC}"
    sleep 30
    
    echo -e "\n${YELLOW}Step 3: Warming up instances...${NC}"
    ./scripts/demo/warm-up-instances.sh 2>/dev/null || true
    
    echo -e "\n${GREEN}✓ Demo environment ready!${NC}"
    cmd_creds
    cmd_status
}

# Command: help
cmd_help() {
    echo -e "${CYAN}DIVE V3 Instance Manager${NC}"
    echo ""
    echo "Usage: ./scripts/dive [command] [instance] [options]"
    echo ""
    echo "Commands:"
    echo "  up [instance]       Start instance (usa|fra|deu|all)"
    echo "  down [instance]     Stop instance"
    echo "  restart [instance]  Restart instance"
    echo "  logs [instance]     View logs (follow mode)"
    echo "  status              Show all instance status"
    echo "  terraform <inst>    Run Terraform (plan|apply|destroy)"
    echo "  open <inst> [type]  Open in browser (app|idp)"
    echo "  creds               Show credentials"
    echo "  demo                Full demo setup (all instances)"
    echo ""
    echo "Examples:"
    echo "  ./scripts/dive up              # Start USA"
    echo "  ./scripts/dive up all          # Start everything"
    echo "  ./scripts/dive terraform usa   # Apply Terraform"
    echo "  ./scripts/dive open usa idp    # Open Keycloak admin"
}

# Main
case "${1:-help}" in
    up)        cmd_up "${2:-}" ;;
    down)      cmd_down "${2:-}" ;;
    restart)   cmd_restart "${2:-}" ;;
    logs)      cmd_logs "${2:-}" "${3:-}" ;;
    status)    cmd_status ;;
    terraform) cmd_terraform "${2:-}" "${3:-apply}" ;;
    tf)        cmd_terraform "${2:-}" "${3:-apply}" ;;
    open)      cmd_open "${2:-}" "${3:-app}" ;;
    creds)     cmd_creds ;;
    demo)      cmd_demo ;;
    help|--help|-h) cmd_help ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        cmd_help
        exit 1
        ;;
esac
