# ==============================================================================
# DIVE V3 - Automated Secret Rotation
# ==============================================================================
# This workflow runs quarterly to rotate all secrets in GCP Secret Manager.
# It can also be triggered manually for emergency rotations.
#
# Schedule: First Monday of January, April, July, October at 02:00 UTC
# ==============================================================================

name: Secret Rotation

on:
  schedule:
    # Quarterly: First Monday of Jan, Apr, Jul, Oct at 02:00 UTC
    - cron: '0 2 1-7 1,4,7,10 1'
  workflow_dispatch:
    inputs:
      instance:
        description: 'Instance to rotate (all/usa/fra/gbr/deu)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - usa
          - fra
          - gbr
          - deu
      secret_type:
        description: 'Secret type to rotate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - keycloak
          - postgres
          - mongodb
          - auth
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        type: boolean
        default: true
      reason:
        description: 'Reason for rotation'
        required: false
        type: string
        default: 'Scheduled quarterly rotation'

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: dive25

jobs:
  rotate-secrets:
    name: Rotate Secrets
    runs-on: ubuntu-latest
    environment: secret-rotation
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Setup GCloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      
      - name: Display Rotation Plan
        run: |
          echo "## üîê Secret Rotation Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Instance | ${{ inputs.instance || 'all' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Type | ${{ inputs.secret_type || 'all' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run || 'true' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reason | ${{ inputs.reason || 'Scheduled quarterly rotation' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Run Secret Rotation
        run: |
          chmod +x scripts/rotate-secrets.sh
          
          ARGS="--instance ${{ inputs.instance || 'all' }}"
          ARGS="$ARGS --type ${{ inputs.secret_type || 'all' }}"
          
          if [ "${{ inputs.dry_run }}" == "true" ] || [ -z "${{ inputs.dry_run }}" ]; then
            ARGS="$ARGS --dry-run"
          fi
          
          ARGS="$ARGS --force --verbose"
          
          ./scripts/rotate-secrets.sh $ARGS
      
      - name: Upload Audit Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotation-audit-log
          path: logs/secrets/rotation-audit.log
          retention-days: 90
          if-no-files-found: ignore
      
      - name: Create Rotation Summary
        if: ${{ inputs.dry_run != 'true' }}
        run: |
          echo "## ‚úÖ Secret Rotation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify all services are healthy" >> $GITHUB_STEP_SUMMARY
          echo "2. Run health check: \`./scripts/health-check-all.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Test authentication flows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Scheduled Rotation:**" >> $GITHUB_STEP_SUMMARY
          echo "- Date: First Monday of next quarter" >> $GITHUB_STEP_SUMMARY

  verify-health:
    name: Verify Service Health
    runs-on: ubuntu-latest
    needs: rotate-secrets
    if: ${{ inputs.dry_run != 'true' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run Health Checks
        run: |
          chmod +x scripts/health-check-all.sh
          ./scripts/health-check-all.sh --instance ${{ inputs.instance || 'all' }} || {
            echo "## ‚ö†Ô∏è Health Check Warnings" >> $GITHUB_STEP_SUMMARY
            echo "Some services may need attention. Review the logs above." >> $GITHUB_STEP_SUMMARY
          }

  notify-rotation:
    name: Notification
    runs-on: ubuntu-latest
    needs: [rotate-secrets, verify-health]
    if: always()
    
    steps:
      - name: Set Status
        id: status
        run: |
          if [ "${{ needs.rotate-secrets.result }}" == "success" ]; then
            if [ "${{ needs.verify-health.result }}" == "success" ] || [ "${{ needs.verify-health.result }}" == "skipped" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message=‚úÖ Secret rotation completed successfully" >> $GITHUB_OUTPUT
            else
              echo "status=warning" >> $GITHUB_OUTPUT
              echo "message=‚ö†Ô∏è Secret rotation completed but health check has warnings" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=‚ùå Secret rotation failed" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Issue on Failure
        if: steps.status.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîê Secret Rotation Failed',
              body: `## Secret Rotation Failure Report\n\n**Timestamp:** ${new Date().toUTCString()}\n**Instance:** ${{ inputs.instance || 'all' }}\n**Type:** ${{ inputs.secret_type || 'all' }}\n**Reason:** ${{ inputs.reason || 'Scheduled quarterly rotation' }}\n\n### Action Required\n1. Review [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n2. Manually rotate secrets if needed\n3. Verify service health\n\n_Auto-generated by GitHub Actions_`,
              labels: ['security', 'secret-rotation', 'priority:high']
            });








