name: E2E - Classification Equivalency Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - 'policies/fuel_inventory_abac_policy.rego'
      - 'policies/tests/*equivalency*.rego'
      - '.github/workflows/e2e-classification.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'policies/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  e2e-classification-equivalency:
    name: üåç Classification Equivalency E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: TypeScript Type Check
        run: |
          cd frontend
          npm run typecheck
      
      - name: Install Playwright Browsers
        run: |
          cd frontend
          npx playwright install --with-deps chromium
      
      - name: Verify Playwright Installation
        run: |
          cd frontend
          npx playwright --version
      
      - name: Run E2E Classification Equivalency Tests
        run: |
          cd frontend
          npm run test:e2e
        env:
          CI: true
          BASE_URL: http://localhost:3000
          BACKEND_API_URL: http://localhost:4000
          # Test mode configuration (uses mock JWT)
          NODE_ENV: test
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-ci
      
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-classification
          path: frontend/playwright-report/
          retention-days: 30
      
      - name: Upload Test Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-classification
          path: frontend/test-results/
          retention-days: 7
      
      - name: Upload Test Videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-videos-classification
          path: frontend/test-results/**/*.webm
          retention-days: 7
      
      - name: Test Results Summary
        if: always()
        run: |
          echo "========================================"
          echo "  E2E Classification Equivalency Tests  "
          echo "========================================"
          echo ""
          if [ -f frontend/playwright-report/results.json ]; then
            echo "Test results:"
            cat frontend/playwright-report/results.json | head -30
          else
            echo "No test results JSON found"
          fi
          echo ""
          echo "========================================"
          echo ""
          echo "Test scenarios covered:"
          echo "  ‚úÖ German user uploads GEHEIM document"
          echo "  ‚úÖ French user accesses German document (equivalency)"
          echo "  ‚úÖ US CONFIDENTIAL user denied for French SECRET D√âFENSE"
          echo "  ‚úÖ Canadian user views 12√ó4 equivalency matrix"
          echo "  ‚úÖ Multi-nation document sharing workflow"
          echo ""
          echo "ACP-240 Section 4.3 E2E Validation: Complete"
          echo "========================================"

