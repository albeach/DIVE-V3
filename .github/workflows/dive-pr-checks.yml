# =============================================================================
# DIVE V3 - PR Validation Workflow
# =============================================================================
# Runs fast checks on pull requests to validate code quality.
# Target: < 5 minutes total execution time
#
# Checks:
# - ShellCheck for bash scripts
# - Terraform validate/format
# - Docker Compose validation
# - Backend/Frontend unit tests
# - OPA policy tests
# - Deploy dry-run validation
# =============================================================================

name: DIVE PR Checks (Manual)

on:
  workflow_dispatch:

concurrency:
  group: dive-pr-checks-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DIVE_ENV: local

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 1: Linting (Parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  lint-shell:
    name: ShellCheck
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed shell scripts
        id: changed-shell
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            mapfile -t changed_files < <(git diff --name-only "$BASE_SHA...$HEAD_SHA" -- scripts/)
          else
            mapfile -t changed_files < <(git diff --name-only HEAD~1 HEAD -- scripts/ || true)
          fi

          shell_files=()
          for file in "${changed_files[@]}"; do
            [[ -f "$file" ]] || continue
            if [[ "$file" == *.sh ]] || head -n 1 "$file" | grep -qE '^#!.*(ba|z|k)?sh'; then
              shell_files+=("$file")
            fi
          done

          if [ "${#shell_files[@]}" -eq 0 ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          file_list="/tmp/changed-shell-files.txt"
          printf '%s\n' "${shell_files[@]}" > "$file_list"

          echo "has_files=true" >> "$GITHUB_OUTPUT"
          echo "file_list=$file_list" >> "$GITHUB_OUTPUT"

      - name: Run ShellCheck on changed scripts
        if: steps.changed-shell.outputs.has_files == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v shellcheck >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y shellcheck
          fi
          xargs -r shellcheck -S warning < "${{ steps.changed-shell.outputs.file_list }}"

      - name: Skip ShellCheck
        if: steps.changed-shell.outputs.has_files != 'true'
        run: echo "No changed shell scripts to lint."

  lint-terraform:
    name: Terraform Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      - name: Terraform Validate (Pilot)
        run: |
          cd terraform/pilot
          terraform init -backend=false
          terraform validate

      - name: Terraform Validate (Spoke)
        run: |
          cd terraform/spoke
          terraform init -backend=false
          terraform validate

      - name: Terraform Validate (Hub)
        run: |
          cd terraform/hub
          terraform init -backend=false
          terraform validate

  lint-compose:
    name: Docker Compose Validate
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4

      - name: Prepare env for compose validation
        run: |
          rm -f .env
          cp .env.example .env
          cp .env .env.hub
          cat >> .env <<'EOF'
          POSTGRES_PASSWORD=test
          POSTGRES_PASSWORD_USA=test
          MONGO_PASSWORD=test
          MONGO_PASSWORD_USA=test
          REDIS_PASSWORD_BLACKLIST=test
          REDIS_PASSWORD_SPOKE=test
          REDIS_PASSWORD_USA=test
          KEYCLOAK_ADMIN_PASSWORD=test
          KEYCLOAK_ADMIN_PASSWORD_SPOKE=test
          KEYCLOAK_CLIENT_SECRET=test
          KEYCLOAK_CLIENT_SECRET_SPOKE=test
          KEYCLOAK_CLIENT_SECRET_USA=test
          AUTH_SECRET=testsecret123456789012
          NEXTAUTH_SECRET_SPOKE=testsecret123456789012
          POSTGRES_PASSWORD_SPOKE=test
          MONGO_PASSWORD_SPOKE=test
          EOF

      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config --quiet

      - name: Validate docker-compose.hub.yml
        run: docker compose -f docker-compose.hub.yml config --quiet

      - name: Validate docker-compose.pilot.yml
        run: docker compose -f docker-compose.pilot.yml config --quiet

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 2: Unit Tests (Parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  test-backend-unit:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint-shell, lint-terraform, lint-compose]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Dependencies
        run: cd backend && npm ci

      - name: Run Unit Tests
        id: backend_unit_tests
        run: cd backend && npm run test:unit -- --passWithNoTests
        env:
          NODE_ENV: test

      - name: Report Backend Unit Test Outcome
        if: always()
        run: |
          if [ "${{ steps.backend_unit_tests.outcome }}" = "success" ]; then
            echo "âœ… Backend unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backend unit tests failed." >> $GITHUB_STEP_SUMMARY
          fi

  test-frontend-unit:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint-shell, lint-terraform, lint-compose]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: cd frontend && npm ci

      - name: Run Unit Tests
        id: frontend_unit_tests
        run: cd frontend && npm test -- --passWithNoTests --maxWorkers=50%
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Report Frontend Unit Test Outcome
        if: always()
        run: |
          if [ "${{ steps.frontend_unit_tests.outcome }}" = "success" ]; then
            echo "âœ… Frontend unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Frontend unit tests failed." >> $GITHUB_STEP_SUMMARY
          fi

  test-opa:
    name: OPA Policy Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint-shell, lint-terraform, lint-compose]
    steps:
      - uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 1.12.3

      - name: Run OPA Tests
        run: |
          cd policies
          opa test . -v --coverage --format=json > opa-coverage.json || rm -f opa-coverage.json
          opa test . -v --ignore='opa-coverage.json'

      - name: Check OPA Coverage
        run: |
          if [ -f policies/opa-coverage.json ]; then
            coverage=$(cat policies/opa-coverage.json | jq -r '.coverage // 0')
            echo "OPA Policy Coverage: ${coverage}%"
          fi
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 3: Deploy Validation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  test-deploy-dry-run:
    name: Deploy Dry Run
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test-backend-unit, test-frontend-unit, test-opa]
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Dry Run
        run: ./dive deploy --dry-run
        env:
          DRY_RUN: "true"
          POSTGRES_PASSWORD: test-password
          KEYCLOAK_ADMIN_PASSWORD: test-password
          MONGO_PASSWORD: test-password
          AUTH_SECRET: test-secret-value-for-ci
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          REDIS_PASSWORD: test-password

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Stage 4: Docker Phase Tests (Optional - for comprehensive checks)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  test-docker-phases:
    name: Docker Phase Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-deploy-dry-run]
    steps:
      - uses: actions/checkout@v4

      - name: Run Phase 0 Tests (Baseline)
        run: |
          chmod +x tests/docker/phase0-baseline-tests.sh
          ./tests/docker/phase0-baseline-tests.sh --skip-lifecycle || true
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint-shell, lint-terraform, lint-compose, test-backend-unit, test-frontend-unit, test-opa, test-deploy-dry-run]
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸš€ DIVE V3 PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.lint-shell.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.lint-terraform.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Compose | ${{ needs.lint-compose.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.test-backend-unit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.test-frontend-unit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OPA Tests | ${{ needs.test-opa.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Dry-Run | ${{ needs.test-deploy-dry-run.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall result
          if [[ "${{ needs.lint-shell.result }}" == "success" && \
                "${{ needs.lint-terraform.result }}" == "success" && \
                "${{ needs.lint-compose.result }}" == "success" && \
                "${{ needs.test-backend-unit.result }}" == "success" && \
                "${{ needs.test-frontend-unit.result }}" == "success" && \
                "${{ needs.test-opa.result }}" == "success" && \
                "${{ needs.test-deploy-dry-run.result }}" == "success" ]]; then
            echo "### âœ… All checks passed! Ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some checks failed. Please review the details above." >> $GITHUB_STEP_SUMMARY
          fi
