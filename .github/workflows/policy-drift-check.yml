name: Policy Drift Detection

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      alert_on_drift:
        description: 'Create or update a GitHub issue when drift is detected'
        required: false
        default: true
        type: boolean
      update_baseline:
        description: 'Generate a baseline update artifact (no automatic commit)'
        required: false
        default: false
        type: boolean
      reason:
        description: 'Execution reason'
        required: false
        default: 'Scheduled drift check'
        type: string

permissions:
  contents: read

concurrency:
  group: policy-drift-${{ github.ref }}
  cancel-in-progress: true

env:
  OPA_VERSION: '1.12.3'
  NODE_VERSION: '20'

jobs:
  capture-state:
    name: Capture Policy State
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      has_drift: ${{ steps.drift.outputs.has_drift }}
      drift_summary: ${{ steps.drift.outputs.drift_summary }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Install drift dependencies
        run: |
          npm install --no-save typescript ts-node axios glob

      - name: Capture source policy state
        id: source
        run: |
          set -euo pipefail

          POLICY_COUNT=$(find policies -name '*.rego' -type f | wc -l | tr -d ' ')
          find policies -name '*.rego' -type f -exec sha256sum {} \; | sort > source-checksums.txt
          OVERALL_HASH=$(sha256sum source-checksums.txt | awk '{print $1}')
          POLICY_COMMIT=$(git log -1 --format='%H' -- policies/)

          echo "policy_count=${POLICY_COUNT}" >> "$GITHUB_OUTPUT"
          echo "overall_hash=${OVERALL_HASH}" >> "$GITHUB_OUTPUT"
          echo "policy_commit=${POLICY_COMMIT}" >> "$GITHUB_OUTPUT"

      - name: Build tenant bundles
        run: npx ts-node --esm scripts/policy/build-tenant-bundle.ts build --all

      - name: Run policy tests
        run: opa test policies/ -v --coverage --format=json > test-results.json

      - name: Evaluate drift
        id: drift
        run: |
          set -euo pipefail

          HAS_DRIFT=false
          DRIFT_SUMMARY=''

          if [ -f 'policies/baselines/policy-baseline.json' ]; then
            STORED_HASH=$(jq -r '.source.hash // ""' policies/baselines/policy-baseline.json)
            CURRENT_HASH='${{ steps.source.outputs.overall_hash }}'

            if [ -n "$STORED_HASH" ] && [ "$STORED_HASH" != "$CURRENT_HASH" ]; then
              HAS_DRIFT=true
              DRIFT_SUMMARY="Policy hash changed from ${STORED_HASH:0:12} to ${CURRENT_HASH:0:12}"
            else
              DRIFT_SUMMARY='No drift detected against baseline hash'
            fi
          else
            HAS_DRIFT=true
            DRIFT_SUMMARY='No baseline file exists; baseline initialization required'
          fi

          cat > drift-report.json <<REPORT
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "source": {
              "commit": "${{ steps.source.outputs.policy_commit }}",
              "hash": "${{ steps.source.outputs.overall_hash }}",
              "policy_count": ${{ steps.source.outputs.policy_count }}
            },
            "drift": {
              "has_drift": ${HAS_DRIFT},
              "summary": "${DRIFT_SUMMARY}"
            },
            "reason": "${{ inputs.reason || 'Scheduled drift check' }}"
          }
          REPORT

          echo "has_drift=${HAS_DRIFT}" >> "$GITHUB_OUTPUT"
          echo "drift_summary=${DRIFT_SUMMARY}" >> "$GITHUB_OUTPUT"

      - name: Upload drift artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: policy-drift-${{ github.run_number }}
          path: |
            drift-report.json
            source-checksums.txt
            test-results.json
          retention-days: 30

  alert:
    name: Alert on Drift
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: capture-state
    if: needs.capture-state.outputs.has_drift == 'true' && (github.event_name == 'schedule' || inputs.alert_on_drift == true)
    permissions:
      contents: read
      issues: write
    steps:
      - name: Download drift report
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: policy-drift-${{ github.run_number }}

      - name: Create or update drift issue
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('drift-report.json', 'utf8'));
            const title = `Policy Drift Detected - ${new Date().toISOString().slice(0, 10)}`;
            const body = [
              '## Policy Drift Detection Alert',
              '',
              `**Timestamp:** ${report.timestamp}`,
              `**Summary:** ${report.drift.summary}`,
              `**Commit:** \\`${report.source.commit}\\``,
              `**Hash:** \\`${report.source.hash}\\``,
              '',
              '### Required Actions',
              '1. Review policy changes since last baseline.',
              '2. Verify deployed OPA/OPAL state.',
              '3. Run `npm run test:policy` and resolve drift cause.'
            ].join('\\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'policy-drift'
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['policy-drift', 'security', 'automation']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body
              });
            }

  baseline-candidate:
    name: Baseline Candidate Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: capture-state
    if: github.event_name == 'workflow_dispatch' && inputs.update_baseline == true
    steps:
      - name: Download drift report
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: policy-drift-${{ github.run_number }}

      - name: Create baseline candidate
        run: |
          mkdir -p baseline-candidate
          cp drift-report.json baseline-candidate/policy-baseline.json
          jq '.status = "baseline-candidate" | .generated_at = now' baseline-candidate/policy-baseline.json > baseline-candidate/tmp.json
          mv baseline-candidate/tmp.json baseline-candidate/policy-baseline.json

      - name: Upload baseline candidate
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: policy-baseline-candidate-${{ github.run_number }}
          path: baseline-candidate/policy-baseline.json
          retention-days: 30

      - name: Summary
        run: |
          echo "## Baseline Candidate Generated" >> "$GITHUB_STEP_SUMMARY"
          echo "A candidate baseline artifact was generated for manual review and commit." >> "$GITHUB_STEP_SUMMARY"
