name: Specialty Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  federation-tests:
    name: Federation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      contains(github.event.head_commit.message, 'federation') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install Dependencies
        run: cd backend && npm ci
      
      - name: Run Federation Tests
        run: |
          cd backend
          npm test -- --testPathPattern=federation --testTimeout=30000
        env:
          NODE_ENV: test
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: OWASP Security Tests
        run: |
          cd backend
          npm test -- --testPathPattern=security --testTimeout=30000 || true
        env:
          NODE_ENV: test
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test

  keycloak-tests:
    name: Keycloak Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: |
      contains(github.event.head_commit.message, 'keycloak') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Start Keycloak with Docker Compose
        run: |
          # Create minimal docker-compose for Keycloak testing
          cat > docker-compose.keycloak-test.yml <<EOF
          version: '3.8'
          services:
            postgres:
              image: postgres:15-alpine
              environment:
                POSTGRES_DB: keycloak
                POSTGRES_USER: keycloak
                POSTGRES_PASSWORD: password
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U keycloak"]
                interval: 10s
                timeout: 5s
                retries: 5
            
            keycloak:
              image: quay.io/keycloak/keycloak:26.1.4
              environment:
                KC_DB: postgres
                KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
                KC_DB_USERNAME: keycloak
                KC_DB_PASSWORD: password
                KEYCLOAK_ADMIN: admin
                KEYCLOAK_ADMIN_PASSWORD: admin
              command: start-dev
              ports:
                - "8080:8080"
              depends_on:
                postgres:
                  condition: service_healthy
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 30
                start_period: 60s
          EOF
          
          docker compose -f docker-compose.keycloak-test.yml up -d
          
          # Wait for Keycloak to be ready
          echo "Waiting for Keycloak to start..."
          timeout 120 bash -c 'until curl -f http://localhost:8080/health/ready; do sleep 5; done'
          echo "âœ… Keycloak is ready"
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.4
      
      - name: Apply Terraform Configuration
        run: |
          cd terraform
          terraform init -backend=false
          terraform apply -auto-approve
        env:
          KEYCLOAK_URL: http://localhost:8080
          KEYCLOAK_ADMIN_USERNAME: admin
          KEYCLOAK_ADMIN_PASSWORD: admin
      
      - name: Validate Realms Created
        run: |
          # Check that dive-v3-broker realm exists
          curl -f http://localhost:8080/realms/dive-v3-broker/.well-known/openid-configuration
          
          # Check USA realm
          curl -f http://localhost:8080/realms/dive-v3-usa/.well-known/openid-configuration
          
          # Check France realm
          curl -f http://localhost:8080/realms/dive-v3-fra/.well-known/openid-configuration
          
          echo "âœ… All realms validated"
      
      - name: Test Authentication Flows
        run: |
          cd backend
          npm ci
          npm test -- --testPathPattern=keycloak --testTimeout=30000 || true
        env:
          NODE_ENV: test
          KEYCLOAK_URL: http://localhost:8080
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.keycloak-test.yml down -v

  policies-lab-tests:
    name: Policies Lab Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      contains(github.event.head_commit.message, 'policies-lab') ||
      contains(github.event.head_commit.message, 'xacml') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install Dependencies
        run: cd backend && npm ci
      
      - name: Start OPA Server
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          chmod +x opa
          nohup ./opa run --server --addr=:8181 --log-level=error > opa.log 2>&1 &
          sleep 5
          curl -f http://localhost:8181/health || (cat opa.log && exit 1)
      
      - name: Run Policies Lab Tests
        run: |
          cd backend
          npm test -- --testPathPattern="policies-lab|xacml" --testTimeout=30000 || true
        env:
          NODE_ENV: test
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          OPA_URL: http://localhost:8181
      
      - name: Validate XACML Adapter
        run: |
          cd backend
          # Test XACML to OPA conversion if exists
          npm test -- --testPathPattern=xacml --testTimeout=15000 || echo "No XACML tests found"
        env:
          NODE_ENV: test

  spain-saml-tests:
    name: Spain SAML Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      contains(github.event.head_commit.message, 'spain') ||
      contains(github.event.head_commit.message, 'saml') ||
      contains(github.event.head_commit.message, 'esp') ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install Dependencies
        run: cd backend && npm ci
      
      - name: Start SimpleSAMLphp (Mock Spain IdP)
        run: |
          # Using kristophjunge/test-saml-idp which is actively maintained
          docker run -d \
            --name simplesamlphp \
            -p 8088:8080 \
            -p 8443:8443 \
            -e SIMPLESAMLPHP_SP_ENTITY_ID=dive-v3-spain \
            -e SIMPLESAMLPHP_SP_ASSERTION_CONSUMER_SERVICE=http://localhost:3000/api/auth/callback/spain \
            kristophjunge/test-saml-idp:latest
          
          # Wait for SimpleSAMLphp to start
          echo "Waiting for SimpleSAMLphp to start..."
          timeout 60 bash -c 'until curl -f http://localhost:8088/simplesaml 2>/dev/null; do echo "Waiting..."; sleep 5; done' || echo "âš ï¸ SimpleSAMLphp may not be fully ready but continuing..."
          echo "âœ… SimpleSAMLphp started"
      
      - name: Validate SAML Metadata
        run: |
          # Download SP metadata
          curl -f http://localhost:8088/simplesaml/module.php/saml/sp/metadata.php/default-sp || true
          echo "âœ… SAML metadata accessible"
      
      - name: Test Spanish Clearance Normalization
        run: |
          cd backend
          # Test Spanish clearance mapping: RESERVADO â†’ CONFIDENTIAL, SECRETO â†’ SECRET
          npm test -- --testPathPattern=spanish --testTimeout=15000 || true
        env:
          NODE_ENV: test
      
      - name: Cleanup
        if: always()
        run: docker stop simplesamlphp && docker rm simplesamlphp || true

  specialty-summary:
    name: Specialty Tests Summary
    runs-on: ubuntu-latest
    needs: [federation-tests, keycloak-tests, policies-lab-tests, spain-saml-tests]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”¬ Specialty Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Federation | ${{ needs.federation-tests.result == 'success' && 'âœ… Pass' || needs.federation-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Keycloak Integration | ${{ needs.keycloak-tests.result == 'success' && 'âœ… Pass' || needs.keycloak-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Policies Lab | ${{ needs.policies-lab-tests.result == 'success' && 'âœ… Pass' || needs.policies-lab-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spain SAML | ${{ needs.spain-saml-tests.result == 'success' && 'âœ… Pass' || needs.spain-saml-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Some tests may be skipped based on path filters and commit messages_" >> $GITHUB_STEP_SUMMARY

