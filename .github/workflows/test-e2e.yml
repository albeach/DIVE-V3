name: E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/test-e2e.yml'
      - '.github/actions/e2e-setup/**'

# Common env vars shared by all test runner steps
env:
  NEXTAUTH_URL: https://localhost:3000
  DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
  KEYCLOAK_URL: https://localhost:8443
  KEYCLOAK_REALM: dive-v3-broker-usa
  KEYCLOAK_CLIENT_ID: dive-v3-broker-usa
  KEYCLOAK_CLIENT_SECRET: test-client-secret
  KEYCLOAK_INSECURE_SKIP_VERIFY: "true"
  MONGODB_URL: mongodb://localhost:27017/dive-v3-test
  BASE_URL: https://localhost:3000

jobs:
  e2e-authentication:
    name: E2E - Authentication Flows
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-authentication-flows-2025
          keycloak-users: >-
            [
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":["FVEY","NATO"]},
              {"username":"testuser-secret","password":"Secret123!","clearance":"SECRET","coi":["FVEY"]},
              {"username":"testuser-unclass","password":"Unclass123!","clearance":"UNCLASSIFIED","coi":[]},
              {"username":"testuser-us","password":"password","clearance":"SECRET","coi":["FVEY"]}
            ]

      - name: Run Authentication E2E Tests
        run: >-
          cd frontend && npx playwright test
          src/__tests__/e2e/mfa-complete-flow.spec.ts
          src/__tests__/e2e/mfa-conditional.spec.ts
          src/__tests__/e2e/external-idp-federation-flow.spec.ts
          src/__tests__/e2e/session-lifecycle.spec.ts
          src/__tests__/e2e/webauthn-aal3-flow.spec.ts
          src/__tests__/e2e/comprehensive-frontend.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-authentication-flows-2025
          CI: true
          GITHUB_ACTIONS: ""
          BACKEND_API_URL: http://localhost:4000

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-authentication-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-authorization:
    name: E2E - Authorization Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-authorization-2025
          start-opa: 'true'
          keycloak-users: >-
            [
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":["FVEY"]},
              {"username":"testuser-us","password":"password","clearance":"SECRET","coi":["FVEY"]}
            ]

      - name: Run Authorization E2E Tests
        run: >-
          cd frontend && npx playwright test
          src/__tests__/e2e/identity-drawer.spec.ts
          src/__tests__/e2e/coi-comprehensive.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-authorization-2025
          OPA_URL: https://localhost:8181
          CI: true
          GITHUB_ACTIONS: ""

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-authorization-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-classification-equivalency:
    name: E2E - Classification Equivalency
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-classification-2025
          keycloak-users: >-
            [
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":["FVEY"]},
              {"username":"testuser-us","password":"password","clearance":"SECRET","coi":["FVEY"]}
            ]

      - name: Run Classification Equivalency E2E Tests
        run: >-
          cd frontend && npx playwright test
          src/__tests__/e2e/classification-equivalency.spec.ts
          src/__tests__/e2e/integration-federation-vs-object.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-classification-2025
          CI: true
          GITHUB_ACTIONS: ""

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-classification-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-resource-management:
    name: E2E - Resource Management
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-resource-2025
          start-opa: 'true'
          keycloak-users: >-
            [
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":["FVEY"]},
              {"username":"testuser-us","password":"password","clearance":"SECRET","coi":["FVEY"]}
            ]

      - name: Run Resource Management E2E Tests
        run: >-
          cd frontend && npx playwright test
          src/__tests__/e2e/policies-lab.spec.ts
          src/__tests__/e2e/nato-expansion.spec.ts
          src/__tests__/e2e/idp-management-revamp.spec.ts
          tests/e2e/sp-registry.spec.ts
          src/__tests__/e2e/kas-integration-flow.spec.ts
          src/__tests__/e2e/upload-flow-modern.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-resource-2025
          OPA_URL: https://localhost:8181
          CI: true
          GITHUB_ACTIONS: ""

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-resource-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-admin:
    name: E2E - Admin Pages
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-admin-2025
          keycloak-users: >-
            [
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":[]},
              {"username":"testuser-unclass","password":"Unclass123!","clearance":"UNCLASSIFIED","coi":[]}
            ]

      - name: Run Admin E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/admin/
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-admin-2025
          CI: true
          GITHUB_ACTIONS: ""

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-admin-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-user-journeys:
    name: E2E - User Journeys
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-journeys-2025
          keycloak-users: >-
            [
              {"username":"testuser-usa-1","password":"TestUser2025!Pilot","clearance":"UNCLASSIFIED","coi":[]},
              {"username":"testuser-usa-3","password":"TestUser2025!Pilot","clearance":"SECRET","coi":[]},
              {"username":"testuser-usa-4","password":"TestUser2025!Pilot","clearance":"TOP_SECRET","coi":[]},
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":[]}
            ]

      - name: Run User Journey E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/journeys/
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-journeys-2025
          CI: true
          GITHUB_ACTIONS: ""

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-journey-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-quality:
    name: E2E - Quality & Accessibility
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s --health-timeout 5s --health-retries 5
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: E2E Setup
        uses: ./.github/actions/e2e-setup
        with:
          nextauth-secret: test-secret-for-e2e-quality-2025
          keycloak-users: >-
            [
              {"username":"testuser-unclass","password":"Unclass123!","clearance":"UNCLASSIFIED","coi":[]},
              {"username":"admin-dive","password":"Admin123!","clearance":"TOP_SECRET","coi":[]}
            ]

      - name: Run Quality & Accessibility E2E Tests
        run: >-
          cd frontend && npx playwright test
          src/__tests__/e2e/cross-cutting/
          src/__tests__/e2e/dynamic/hub/basic.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret-for-e2e-quality-2025
          CI: true
          GITHUB_ACTIONS: ""

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-quality-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-authentication, e2e-authorization, e2e-classification-equivalency, e2e-resource-management, e2e-admin, e2e-user-journeys, e2e-quality]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | ${{ needs.e2e-authentication.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Authorization | ${{ needs.e2e-authorization.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Classification Equivalency | ${{ needs.e2e-classification-equivalency.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Management | ${{ needs.e2e-resource-management.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin Pages | ${{ needs.e2e-admin.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| User Journeys | ${{ needs.e2e-user-journeys.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality & Accessibility | ${{ needs.e2e-quality.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test artifacts available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
