name: E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/test-e2e.yml'

jobs:
  e2e-authentication:
    name: E2E - Authentication Flows
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Generate SSL Certificates for E2E
        run: |
          mkdir -p ${{ github.workspace }}/frontend/certs
          openssl req -x509 -newkey rsa:4096 -nodes \
            -keyout ${{ github.workspace }}/frontend/certs/key.pem \
            -out ${{ github.workspace }}/frontend/certs/certificate.pem \
            -days 365 \
            -subj "/C=US/ST=Test/L=Test/O=DIVE V3/CN=localhost"
          echo "‚úÖ Generated self-signed SSL certificates for E2E testing"
          ls -la ${{ github.workspace }}/frontend/certs/
      
      - name: Start Keycloak 26.4.2
        run: |
          echo "üöÄ Starting Keycloak 26.4.2..."
          docker run -d \
            --name keycloak \
            -p 8081:8080 \
            -e KC_DB=dev-mem \
            -e KC_LOG_LEVEL=warn \
            -e KEYCLOAK_ADMIN=admin \
            -e KEYCLOAK_ADMIN_PASSWORD=admin \
            -e KC_HEALTH_ENABLED=true \
            -e KC_HTTP_RELATIVE_PATH=/ \
            -e KC_HOSTNAME_STRICT=false \
            quay.io/keycloak/keycloak:26.4.2 \
            start-dev
          
          echo "‚úÖ Keycloak container started (mapped port 8081:8080)"
      
      - name: Configure Keycloak for E2E Tests
        run: |
          echo "‚è≥ Waiting for Keycloak to be ready..."
          # Increased from 30 to 60 iterations (5 minutes total)
          for i in {1..60}; do
            if curl -f http://localhost:8081/health/ready 2>/dev/null; then
              echo "‚úÖ Keycloak is ready"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "‚ùå Keycloak failed to start after 5 minutes"
              echo "Checking container logs..."
              docker logs keycloak
              echo "Checking container status..."
              docker ps -a
              exit 1
            fi
            echo "Waiting for Keycloak... ($i/60)"
            sleep 5
          done
          
          # Configure realm and test users via Keycloak Admin REST API
          export KEYCLOAK_URL=http://localhost:8081
          export ACCESS_TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
            -d "client_id=admin-cli" \
            -d "username=admin" \
            -d "password=admin" \
            -d "grant_type=password" | jq -r '.access_token')
          
          # Create dive-v3-broker realm
          curl -s -X POST "$KEYCLOAK_URL/admin/realms" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"realm":"dive-v3-broker","enabled":true}' || echo "Realm may already exist"
          
          # Create test users with OTP configured
          # User 1: admin-dive (TOP_SECRET, needs MFA)
          curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "username":"admin-dive",
              "enabled":true,
              "credentials":[{"type":"password","value":"Admin123!","temporary":false}],
              "attributes":{"clearance":["TOP_SECRET"],"countryOfAffiliation":["USA"],"acpCOI":["FVEY","NATO"]}
            }' || echo "User admin-dive may already exist"
          
          # User 2: testuser-secret (SECRET, needs MFA, has OTP)
          curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "username":"testuser-secret",
              "enabled":true,
              "credentials":[{"type":"password","value":"Secret123!","temporary":false}],
              "attributes":{"clearance":["SECRET"],"countryOfAffiliation":["USA"],"acpCOI":["FVEY"]}
            }' || echo "User testuser-secret may already exist"
          
          # User 3: testuser-unclass (UNCLASSIFIED, no MFA)
          curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "username":"testuser-unclass",
              "enabled":true,
              "credentials":[{"type":"password","value":"Unclass123!","temporary":false}],
              "attributes":{"clearance":["UNCLASSIFIED"],"countryOfAffiliation":["USA"],"acpCOI":[]}
            }' || echo "User testuser-unclass may already exist"
          
          # User 4: testuser-us (for policies-lab tests)
          curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "username":"testuser-us",
              "enabled":true,
              "credentials":[{"type":"password","value":"password","temporary":false}],
              "attributes":{"clearance":["SECRET"],"countryOfAffiliation":["USA"],"acpCOI":["FVEY"]}
            }' || echo "User testuser-us may already exist"
          
          echo "‚úÖ Keycloak configured for E2E tests"
      
      - name: Initialize PostgreSQL Database Schema
        run: |
          # Run Drizzle migrations to set up NextAuth schema
          cd frontend
          npx drizzle-kit push:pg || echo "Database schema already exists"
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Start Next.js Development Server
        run: |
          cd frontend
          # Start Next.js in background (HTTP mode for CI simplicity)
          nohup npm run dev:http > nextjs.log 2>&1 &
          
          # Wait for server to be ready
          echo "‚è≥ Waiting for Next.js to be ready..."
          for i in {1..60}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "‚úÖ Next.js is ready"
              break
            fi
            echo "Waiting for Next.js... ($i/60)"
            sleep 2
          done
          
          # Verify server is responding
          curl -f http://localhost:3000 || (cat nextjs.log && exit 1)
        env:
          NODE_ENV: development
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-authentication-flows-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
      
      - name: Run Authentication E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/mfa-complete-flow.spec.ts src/__tests__/e2e/mfa-conditional.spec.ts src/__tests__/e2e/external-idp-federation-flow.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-authentication-flows-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          BASE_URL: http://localhost:3000
          BACKEND_API_URL: http://localhost:4000
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-authentication-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-authorization:
    name: E2E - Authorization Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Generate SSL Certificates for E2E
        run: |
          mkdir -p ${{ github.workspace }}/frontend/certs
          openssl req -x509 -newkey rsa:4096 -nodes \
            -keyout ${{ github.workspace }}/frontend/certs/key.pem \
            -out ${{ github.workspace }}/frontend/certs/certificate.pem \
            -days 365 \
            -subj "/C=US/ST=Test/L=Test/O=DIVE V3/CN=localhost"
          echo "‚úÖ Generated self-signed SSL certificates for E2E testing"
          ls -la ${{ github.workspace }}/frontend/certs/
      
      - name: Start Keycloak 26.4.2
        run: |
          echo "üöÄ Starting Keycloak 26.4.2..."
          docker run -d \
            --name keycloak \
            -p 8081:8080 \
            -e KC_DB=dev-mem \
            -e KC_LOG_LEVEL=warn \
            -e KEYCLOAK_ADMIN=admin \
            -e KEYCLOAK_ADMIN_PASSWORD=admin \
            -e KC_HEALTH_ENABLED=true \
            -e KC_HTTP_RELATIVE_PATH=/ \
            -e KC_HOSTNAME_STRICT=false \
            quay.io/keycloak/keycloak:26.4.2 \
            start-dev
          
          echo "‚úÖ Keycloak container started (mapped port 8081:8080)"
      
      - name: Configure Keycloak for E2E Tests
        run: |
          echo "‚è≥ Waiting for Keycloak to be ready..."
          # Increased from 30 to 60 iterations (5 minutes total)
          for i in {1..60}; do
            if curl -f http://localhost:8081/health/ready 2>/dev/null; then
              echo "‚úÖ Keycloak is ready"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "‚ùå Keycloak failed to start after 5 minutes"
              echo "Checking container logs..."
              docker logs keycloak
              echo "Checking container status..."
              docker ps -a
              exit 1
            fi
            if [ $i -eq 60 ]; then
              echo "‚ùå Keycloak failed to start after 5 minutes"
              docker ps -a
              exit 1
            fi
            echo "Waiting for Keycloak... ($i/60)"
            sleep 5
          done
          
          export KEYCLOAK_URL=http://localhost:8081
          export ACCESS_TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
            -d "client_id=admin-cli" -d "username=admin" -d "password=admin" -d "grant_type=password" | jq -r '.access_token')
          
          curl -s -X POST "$KEYCLOAK_URL/admin/realms" \
            -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"realm":"dive-v3-broker","enabled":true}' || true
          
          for user in "admin-dive:Admin123!:TOP_SECRET" "testuser-us:password:SECRET"; do
            IFS=: read name pass clearance <<< "$user"
            curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" \
              -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
              -d "{\"username\":\"$name\",\"enabled\":true,\"credentials\":[{\"type\":\"password\",\"value\":\"$pass\",\"temporary\":false}],\"attributes\":{\"clearance\":[\"$clearance\"],\"countryOfAffiliation\":[\"USA\"],\"acpCOI\":[\"FVEY\"]}}" || true
          done
      
      - name: Initialize PostgreSQL Database Schema
        run: cd frontend && npx drizzle-kit push:pg || true
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Start Next.js Development Server
        run: |
          cd frontend
          nohup npm run dev:http > nextjs.log 2>&1 &
          
          for i in {1..60}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "‚úÖ Next.js is ready"
              break
            fi
            sleep 2
          done
          
          curl -f http://localhost:3000 || (cat nextjs.log && exit 1)
        env:
          NODE_ENV: development
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-authorization-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
      
      - name: Start OPA Server
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          chmod +x opa
          nohup ./opa run --server --addr=:8181 --log-level=error > opa.log 2>&1 &
          sleep 5
          curl -f http://localhost:8181/health || (cat opa.log && exit 1)
      
      - name: Run Authorization E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/identity-drawer.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-authorization-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          OPA_URL: http://localhost:8181
          BASE_URL: http://localhost:3000
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-authorization-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-classification-equivalency:
    name: E2E - Classification Equivalency
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      keycloak:
        image: quay.io/keycloak/keycloak:26.0.0
        ports:
          - 8081:8080
        env:
          KC_DB: dev-mem
          KC_LOG_LEVEL: warn
          KEYCLOAK_ADMIN: admin
          KEYCLOAK_ADMIN_PASSWORD: admin
          KC_HEALTH_ENABLED: "true"
          KC_HTTP_RELATIVE_PATH: /
        options: >-
          --health-cmd "curl -f http://localhost:8080/health/ready || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 120s
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Generate SSL Certificates for E2E
        run: |
          mkdir -p ${{ github.workspace }}/frontend/certs
          openssl req -x509 -newkey rsa:4096 -nodes \
            -keyout ${{ github.workspace }}/frontend/certs/key.pem \
            -out ${{ github.workspace }}/frontend/certs/certificate.pem \
            -days 365 \
            -subj "/C=US/ST=Test/L=Test/O=DIVE V3/CN=localhost"
          echo "‚úÖ Generated self-signed SSL certificates for E2E testing"
      
      - name: Configure Keycloak for E2E Tests
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8081/health/ready 2>/dev/null; then break; fi
            sleep 2
          done
          
          export KEYCLOAK_URL=http://localhost:8081
          export ACCESS_TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
            -d "client_id=admin-cli" -d "username=admin" -d "password=admin" -d "grant_type=password" | jq -r '.access_token')
          
          curl -s -X POST "$KEYCLOAK_URL/admin/realms" -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"realm":"dive-v3-broker","enabled":true}' || true
          
          for user in "admin-dive:Admin123!:TOP_SECRET" "testuser-us:password:SECRET"; do
            IFS=: read name pass clearance <<< "$user"
            curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
              -d "{\"username\":\"$name\",\"enabled\":true,\"credentials\":[{\"type\":\"password\",\"value\":\"$pass\",\"temporary\":false}],\"attributes\":{\"clearance\":[\"$clearance\"],\"countryOfAffiliation\":[\"USA\"],\"acpCOI\":[\"FVEY\"]}}" || true
          done
      
      - name: Initialize PostgreSQL Database Schema
        run: cd frontend && npx drizzle-kit push:pg || true
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Start Next.js Development Server
        run: |
          cd frontend
          nohup npm run dev:http > nextjs.log 2>&1 &
          for i in {1..60}; do
            if curl -f http://localhost:3000 2>/dev/null; then echo "‚úÖ Next.js is ready"; break; fi
            sleep 2
          done
          curl -f http://localhost:3000 || (cat nextjs.log && exit 1)
        env:
          NODE_ENV: development
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-classification-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
      
      - name: Run Classification Equivalency E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/classification-equivalency.spec.ts src/__tests__/e2e/integration-federation-vs-object.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-classification-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          BASE_URL: http://localhost:3000
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-classification-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-resource-management:
    name: E2E - Resource Management
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      keycloak:
        image: quay.io/keycloak/keycloak:26.0.0
        ports:
          - 8081:8080
        env:
          KC_DB: dev-mem
          KC_LOG_LEVEL: warn
          KEYCLOAK_ADMIN: admin
          KEYCLOAK_ADMIN_PASSWORD: admin
          KC_HEALTH_ENABLED: "true"
          KC_HTTP_RELATIVE_PATH: /
        options: >-
          --health-cmd "curl -f http://localhost:8080/health/ready || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 120s
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Generate SSL Certificates for E2E
        run: |
          mkdir -p ${{ github.workspace }}/frontend/certs
          openssl req -x509 -newkey rsa:4096 -nodes \
            -keyout ${{ github.workspace }}/frontend/certs/key.pem \
            -out ${{ github.workspace }}/frontend/certs/certificate.pem \
            -days 365 \
            -subj "/C=US/ST=Test/L=Test/O=DIVE V3/CN=localhost"
          echo "‚úÖ Generated self-signed SSL certificates for E2E testing"
      
      - name: Configure Keycloak for E2E Tests
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8081/health/ready 2>/dev/null; then break; fi
            sleep 2
          done
          
          export KEYCLOAK_URL=http://localhost:8081
          export ACCESS_TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
            -d "client_id=admin-cli" -d "username=admin" -d "password=admin" -d "grant_type=password" | jq -r '.access_token')
          
          curl -s -X POST "$KEYCLOAK_URL/admin/realms" -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
            -d '{"realm":"dive-v3-broker","enabled":true}' || true
          
          for user in "admin-dive:Admin123!:TOP_SECRET" "testuser-us:password:SECRET"; do
            IFS=: read name pass clearance <<< "$user"
            curl -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker/users" -H "Authorization: Bearer $ACCESS_TOKEN" -H "Content-Type: application/json" \
              -d "{\"username\":\"$name\",\"enabled\":true,\"credentials\":[{\"type\":\"password\",\"value\":\"$pass\",\"temporary\":false}],\"attributes\":{\"clearance\":[\"$clearance\"],\"countryOfAffiliation\":[\"USA\"],\"acpCOI\":[\"FVEY\"]}}" || true
          done
      
      - name: Initialize PostgreSQL Database Schema
        run: cd frontend && npx drizzle-kit push:pg || true
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Start Next.js Development Server
        run: |
          cd frontend
          nohup npm run dev:http > nextjs.log 2>&1 &
          for i in {1..60}; do
            if curl -f http://localhost:3000 2>/dev/null; then echo "‚úÖ Next.js is ready"; break; fi
            sleep 2
          done
          curl -f http://localhost:3000 || (cat nextjs.log && exit 1)
        env:
          NODE_ENV: development
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-resource-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
      
      - name: Start OPA Server
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          chmod +x opa
          nohup ./opa run --server --addr=:8181 --log-level=error > opa.log 2>&1 &
          sleep 5
          curl -f http://localhost:8181/health || (cat opa.log && exit 1)
      
      - name: Run Resource Management E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/policies-lab.spec.ts src/__tests__/e2e/nato-expansion.spec.ts src/__tests__/e2e/idp-management-revamp.spec.ts tests/e2e/sp-registry.spec.ts
        env:
          NODE_ENV: test
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e-resource-2025
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_REALM: dive-v3-broker
          KEYCLOAK_CLIENT_ID: dive-v3-client-broker
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          OPA_URL: http://localhost:8181
          BASE_URL: http://localhost:3000
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-resource-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-authentication, e2e-authorization, e2e-classification-equivalency, e2e-resource-management]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## üé≠ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | ${{ needs.e2e-authentication.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Authorization | ${{ needs.e2e-authorization.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Classification Equivalency | ${{ needs.e2e-classification-equivalency.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Management | ${{ needs.e2e-resource-management.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test artifacts available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

