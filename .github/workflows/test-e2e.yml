name: E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/test-e2e.yml'

jobs:
  e2e-authentication:
    name: E2E - Authentication Flows
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Run Authentication E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/mfa-complete-flow.spec.ts src/__tests__/e2e/mfa-conditional.spec.ts src/__tests__/e2e/external-idp-federation-flow.spec.ts
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-authentication-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-authorization:
    name: E2E - Authorization Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Start OPA Server
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          chmod +x opa
          nohup ./opa run --server --addr=:8181 --log-level=error > opa.log 2>&1 &
          sleep 5
          curl -f http://localhost:8181/health || (cat opa.log && exit 1)
      
      - name: Run Authorization E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/identity-drawer.spec.ts
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          OPA_URL: http://localhost:8181
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-authorization-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-classification-equivalency:
    name: E2E - Classification Equivalency
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Run Classification Equivalency E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/classification-equivalency.spec.ts src/__tests__/e2e/integration-federation-vs-object.spec.ts
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-classification-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-resource-management:
    name: E2E - Resource Management
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium
      
      - name: Start OPA Server
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.68.0/opa_linux_amd64_static
          chmod +x opa
          nohup ./opa run --server --addr=:8181 --log-level=error > opa.log 2>&1 &
          sleep 5
          curl -f http://localhost:8181/health || (cat opa.log && exit 1)
      
      - name: Run Resource Management E2E Tests
        run: cd frontend && npx playwright test src/__tests__/e2e/policies-lab.spec.ts src/__tests__/e2e/nato-expansion.spec.ts src/__tests__/e2e/idp-management-revamp.spec.ts tests/e2e/sp-registry.spec.ts
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-e2e
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          OPA_URL: http://localhost:8181
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-resource-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-authentication, e2e-authorization, e2e-classification-equivalency, e2e-resource-management]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸŽ­ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | ${{ needs.e2e-authentication.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Authorization | ${{ needs.e2e-authorization.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Classification Equivalency | ${{ needs.e2e-classification-equivalency.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Management | ${{ needs.e2e-resource-management.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test artifacts available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

