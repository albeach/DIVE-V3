# =============================================================================
# DIVE V3 - GKE Deployment via ArgoCD
# =============================================================================
# GitOps deployment workflow that:
# 1. Builds and pushes images to Artifact Registry
# 2. Updates Kubernetes manifests with new image tags
# 3. Commits changes to Git (triggers ArgoCD sync)
# 4. Optionally triggers ArgoCD sync via API
#
# Triggers:
#   - Push to main branch (after image build)
#   - Manual workflow dispatch
#   - After successful image build workflow
# =============================================================================

name: Deploy to GKE via ArgoCD

on:
  workflow_run:
    workflows: ["Build and Push Container Images"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest commit SHA)'
        required: false
        type: string
      sync_argocd:
        description: 'Trigger ArgoCD sync immediately'
        required: false
        type: boolean
        default: true

permissions:
  contents: write  # Required to commit manifest updates
  id-token: write  # Required for GCP authentication

env:
  GCP_PROJECT_ID: dive25
  GCP_REGION: us-east4
  GKE_CLUSTER: dive-v3-cluster
  GKE_LOCATION: us-east4
  ARGOCD_NAMESPACE: argocd
  ARGOCD_APP_NAME: dive-v3

jobs:
  update-manifests:
    name: Update Kubernetes Manifests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine Image Tag
        id: image-tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ -n "${{ github.event.workflow_run.head_sha }}" ]; then
            IMAGE_TAG="${{ github.event.workflow_run.head_sha }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Using image tag: $IMAGE_TAG"
      
      - name: Update Backend Deployment
        run: |
          IMAGE_TAG="${{ steps.image-tag.outputs.tag }}"
          REGISTRY="us-east4-docker.pkg.dev/dive25/dive-v3-repo"
          
          # Update backend deployment image
          sed -i.bak \
            "s|image:.*dive-v3-backend.*|image: ${REGISTRY}/dive-v3-backend:${IMAGE_TAG}|g" \
            k8s/base/backend/deployment.yaml
          
          echo "Updated backend image to: ${REGISTRY}/dive-v3-backend:${IMAGE_TAG}"
      
      - name: Update Frontend Deployment
        run: |
          IMAGE_TAG="${{ steps.image-tag.outputs.tag }}"
          REGISTRY="us-east4-docker.pkg.dev/dive25/dive-v3-repo"
          
          # Update frontend deployment image
          sed -i.bak \
            "s|image:.*dive-v3-frontend.*|image: ${REGISTRY}/dive-v3-frontend:${IMAGE_TAG}|g" \
            k8s/base/frontend/deployment.yaml
          
          echo "Updated frontend image to: ${REGISTRY}/dive-v3-frontend:${IMAGE_TAG}"
      
      - name: Update Keycloak Deployment
        run: |
          IMAGE_TAG="${{ steps.image-tag.outputs.tag }}"
          REGISTRY="us-east4-docker.pkg.dev/dive25/dive-v3-repo"
          
          # Update keycloak deployment image
          sed -i.bak \
            "s|image:.*dive-v3-keycloak.*|image: ${REGISTRY}/dive-v3-keycloak:${IMAGE_TAG}|g" \
            k8s/base/keycloak/deployment.yaml
          
          echo "Updated keycloak image to: ${REGISTRY}/dive-v3-keycloak:${IMAGE_TAG}"
      
      - name: Commit Manifest Updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add k8s/base/*/deployment.yaml
          
          if git diff --staged --quiet; then
            echo "No manifest changes to commit"
          else
            git commit -m "chore(deploy): update image tags to ${{ steps.image-tag.outputs.tag }} [skip ci]"
            git push
            echo "âœ… Manifest updates committed and pushed"
          fi
      
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`us-east4-docker.pkg.dev/dive25/dive-v3-repo\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Services" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Keycloak" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically sync these changes." >> $GITHUB_STEP_SUMMARY

  trigger-argocd-sync:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    needs: [update-manifests]
    if: ${{ inputs.sync_argocd != false }}
    
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_LOCATION }} \
            --project ${{ env.GCP_PROJECT_ID }}
      
      - name: Get ArgoCD Admin Password
        id: argocd-password
        run: |
          PASSWORD=$(kubectl -n ${{ env.ARGOCD_NAMESPACE }} get secret argocd-initial-admin-secret \
            -o jsonpath="{.data.password}" | base64 -d)
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
      
      - name: Port Forward ArgoCD Server
        run: |
          kubectl port-forward -n ${{ env.ARGOCD_NAMESPACE }} svc/argocd-server 8080:443 &
          sleep 5
        continue-on-error: true
      
      - name: Trigger ArgoCD Sync
        run: |
          # Use ArgoCD CLI or API to trigger sync
          # For now, ArgoCD will auto-sync based on Git changes
          echo "âœ… ArgoCD will automatically sync when Git changes are detected"
          echo "To manually trigger: kubectl patch application ${{ env.ARGOCD_APP_NAME }} -n ${{ env.ARGOCD_NAMESPACE }} --type merge -p '{\"operation\":{\"initiatedBy\":{\"username\":\"github-actions\"},\"sync\":{\"revision\":\"main\"}}}'"
        continue-on-error: true













