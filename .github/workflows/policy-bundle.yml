name: Policy Bundle Build & Validation

on:
  push:
    branches: [main]
    paths:
      - 'policies/**'
      - '.github/workflows/policy-bundle.yml'
  pull_request:
    branches: [main]
    paths:
      - 'policies/**'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force bundle build even without policy changes'
        required: false
        default: 'false'
        type: boolean

env:
  OPA_VERSION: '0.68.0'
  REGAL_VERSION: '0.24.0'

jobs:
  # ============================================
  # Stage 1: Validate Policy Syntax & Style
  # ============================================
  validate:
    name: Validate Rego Syntax & Style
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Validate Rego Syntax (Strict Mode)
        run: |
          echo "ðŸ” Checking Rego syntax in strict mode..."
          opa check policies/ --strict
          echo "âœ… Syntax validation passed"

      - name: Install Regal Linter
        run: |
          curl -L -o regal "https://github.com/StyraInc/regal/releases/download/v${{ env.REGAL_VERSION }}/regal_Linux_x86_64"
          chmod +x regal
          sudo mv regal /usr/local/bin/

      - name: Run Regal Linter
        run: |
          echo "ðŸ” Running Regal linter..."
          regal lint policies/ --format=github || true
          # Note: Don't fail on lint warnings, just report

      - name: Check for Hardcoded Values
        run: |
          echo "ðŸ” Scanning for hardcoded secrets/URLs..."
          
          # Check for hardcoded localhost (except in test files)
          if grep -r "localhost" policies/*.rego 2>/dev/null | grep -v "_test.rego"; then
            echo "âš ï¸ Warning: Found hardcoded localhost in policies"
          fi
          
          # Check for hardcoded secrets
          if grep -rE "(password|secret|key)\s*:=\s*\"" policies/*.rego 2>/dev/null; then
            echo "âŒ ERROR: Potential hardcoded secrets found!"
            exit 1
          fi
          
          echo "âœ… No hardcoded secrets detected"

      - name: Verify Package Naming Convention
        run: |
          echo "ðŸ” Verifying package naming convention..."
          
          # All packages must start with 'dive.'
          INVALID_PACKAGES=$(grep -rh "^package" policies/*.rego 2>/dev/null | grep -v "^package dive\." | grep -v "^package data\." || true)
          
          if [ -n "$INVALID_PACKAGES" ]; then
            echo "âŒ ERROR: Invalid package names found:"
            echo "$INVALID_PACKAGES"
            echo ""
            echo "All packages must start with 'dive.' namespace"
            exit 1
          fi
          
          echo "âœ… Package naming convention verified"

  # ============================================
  # Stage 2: Run Policy Tests
  # ============================================
  test:
    name: Run Policy Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Run All Policy Tests
        run: |
          echo "ðŸ§ª Running OPA policy tests..."
          opa test policies/ -v --coverage --format=json > test-results.json
          
          # Extract coverage percentage
          COVERAGE=$(jq '.coverage // 0' test-results.json)
          echo "ðŸ“Š Test coverage: ${COVERAGE}%"
          
          # Display test summary
          PASSED=$(jq '[.[] | select(.pass == true)] | length' test-results.json || echo "0")
          FAILED=$(jq '[.[] | select(.pass == false)] | length' test-results.json || echo "0")
          
          echo "## OPA Policy Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${PASSED} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${FAILED} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY

      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(jq '.coverage // 0' test-results.json)
          THRESHOLD=70
          
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% below ${THRESHOLD}% threshold"
            exit 1
          fi
          
          echo "âœ… Coverage ${COVERAGE}% meets ${THRESHOLD}% threshold"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: policy-test-results
          path: test-results.json
          retention-days: 30

  # ============================================
  # Stage 3: Policy Diff (PR only)
  # ============================================
  diff:
    name: Policy Change Diff
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Generate Policy Diff
        run: |
          echo "ðŸ“ Generating policy diff..."
          
          # Get changed policy files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'policies/*.rego' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No policy files changed"
            exit 0
          fi
          
          echo "Changed policy files:"
          echo "$CHANGED_FILES"
          
          # Generate diff report
          echo "## Policy Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modified Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Show actual diffs for each file
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Changes" >> $GITHUB_STEP_SUMMARY
          
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### $file" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              git diff origin/${{ github.base_ref }}...HEAD -- "$file" >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Impact Analysis
        run: |
          echo "ðŸ” Analyzing policy impact..."
          
          # Check for changes to allow rules
          ALLOW_CHANGES=$(git diff origin/${{ github.base_ref }}...HEAD -- 'policies/*.rego' | grep -E "^[+-].*allow" | head -20 || true)
          
          if [ -n "$ALLOW_CHANGES" ]; then
            echo ""
            echo "## âš ï¸ Changes to Allow Rules Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following changes affect authorization allow rules:" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$ALLOW_CHANGES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Please ensure these changes are intentional and have been tested.**" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Stage 4: Build Policy Bundles
  # ============================================
  build:
    name: Build Policy Bundles
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event.inputs.force_build == 'true'
    
    outputs:
      bundle_version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Generate Bundle Version
        id: version
        run: |
          VERSION="${{ github.sha }}"
          SHORT_VERSION="${VERSION:0:8}"
          TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
          FULL_VERSION="${SHORT_VERSION}-${TIMESTAMP}"
          
          echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Bundle version: ${FULL_VERSION}"

      - name: Create Bundle Directory
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p bundles/${VERSION}
          echo "ðŸ“ Created bundle directory: bundles/${VERSION}"

      - name: Build Base Bundle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ðŸ“¦ Building base policy bundle..."
          opa build \
            -b policies/ \
            -o bundles/${VERSION}/dive-base.tar.gz \
            --revision ${VERSION}
          
          echo "âœ… Base bundle built: bundles/${VERSION}/dive-base.tar.gz"
          ls -la bundles/${VERSION}/

      - name: Build Tenant Bundles
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Build per-tenant bundles (when tenant directories exist)
          for tenant in usa fra gbr deu; do
            TENANT_DIR="policies/tenant/${tenant}"
            
            if [ -d "$TENANT_DIR" ]; then
              echo "ðŸ“¦ Building ${tenant} tenant bundle..."
              opa build \
                -b policies/ \
                -o bundles/${VERSION}/dive-${tenant}.tar.gz \
                --revision ${VERSION}
              echo "âœ… Built: bundles/${VERSION}/dive-${tenant}.tar.gz"
            else
              echo "â­ï¸ Skipping ${tenant} - no tenant directory"
              # Use base bundle as tenant bundle for now
              cp bundles/${VERSION}/dive-base.tar.gz bundles/${VERSION}/dive-${tenant}.tar.gz
            fi
          done

      - name: Generate Bundle Manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          cat > bundles/${VERSION}/manifest.json << EOF
          {
            "version": "${VERSION}",
            "built_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "opa_version": "${{ env.OPA_VERSION }}",
            "bundles": [
              "dive-base.tar.gz",
              "dive-usa.tar.gz",
              "dive-fra.tar.gz",
              "dive-gbr.tar.gz",
              "dive-deu.tar.gz"
            ]
          }
          EOF
          
          echo "ðŸ“‹ Generated manifest:"
          cat bundles/${VERSION}/manifest.json

      - name: Upload Bundle Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: policy-bundles-${{ steps.version.outputs.version }}
          path: bundles/
          retention-days: 90

      - name: Bundle Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "## ðŸ“¦ Policy Bundle Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OPA Version | ${{ env.OPA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundles Built" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la bundles/${VERSION}/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 5: Baseline Comparison
  # ============================================
  baseline-check:
    name: Baseline Regression Check
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    services:
      opa:
        image: openpolicyagent/opa:latest
        ports:
          - 8181:8181
        options: >-
          --health-cmd "wget -q --spider http://localhost:8181/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Load Policies into OPA
        run: |
          # Wait for OPA to be ready
          sleep 5
          
          # Load all policies
          for file in policies/*.rego; do
            if [ -f "$file" ]; then
              POLICY_NAME=$(basename "$file" .rego)
              echo "Loading policy: $POLICY_NAME"
              curl -X PUT "http://localhost:8181/v1/policies/${POLICY_NAME}" \
                -H "Content-Type: text/plain" \
                --data-binary @"$file"
            fi
          done
          
          # Load test policies
          for file in policies/tests/*.rego; do
            if [ -f "$file" ]; then
              POLICY_NAME=$(basename "$file" .rego)
              echo "Loading test policy: $POLICY_NAME"
              curl -X PUT "http://localhost:8181/v1/policies/tests_${POLICY_NAME}" \
                -H "Content-Type: text/plain" \
                --data-binary @"$file"
            fi
          done

      - name: Check for Baseline File
        id: baseline
        run: |
          if [ -f "policies/baselines/decision-baseline.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Baseline file found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No baseline file - skipping regression check"
          fi

      - name: Run Baseline Comparison
        if: steps.baseline.outputs.exists == 'true'
        run: |
          cd scripts/policy
          npm install -g ts-node typescript
          npm install axios
          
          # Run comparison
          npx ts-node capture-baseline.ts compare
        env:
          OPA_URL: http://localhost:8181

  # ============================================
  # Stage 6: Performance Benchmark
  # ============================================
  benchmark:
    name: Policy Performance Benchmark
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Run OPA Benchmark
        run: |
          echo "â±ï¸ Running OPA performance benchmark..."
          
          # Benchmark main authorization policy
          if [ -f "policies/fuel_inventory_abac_policy.rego" ]; then
            echo "Benchmarking fuel_inventory_abac_policy.rego..."
            opa bench policies/fuel_inventory_abac_policy.rego --count 1000 2>&1 | tee benchmark-main.txt
          fi
          
          # Benchmark federation policy
          if [ -f "policies/federation_abac_policy.rego" ]; then
            echo "Benchmarking federation_abac_policy.rego..."
            opa bench policies/federation_abac_policy.rego --count 1000 2>&1 | tee benchmark-federation.txt
          fi

      - name: Generate Benchmark Report
        run: |
          echo "## â±ï¸ Policy Performance Benchmark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "benchmark-main.txt" ]; then
            echo "### Main Authorization Policy" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat benchmark-main.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "benchmark-federation.txt" ]; then
            echo "### Federation Policy" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat benchmark-federation.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi












