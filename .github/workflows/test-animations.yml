name: Animation E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'frontend/src/components/admin/shared/AnimatedButton.tsx'
      - 'frontend/src/components/admin/shared/AdminPageTransition.tsx'
      - 'frontend/src/components/admin/shared/PresenceIndicator.tsx'
      - 'frontend/src/__tests__/e2e/animations/**'
      - '.github/workflows/test-animations.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/src/components/admin/shared/**'
      - 'frontend/src/app/admin/**'
      - 'frontend/src/__tests__/e2e/animations/**'
  workflow_dispatch:

jobs:
  animation-tests:
    name: Animation Component Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dive_v3_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      
      - name: Generate SSL Certificates
        run: |
          mkdir -p ${{ github.workspace }}/frontend/certs
          mkdir -p ${{ github.workspace }}/keycloak-certs
          
          openssl req -x509 -newkey rsa:4096 -nodes \
            -keyout ${{ github.workspace }}/frontend/certs/key.pem \
            -out ${{ github.workspace }}/frontend/certs/certificate.pem \
            -days 365 \
            -subj "/C=US/ST=Test/L=Test/O=DIVE V3/CN=localhost"
          
          openssl req -x509 -newkey rsa:4096 -nodes \
            -keyout ${{ github.workspace }}/keycloak-certs/key.pem \
            -out ${{ github.workspace }}/keycloak-certs/cert.pem \
            -days 1 \
            -subj "/C=US/ST=Test/L=Test/O=DIVE V3 CI/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,DNS:keycloak,IP:127.0.0.1"
          
          chmod 644 ${{ github.workspace }}/keycloak-certs/cert.pem
          chmod 644 ${{ github.workspace }}/keycloak-certs/key.pem
      
      - name: Start Keycloak
        run: |
          SERVICE_NETWORK=$(docker network ls -q -f name=github_network_ | head -1)
          if [ -z "$SERVICE_NETWORK" ]; then
            SERVICE_NETWORK=$(docker network ls -q | head -1)
          fi

          docker run -d \
            --name keycloak \
            --network "$SERVICE_NETWORK" \
            -p 8443:8443 \
            -p 9000:9000 \
            -v ${{ github.workspace }}/keycloak-certs:/opt/keycloak/certs:ro \
            -e KC_DB=dev-mem \
            -e KC_LOG_LEVEL=info \
            -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
            -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
            -e KC_HEALTH_ENABLED=true \
            -e KC_HTTPS_CERTIFICATE_FILE=/opt/keycloak/certs/cert.pem \
            -e KC_HTTPS_CERTIFICATE_KEY_FILE=/opt/keycloak/certs/key.pem \
            -e KC_HOSTNAME_STRICT=false \
            -e KC_HTTP_ENABLED=false \
            quay.io/keycloak/keycloak:26.4.2 \
            start-dev --https-port=8443

          for i in {1..30}; do
            if nc -z localhost 9000 2>/dev/null; then
              echo "✅ Keycloak ready"
              break
            fi
            sleep 2
          done
      
      - name: Configure Keycloak
        run: |
          export KEYCLOAK_URL=https://localhost:8443
          export ACCESS_TOKEN=$(curl -k -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
            -d "client_id=admin-cli" -d "username=admin" -d "password=admin" -d "grant_type=password" | jq -r '.access_token')
          
          curl -k -s -X POST "$KEYCLOAK_URL/admin/realms" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"realm":"dive-v3-broker-usa","enabled":true}' || true
          
          curl -k -s -X POST "$KEYCLOAK_URL/admin/realms/dive-v3-broker-usa/users" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","enabled":true,"credentials":[{"type":"password","value":"password","temporary":false}],"attributes":{"clearance":["SECRET"],"countryOfAffiliation":["USA"]}}' || true
      
      - name: Initialize Database
        run: cd frontend && npx drizzle-kit push:pg || true
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
      
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
      
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd frontend && npx playwright install --with-deps chromium firefox webkit
      
      - name: Start Next.js Server
        run: |
          cd frontend
          export CERT_PATH="${{ github.workspace }}/frontend/certs"
          nohup npm run dev > nextjs.log 2>&1 &
          
          for i in {1..30}; do
            if curl -k --max-time 10 -f https://localhost:3000 2>/dev/null; then
              echo "✅ Next.js ready"
              break
            fi
            sleep 2
          done
        env:
          NODE_ENV: development
          NEXTAUTH_URL: https://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-animation-tests
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: https://localhost:8443
          KEYCLOAK_REALM: dive-v3-broker-usa
          KEYCLOAK_CLIENT_ID: dive-v3-broker-usa
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          KEYCLOAK_INSECURE_SKIP_VERIFY: "true"
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
      
      - name: Run Animation Tests
        id: animation_tests
        continue-on-error: true
        run: cd frontend && npm run test:e2e:animations
        env:
          NODE_ENV: test
          NEXTAUTH_URL: https://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-animation-tests
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app
          KEYCLOAK_URL: https://localhost:8443
          KEYCLOAK_REALM: dive-v3-broker-usa
          KEYCLOAK_CLIENT_ID: dive-v3-broker-usa
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          KEYCLOAK_INSECURE_SKIP_VERIFY: "true"
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          BASE_URL: https://localhost:3000
          CI: true
          NODE_OPTIONS: --max-old-space-size=4096
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: animation-test-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
          retention-days: 7
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## Animation Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.animation_tests.outcome }}" = "success" ]; then
            echo "Animation E2E tests passed." >> $GITHUB_STEP_SUMMARY
          else
            echo "Animation E2E tests failed (non-blocking for this workflow)." >> $GITHUB_STEP_SUMMARY
          fi
          echo "Check uploaded artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
