# =============================================================================
# DIVE V3 - CI Pipeline for Pull Requests
# =============================================================================
# Runs comprehensive tests on pull requests before merge
# Fast feedback loop for developers
# =============================================================================

name: CI - Pull Request
on:
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'keycloak/**'
      - 'policies/**'
      - 'terraform/**'
      - 'k8s/**'
      - 'docker-compose*.yml'
      - 'instances/**'
      - 'scripts/**'
      - '.github/workflows/ci-pr.yml'
concurrency:
  group: ci-pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  # Security: Check for hardcoded secrets
  secrets-lint:
    name: Secrets Lint
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Lint for Hardcoded Secrets
        id: secrets_lint
        run: bash ./scripts/lint-secrets.sh --ci
      - name: Report Secrets Lint Outcome
        if: always()
        run: |
          if [ "${{ steps.secrets_lint.outcome }}" = "success" ]; then
            echo "✅ Secrets lint passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Secrets lint reported findings." >> $GITHUB_STEP_SUMMARY
          fi
  # Dependency review: block high-severity vulnerabilities and restricted licenses
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes]
    if: github.event_name == 'pull_request' && needs.changes.outputs.dependency_changed == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Dependency Review
        uses: actions/dependency-review-action@05fe4576374b728f0c523d6a13d64c25081e0803
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
  # Shell script linting on changed scripts
  lint-shell:
    name: ShellCheck
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Detect changed shell scripts
        id: changed-shell
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          mapfile -t changed_files < <(git diff --name-only "$BASE_SHA...$HEAD_SHA" -- scripts/)

          shell_files=()
          for file in "${changed_files[@]}"; do
            [[ -f "$file" ]] || continue
            if [[ "$file" == *.sh ]] || head -n 1 "$file" | grep -qE '^#!.*(ba|z|k)?sh'; then
              shell_files+=("$file")
            fi
          done

          if [ "${#shell_files[@]}" -eq 0 ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          file_list="/tmp/changed-shell-files.txt"
          printf '%s\n' "${shell_files[@]}" > "$file_list"
          echo "has_files=true" >> "$GITHUB_OUTPUT"
          echo "file_list=$file_list" >> "$GITHUB_OUTPUT"
      - name: Run ShellCheck
        if: steps.changed-shell.outputs.has_files == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v shellcheck >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y shellcheck
          fi
          xargs -r shellcheck -S warning < "${{ steps.changed-shell.outputs.file_list }}"
      - name: Skip ShellCheck
        if: steps.changed-shell.outputs.has_files != 'true'
        run: echo "No changed shell scripts to lint."
  # Docker Compose validation
  lint-compose:
    name: Docker Compose Validate
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Prepare env for compose validation
        run: |
          rm -f .env
          cp .env.example .env
          cp .env .env.hub
          cat >> .env <<'EOF'
          POSTGRES_PASSWORD=test
          POSTGRES_PASSWORD_USA=test
          MONGO_PASSWORD=test
          MONGO_PASSWORD_USA=test
          REDIS_PASSWORD_BLACKLIST=test
          REDIS_PASSWORD_SPOKE=test
          REDIS_PASSWORD_USA=test
          KEYCLOAK_ADMIN_PASSWORD=test
          KEYCLOAK_ADMIN_PASSWORD_SPOKE=test
          KEYCLOAK_CLIENT_SECRET=test
          KEYCLOAK_CLIENT_SECRET_SPOKE=test
          KEYCLOAK_CLIENT_SECRET_USA=test
          AUTH_SECRET=testsecret123456789012
          NEXTAUTH_SECRET_SPOKE=testsecret123456789012
          POSTGRES_PASSWORD_SPOKE=test
          MONGO_PASSWORD_SPOKE=test
          EOF
      - name: Validate docker-compose.yml
        run: docker compose -f docker-compose.yml config --quiet
      - name: Validate docker-compose.hub.yml
        run: docker compose -f docker-compose.hub.yml config --quiet
      - name: Validate docker-compose.pilot.yml
        run: docker compose -f docker-compose.pilot.yml config --quiet
  changes:
    name: Detect Changed Domains
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      backend_changed: ${{ steps.detect.outputs.backend_changed }}
      frontend_changed: ${{ steps.detect.outputs.frontend_changed }}
      policies_changed: ${{ steps.detect.outputs.policies_changed }}
      k8s_changed: ${{ steps.detect.outputs.k8s_changed }}
      deploy_changed: ${{ steps.detect.outputs.deploy_changed }}
      dependency_changed: ${{ steps.detect.outputs.dependency_changed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Detect changed paths
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          backend_changed=false
          frontend_changed=false
          policies_changed=false
          k8s_changed=false
          deploy_changed=false
          dependency_changed=false

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            while IFS= read -r file; do
              case "$file" in
                backend/*) backend_changed=true ;;
                frontend/*) frontend_changed=true ;;
                policies/*) policies_changed=true ;;
                k8s/*) k8s_changed=true ;;
                terraform/*|scripts/*|instances/*|docker-compose*.yml) deploy_changed=true ;;
                **/package.json|**/package-lock.json|**/npm-shrinkwrap.json|**/yarn.lock|**/pnpm-lock.yaml|**/go.mod|**/go.sum|**/Cargo.toml|**/Cargo.lock|**/pom.xml|**/build.gradle|**/build.gradle.kts|**/requirements.txt|**/poetry.lock|**/Pipfile|**/Pipfile.lock|**/composer.json|**/composer.lock|**/Gemfile|**/Gemfile.lock|**/*.csproj|**/*.fsproj|**/*.vbproj|**/packages.lock.json) dependency_changed=true ;;
              esac
            done < <(git diff --name-only "$BASE_SHA...$HEAD_SHA")
          else
            backend_changed=true
            frontend_changed=true
            policies_changed=true
            k8s_changed=true
            deploy_changed=true
            dependency_changed=true
          fi

          echo "backend_changed=$backend_changed" >> "$GITHUB_OUTPUT"
          echo "frontend_changed=$frontend_changed" >> "$GITHUB_OUTPUT"
          echo "policies_changed=$policies_changed" >> "$GITHUB_OUTPUT"
          echo "k8s_changed=$k8s_changed" >> "$GITHUB_OUTPUT"
          echo "deploy_changed=$deploy_changed" >> "$GITHUB_OUTPUT"
          echo "dependency_changed=$dependency_changed" >> "$GITHUB_OUTPUT"
  # Terraform validation
  terraform-validate:
    name: Terraform - Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: 1.13.4
      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/
      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false
      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate
  # Fast feedback: TypeScript compilation and linting
  quick-checks:
    name: Quick Checks (TypeScript, Linting)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes, lint-shell, lint-compose, terraform-validate]
    if: needs.changes.outputs.backend_changed == 'true' || needs.changes.outputs.frontend_changed == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Setup Node.js 20
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'
          cache: 'npm'
      - name: Backend TypeScript Check
        run: |
          cd backend
          npm ci
          npm run typecheck
      - name: Frontend TypeScript Check
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npm run typecheck
      - name: Backend Lint
        run: |
          cd backend
          npm run lint
        env:
          ESLINT_USE_FLAT_CONFIG: "false"
      - name: Frontend Lint
        run: |
          cd frontend
          npm run lint
        env:
          ESLINT_USE_FLAT_CONFIG: "false"
  # Backend tests (unit only for speed)
  backend-tests:
    name: Backend - Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, quick-checks]
    if: needs.changes.outputs.backend_changed == 'true'
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ping:1}).ok' | grep 1" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Setup Node.js 20
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install Dependencies
        run: cd backend && npm ci
      - name: Generate Test Certificates
        run: |
          cd backend
          chmod +x scripts/generate-test-certs.sh
          ./scripts/generate-test-certs.sh
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5
        with:
          version: 1.12.3
      - name: Start OPA Server
        run: |
          nohup opa run --server --addr=:8181 > opa.log 2>&1 &
          sleep 3
          curl -f http://localhost:8181/health || (cat opa.log && exit 1)
      - name: Run Unit Tests
        id: backend_unit_tests
        run: |
          cd backend
          npm run test:unit
        env:
          NODE_ENV: test
          MONGODB_URL: mongodb://localhost:27017/dive-v3-test
          MONGODB_AUTH_DISABLED: true
          OPA_URL: http://localhost:8181
      - name: Report Backend Test Outcome
        if: always()
        run: |
          if [ "${{ steps.backend_unit_tests.outcome }}" = "success" ]; then
            echo "✅ Backend unit test suite passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Backend unit test suite failed." >> $GITHUB_STEP_SUMMARY
          fi
      - name: Verify OPAL Hash Evidence
        if: steps.backend_unit_tests.outcome == 'success'
        run: |
          echo "## OPAL Bundle Hash Verification Evidence" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node -e "
            const crypto = require('crypto');
            const content = Buffer.from(JSON.stringify({test: 'bundle-ci-evidence'}));
            const hash = crypto.createHash('sha256').update(content).digest('hex');
            const tamperedContent = Buffer.from(JSON.stringify({test: 'tampered-bundle'}));
            const tamperedHash = crypto.createHash('sha256').update(tamperedContent).digest('hex');
            if (hash === tamperedHash) { console.error('FAIL: identical hashes for different content'); process.exit(1); }
            if (hash.length !== 64) { console.error('FAIL: hash length is not 64'); process.exit(1); }
            console.log('SHA-256 hash computation: PASS');
            console.log('Hash mismatch detection: PASS');
            console.log('Original hash: ' + hash.substring(0,16) + '...');
            console.log('Tampered hash: ' + tamperedHash.substring(0,16) + '...');
          "
          echo "- SHA-256 hash computation verified" >> $GITHUB_STEP_SUMMARY
          echo "- Hash mismatch detection verified" >> $GITHUB_STEP_SUMMARY
  # Frontend tests
  frontend-tests:
    name: Frontend - Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, quick-checks]
    if: needs.changes.outputs.frontend_changed == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Setup Node.js 20
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install Dependencies
        run: cd frontend && npm ci --legacy-peer-deps
      - name: Run Tests
        id: frontend_tests
        run: |
          cd frontend
          npm test -- --maxWorkers=2 --forceExit
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-ci
          NODE_OPTIONS: --max-old-space-size=4096
      - name: Report Frontend Test Outcome
        if: always()
        run: |
          if [ "${{ steps.frontend_tests.outcome }}" = "success" ]; then
            echo "✅ Frontend test suite passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Frontend test suite failed." >> $GITHUB_STEP_SUMMARY
          fi
  # OPA policy tests
  opa-tests:
    name: OPA - Policy Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes]
    if: needs.changes.outputs.policies_changed == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5
        with:
          version: 1.12.3
      - name: Run Policy Tests
        run: |
          cd policies
          opa test . -v
  # Kubernetes manifest validation
  k8s-validation:
    name: Kubernetes - Manifest Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [changes]
    if: needs.changes.outputs.k8s_changed == 'true'
    steps:
      - name: Checkout Code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Setup kubectl
        uses: azure/setup-kubectl@901a10e89ea615cf61f57ac05cecdf23e7de06d8
      - name: Validate Manifests
        run: |
          kubectl apply --dry-run=client -f k8s/base/ -R
      - name: Kustomize Build Test
        run: |
          # Check if kustomize is available
          if command -v kustomize &> /dev/null; then
            cd k8s/base
            kustomize build . > /dev/null
            echo "✅ Kustomize build successful"
          else
            echo "⚠️ kustomize not available, skipping"
          fi
  # Deploy command dry-run validation
  deploy-dry-run:
    name: Deploy Dry Run
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes, lint-compose, terraform-validate, backend-tests, frontend-tests, opa-tests, k8s-validation]
    if: needs.changes.outputs.deploy_changed == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false
      - name: Deploy Dry Run
        run: ./dive deploy --dry-run
        env:
          DRY_RUN: "true"
          POSTGRES_PASSWORD: test-password
          KEYCLOAK_ADMIN_PASSWORD: test-password
          MONGO_PASSWORD: test-password
          AUTH_SECRET: test-secret-value-for-ci
          KEYCLOAK_CLIENT_SECRET: test-client-secret
          REDIS_PASSWORD: test-password
  # PR Summary
  pr-summary:
    name: PR Test Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes, secrets-lint, dependency-review, lint-shell, lint-compose, terraform-validate, quick-checks, backend-tests, frontend-tests, opa-tests, k8s-validation, deploy-dry-run]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          status_icon() {
            case "$1" in
              success) echo "✅" ;;
              skipped) echo "⏭️" ;;
              *) echo "❌" ;;
            esac
          }

          echo "## Pull Request Test Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status | Notes |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Secrets Lint | $(status_icon "${{ needs.secrets-lint.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dependency Review | $(status_icon "${{ needs.dependency-review.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ShellCheck | $(status_icon "${{ needs.lint-shell.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Compose Validate | $(status_icon "${{ needs.lint-compose.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Terraform Validate | $(status_icon "${{ needs.terraform-validate.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Quick Checks | $(status_icon "${{ needs.quick-checks.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backend Tests | $(status_icon "${{ needs.backend-tests.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Frontend Tests | $(status_icon "${{ needs.frontend-tests.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| OPA Tests | $(status_icon "${{ needs.opa-tests.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| K8s Validation | $(status_icon "${{ needs.k8s-validation.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy Dry Run | $(status_icon "${{ needs.deploy-dry-run.result }}") |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Gate on all required checks, including frontend tests.
          if [[ "${{ needs.secrets-lint.result }}" == "success" && \
                ("${{ needs.dependency-review.result }}" == "success" || "${{ needs.dependency-review.result }}" == "skipped") && \
                "${{ needs.lint-shell.result }}" == "success" && \
                "${{ needs.lint-compose.result }}" == "success" && \
                "${{ needs.terraform-validate.result }}" == "success" && \
                ("${{ needs.quick-checks.result }}" == "success" || "${{ needs.quick-checks.result }}" == "skipped") && \
                ("${{ needs.backend-tests.result }}" == "success" || "${{ needs.backend-tests.result }}" == "skipped") && \
                ("${{ needs.frontend-tests.result }}" == "success" || "${{ needs.frontend-tests.result }}" == "skipped") && \
                ("${{ needs.opa-tests.result }}" == "success" || "${{ needs.opa-tests.result }}" == "skipped") && \
                ("${{ needs.k8s-validation.result }}" == "success" || "${{ needs.k8s-validation.result }}" == "skipped") && \
                ("${{ needs.deploy-dry-run.result }}" == "success" || "${{ needs.deploy-dry-run.result }}" == "skipped") ]]; then
            echo "✅ **All critical tests passing** - Ready for review!" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "❌ **Some tests failed** - Please review and fix issues" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
permissions:
  contents: read
