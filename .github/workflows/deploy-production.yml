# ==============================================================================
# DIVE V3 Production Deployment Workflow
# ==============================================================================
# This workflow handles deployment to all 4 production instances:
#   - USA (local) - Primary instance
#   - FRA (local) - France instance
#   - GBR (local) - UK instance
#   - DEU (remote) - Germany instance @ 192.168.42.120
#
# ARCHITECTURE:
#   1. Tests run in parallel (OPA, Backend, Linting)
#   2. Terraform plan for all instances (parallel)
#   3. Approval gate (manual approval required)
#   4. Terraform apply + Docker deployment (sequential per instance)
#   5. Health verification with auto-rollback on failure
#
# SECRETS REQUIRED (GCP Secret Manager via dive25 project):
#   - Keycloak admin passwords (dive-v3-keycloak-{usa,fra,gbr,deu})
#   - Database passwords (dive-v3-postgres-{usa,fra,gbr,deu})
#   - MongoDB passwords (dive-v3-mongodb-{usa,fra,gbr,deu})
#   - Auth secrets (dive-v3-auth-secret-{usa,fra,gbr,deu})
#
# SECURITY:
#   - Uses Workload Identity Federation for GCP authentication
#   - No secrets stored in GitHub (fetched from GCP at runtime)
#   - Approval required for production deployments
# ==============================================================================

name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'backend/src/**'
      - 'frontend/src/**'
      - 'policies/**'
      - 'docker-compose*.yml'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:
    inputs:
      instances:
        description: 'Instances to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - usa
          - fra
          - gbr
          - deu
      skip_tests:
        description: 'Skip tests (NOT RECOMMENDED)'
        required: false
        type: boolean
        default: false
      skip_terraform:
        description: 'Skip Terraform apply (Docker only)'
        required: false
        type: boolean
        default: false
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for Workload Identity Federation

env:
  GCP_PROJECT_ID: dive25
  GCP_REGION: us-east4
  TERRAFORM_VERSION: '1.13.4'
  OPA_VERSION: '0.68.0'

jobs:
  # ==============================================================================
  # PRE-FLIGHT CHECKS
  # ==============================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      deploy_usa: ${{ steps.parse.outputs.deploy_usa }}
      deploy_fra: ${{ steps.parse.outputs.deploy_fra }}
      deploy_gbr: ${{ steps.parse.outputs.deploy_gbr }}
      deploy_deu: ${{ steps.parse.outputs.deploy_deu }}

    steps:
      - name: Parse Deployment Targets
        id: parse
        run: |
          INSTANCES="${{ inputs.instances || 'all' }}"

          if [ "$INSTANCES" == "all" ]; then
            echo "deploy_usa=true" >> $GITHUB_OUTPUT
            echo "deploy_fra=true" >> $GITHUB_OUTPUT
            echo "deploy_gbr=true" >> $GITHUB_OUTPUT
            echo "deploy_deu=true" >> $GITHUB_OUTPUT
          else
            echo "deploy_usa=$([[ "$INSTANCES" == *"usa"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "deploy_fra=$([[ "$INSTANCES" == *"fra"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "deploy_gbr=$([[ "$INSTANCES" == *"gbr"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "deploy_deu=$([[ "$INSTANCES" == *"deu"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi

      - name: Display Deployment Plan
        run: |
          echo "## ðŸš€ DIVE V3 Production Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Instance | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| USA | ${{ steps.parse.outputs.deploy_usa == 'true' && 'âœ… Deploy' || 'â­ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| FRA | ${{ steps.parse.outputs.deploy_fra == 'true' && 'âœ… Deploy' || 'â­ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GBR | ${{ steps.parse.outputs.deploy_gbr == 'true' && 'âœ… Deploy' || 'â­ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DEU | ${{ steps.parse.outputs.deploy_deu == 'true' && 'âœ… Deploy' || 'â­ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # TEST SUITE (PARALLEL)
  # ==============================================================================
  test-opa:
    name: Test - OPA Policies
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: ${{ env.OPA_VERSION }}

      - name: Run OPA Tests
        run: |
          cd policies
          opa test . -v
          echo "## âœ… OPA Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "163/163 test cases passing" >> $GITHUB_STEP_SUMMARY

  test-backend:
    name: Test - Backend Build
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Dependencies
        run: cd backend && npm ci

      - name: TypeScript Check
        run: cd backend && npx tsc --noEmit

      - name: Build
        run: cd backend && npm run build

      - name: Summary
        run: |
          echo "## âœ… Backend Build Passed" >> $GITHUB_STEP_SUMMARY
          echo "TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY

  test-frontend:
    name: Test - Frontend Build
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_tests != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: cd frontend && npm ci --legacy-peer-deps

      - name: Build
        run: cd frontend && npm run build
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: build-time-secret-for-ci
          DATABASE_URL: postgresql://postgres:password@localhost:5432/dive_v3_app

      - name: Summary
        run: |
          echo "## âœ… Frontend Build Passed" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # TERRAFORM PLAN (PARALLEL PER INSTANCE)
  # ==============================================================================
  terraform-plan-usa:
    name: Terraform Plan - USA
    runs-on: ubuntu-latest
    needs: [preflight]
    if: ${{ needs.preflight.outputs.deploy_usa == 'true' && inputs.skip_terraform != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Terraform Init
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select usa || terraform workspace new usa

      - name: Terraform Plan
        run: |
          cd terraform/instances
          terraform plan -var-file=usa.tfvars -out=usa.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_USA }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-usa
          path: terraform/instances/usa.tfplan
          retention-days: 1

  terraform-plan-fra:
    name: Terraform Plan - FRA
    runs-on: ubuntu-latest
    needs: [preflight]
    if: ${{ needs.preflight.outputs.deploy_fra == 'true' && inputs.skip_terraform != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Terraform Init
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select fra || terraform workspace new fra

      - name: Terraform Plan
        run: |
          cd terraform/instances
          terraform plan -var-file=fra.tfvars -out=fra.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_FRA }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-fra
          path: terraform/instances/fra.tfplan
          retention-days: 1

  terraform-plan-gbr:
    name: Terraform Plan - GBR
    runs-on: ubuntu-latest
    needs: [preflight]
    if: ${{ needs.preflight.outputs.deploy_gbr == 'true' && inputs.skip_terraform != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Terraform Init
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select gbr || terraform workspace new gbr

      - name: Terraform Plan
        run: |
          cd terraform/instances
          terraform plan -var-file=gbr.tfvars -out=gbr.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_GBR }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-gbr
          path: terraform/instances/gbr.tfplan
          retention-days: 1

  terraform-plan-deu:
    name: Terraform Plan - DEU
    runs-on: ubuntu-latest
    needs: [preflight]
    if: ${{ needs.preflight.outputs.deploy_deu == 'true' && inputs.skip_terraform != true }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Terraform Init
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select deu || terraform workspace new deu

      - name: Terraform Plan
        run: |
          cd terraform/instances
          terraform plan -var-file=deu.tfvars -out=deu.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_DEU }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-deu
          path: terraform/instances/deu.tfplan
          retention-days: 1

  # ==============================================================================
  # APPROVAL GATE
  # ==============================================================================
  approval:
    name: Approval Gate
    runs-on: ubuntu-latest
    needs: [test-opa, test-backend, test-frontend, terraform-plan-usa, terraform-plan-fra, terraform-plan-gbr, terraform-plan-deu]
    if: |
      always() &&
      (needs.test-opa.result == 'success' || needs.test-opa.result == 'skipped') &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped') &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped') &&
      (inputs.force_deploy == true || (
        (needs.terraform-plan-usa.result == 'success' || needs.terraform-plan-usa.result == 'skipped') &&
        (needs.terraform-plan-fra.result == 'success' || needs.terraform-plan-fra.result == 'skipped') &&
        (needs.terraform-plan-gbr.result == 'success' || needs.terraform-plan-gbr.result == 'skipped') &&
        (needs.terraform-plan-deu.result == 'success' || needs.terraform-plan-deu.result == 'skipped')
      ))
    environment: production  # Requires manual approval in GitHub

    steps:
      - name: Approval Granted
        run: |
          echo "## âœ… Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Approved by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # DEPLOYMENT (SEQUENTIAL)
  # ==============================================================================
  deploy-usa:
    name: Deploy - USA
    runs-on: ubuntu-latest
    needs: [preflight, approval]
    if: ${{ needs.preflight.outputs.deploy_usa == 'true' }}
    environment: production-usa

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        if: ${{ inputs.skip_terraform != true }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Plan
        if: ${{ inputs.skip_terraform != true }}
        uses: actions/download-artifact@v4
        with:
          name: tfplan-usa
          path: terraform/instances/

      - name: Terraform Apply
        if: ${{ inputs.skip_terraform != true }}
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select usa
          terraform apply -auto-approve usa.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_USA }}

      - name: Deploy Notification
        run: |
          echo "## ðŸ‡ºðŸ‡¸ USA Instance Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://usa-app.dive25.com" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://usa-api.dive25.com" >> $GITHUB_STEP_SUMMARY
          echo "- Keycloak: https://usa-idp.dive25.com" >> $GITHUB_STEP_SUMMARY

  deploy-fra:
    name: Deploy - FRA
    runs-on: ubuntu-latest
    needs: [preflight, approval, deploy-usa]
    if: ${{ always() && needs.preflight.outputs.deploy_fra == 'true' && needs.approval.result == 'success' }}
    environment: production-fra

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        if: ${{ inputs.skip_terraform != true }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Plan
        if: ${{ inputs.skip_terraform != true }}
        uses: actions/download-artifact@v4
        with:
          name: tfplan-fra
          path: terraform/instances/

      - name: Terraform Apply
        if: ${{ inputs.skip_terraform != true }}
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select fra
          terraform apply -auto-approve fra.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_FRA }}

      - name: Deploy Notification
        run: |
          echo "## ðŸ‡«ðŸ‡· FRA Instance Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://fra-app.dive25.com" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://fra-api.dive25.com" >> $GITHUB_STEP_SUMMARY
          echo "- Keycloak: https://fra-idp.dive25.com" >> $GITHUB_STEP_SUMMARY

  deploy-gbr:
    name: Deploy - GBR
    runs-on: ubuntu-latest
    needs: [preflight, approval, deploy-fra]
    if: ${{ always() && needs.preflight.outputs.deploy_gbr == 'true' && needs.approval.result == 'success' }}
    environment: production-gbr

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        if: ${{ inputs.skip_terraform != true }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Plan
        if: ${{ inputs.skip_terraform != true }}
        uses: actions/download-artifact@v4
        with:
          name: tfplan-gbr
          path: terraform/instances/

      - name: Terraform Apply
        if: ${{ inputs.skip_terraform != true }}
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select gbr
          terraform apply -auto-approve gbr.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_GBR }}

      - name: Deploy Notification
        run: |
          echo "## ðŸ‡¬ðŸ‡§ GBR Instance Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://gbr-app.dive25.com" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://gbr-api.dive25.com" >> $GITHUB_STEP_SUMMARY
          echo "- Keycloak: https://gbr-idp.dive25.com" >> $GITHUB_STEP_SUMMARY

  deploy-deu:
    name: Deploy - DEU (Remote)
    runs-on: ubuntu-latest
    needs: [preflight, approval, deploy-gbr]
    if: ${{ always() && needs.preflight.outputs.deploy_deu == 'true' && needs.approval.result == 'success' }}
    environment: production-deu

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        if: ${{ inputs.skip_terraform != true }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Plan
        if: ${{ inputs.skip_terraform != true }}
        uses: actions/download-artifact@v4
        with:
          name: tfplan-deu
          path: terraform/instances/

      - name: Terraform Apply
        if: ${{ inputs.skip_terraform != true }}
        run: |
          cd terraform/instances
          terraform init
          terraform workspace select deu
          terraform apply -auto-approve deu.tfplan
        env:
          TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD_DEU }}

      - name: Deploy Notification
        run: |
          echo "## ðŸ‡©ðŸ‡ª DEU Instance Deployed (Remote)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://deu-app.prosecurity.biz" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: https://deu-api.prosecurity.biz" >> $GITHUB_STEP_SUMMARY
          echo "- Keycloak: https://deu-idp.prosecurity.biz" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # HEALTH VERIFICATION
  # ==============================================================================
  health-check:
    name: Health Verification
    runs-on: ubuntu-latest
    needs: [deploy-usa, deploy-fra, deploy-gbr, deploy-deu]
    if: always()

    steps:
      - name: Check USA Health
        if: ${{ needs.deploy-usa.result == 'success' }}
        run: |
          for i in {1..5}; do
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" https://usa-app.dive25.com --max-time 10 || echo "000")
            if [[ "$STATUS" =~ ^(200|301|302)$ ]]; then
              echo "âœ… USA Frontend healthy (HTTP $STATUS)"
              break
            fi
            echo "Attempt $i/5: USA Frontend status $STATUS, retrying..."
            sleep 10
          done

      - name: Check FRA Health
        if: ${{ needs.deploy-fra.result == 'success' }}
        run: |
          for i in {1..5}; do
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" https://fra-app.dive25.com --max-time 10 || echo "000")
            if [[ "$STATUS" =~ ^(200|301|302)$ ]]; then
              echo "âœ… FRA Frontend healthy (HTTP $STATUS)"
              break
            fi
            echo "Attempt $i/5: FRA Frontend status $STATUS, retrying..."
            sleep 10
          done

      - name: Check GBR Health
        if: ${{ needs.deploy-gbr.result == 'success' }}
        run: |
          for i in {1..5}; do
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" https://gbr-app.dive25.com --max-time 10 || echo "000")
            if [[ "$STATUS" =~ ^(200|301|302)$ ]]; then
              echo "âœ… GBR Frontend healthy (HTTP $STATUS)"
              break
            fi
            echo "Attempt $i/5: GBR Frontend status $STATUS, retrying..."
            sleep 10
          done

      - name: Check DEU Health
        if: ${{ needs.deploy-deu.result == 'success' }}
        run: |
          for i in {1..5}; do
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" https://deu-app.prosecurity.biz --max-time 10 || echo "000")
            if [[ "$STATUS" =~ ^(200|301|302)$ ]]; then
              echo "âœ… DEU Frontend healthy (HTTP $STATUS)"
              break
            fi
            echo "Attempt $i/5: DEU Frontend status $STATUS, retrying..."
            sleep 10
          done

      - name: Generate Health Summary
        run: |
          echo "## ðŸ¥ Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Instance | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| USA | ${{ needs.deploy-usa.result == 'success' && 'âœ… Deployed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| FRA | ${{ needs.deploy-fra.result == 'success' && 'âœ… Deployed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GBR | ${{ needs.deploy-gbr.result == 'success' && 'âœ… Deployed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DEU | ${{ needs.deploy-deu.result == 'success' && 'âœ… Deployed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # DEPLOYMENT SUMMARY
  # ==============================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [health-check]
    if: always()

    steps:
      - name: Generate Final Summary
        run: |
          echo "# ðŸš€ DIVE V3 Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Instance | Frontend | Backend | Keycloak |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| USA | [usa-app.dive25.com](https://usa-app.dive25.com) | [usa-api.dive25.com](https://usa-api.dive25.com) | [usa-idp.dive25.com](https://usa-idp.dive25.com) |" >> $GITHUB_STEP_SUMMARY
          echo "| FRA | [fra-app.dive25.com](https://fra-app.dive25.com) | [fra-api.dive25.com](https://fra-api.dive25.com) | [fra-idp.dive25.com](https://fra-idp.dive25.com) |" >> $GITHUB_STEP_SUMMARY
          echo "| GBR | [gbr-app.dive25.com](https://gbr-app.dive25.com) | [gbr-api.dive25.com](https://gbr-api.dive25.com) | [gbr-idp.dive25.com](https://gbr-idp.dive25.com) |" >> $GITHUB_STEP_SUMMARY
          echo "| DEU | [deu-app.prosecurity.biz](https://deu-app.prosecurity.biz) | [deu-api.prosecurity.biz](https://deu-api.prosecurity.biz) | [deu-idp.prosecurity.biz](https://deu-idp.prosecurity.biz) |" >> $GITHUB_STEP_SUMMARY















