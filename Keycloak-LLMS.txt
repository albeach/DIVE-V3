===== KEYCLOAK CHANGELOG / UPGRADE NOTES (VERBATIM EXTRACT) =====
Source: Keycloak-Updates.md (user upload)
NOTE: Content below is an exact copy. No paraphrasing or simplification.
=================================================================

Upgrade the Keycloak Client Libraries (Admin client, Authorization client, Policy enforcer). These are released independently of the Keycloak server and could be typically updated independently of the Keycloak server as the last released version of the client libraries should be compatible with the last released version of the Keycloak server. For more information, see the Upgrading Keycloak Client libraries.

Migration Changes
Edit this section
Report an issue
Migrating to 26.4.2
Breaking changes
Edit this section
Report an issue
Breaking changes are identified as those that might require changes for existing users to their configurations or applications. In minor or patch releases, Keycloak will only introduce breaking changes to fix bugs.

Corrected encoding when sending OpenID Connect client secrets when acting as a broker
In a scenario where Keycloak acts as a broker and connects via OpenID Connect to another identity provider, it now sends the client credentials via basic authentication in the correct encoding as specified in RFC6749. You are not affected if you configured Keycloak to send the credentials in the request body.

This prevents problems with client IDs or passwords that contain, for example, a colon or a percentage sign.

To revert to the old behavior, change the client authentication to the deprecated option Client secret sent as HTTP Basic authentication without URL encoding (client_secret_basic_unencoded).

Deprecated features
The following sections provide details on deprecated features.

Sending OpenID Connect client secret via basic authentication without URL encoding
In a scenario where Keycloak acts as a broker and connects via OpenID Connect to another identity provider, you can choose to send the client secret as Client secret sent as HTTP Basic authentication without URL encoding (client_secret_basic_unencoded). While this violates RFC6749, it can be used to keep the default behavior of earlier versions of Keycloak.

This behavior is deprecated and will be removed in a future version of Keycloak.

Migrating to 26.4.1
Notable changes
Edit this section
Report an issue
Notable changes where an internal behavior changed to prevent common misconfigurations, fix bugs or simplify running Keycloak.

User sessions created with "Remember Me" are no longer valid if "Remember Me" is disabled for the realm
When the "Remember Me" option is disabled in the realm settings, all user sessions previously created with the "Remember Me" flag are now considered invalid. Users will be required to log in again, and any associated refresh tokens will no longer be usable. User sessions created without selecting "Remember Me" are not affected.

Migrating to 26.4.0
Breaking changes
Edit this section
Report an issue
Breaking changes are identified as those that might require changes for existing users to their configurations or applications. In minor or patch releases, Keycloak will only introduce breaking changes to fix bugs.

acr_values request parameter is not forwarded automatically to identity providers
The acr_values request parameter is no longer automatically forwarded to OpenID Connect identity providers during authentication. This change enhances security by preventing unintended disclosure of authentication context information to external IDPs.

If you are relying on the acr_values parameter to be propagated to an identity provider, you must now explicitly set acr_values request parameter to the Forwarded query parameters setting in the identity provider configuration.

Configuration changes for additional datasources
In previous releases, the only possible way to configure additional datasources was using raw Quarkus properties that are generally considered unsupported. At the same time, adding additional datasources was supported which led to unclear situation.

To provide a supported and user-friendly way to configure additional datasources, we introduced new dedicated server options for that. Configuring additional datasources using the original approach via the Quarkus properties is considered unsupported starting with this release.

Check the following examples on how to migrate your configuration:

1. Use new Keycloak options (preferred)
The supported way to configure additional datasources is by using the new configuration options.

You can migrate from this configuration in conf/quarkus.properties:

quarkus.datasource.user-store.db-kind=postgresql
quarkus.datasource.user-store.username=my-username
quarkus.datasource.user-store.jdbc.url=jdbc:postgresql://my-remote-postgres:5432/user-store
quarkus.datasource.user-store.jdbc.transactions=xa
to this configuration in conf/keycloak.conf:

db-kind-user-store=postgres
db-username-user-store=my-username
db-url-full-user-store=jdbc:postgresql://my-remote-postgres:5432/user-store
# transactions XA is enabled by default for datasources
For more information about the datasource options, check the Configure multiple datasources guide.

2. Remove quoting in quarkus.properties (unsupported)
If you are not able to migrate to the Keycloak datasource options right now, remove the additional datasource name quoting to avoid a clash of the datasource options mapping to prevent any issue.

It means that you should migrate your configuration in conf/quarkus.properties:

quarkus.datasource."user-store".db-kind=postgresql
quarkus.datasource."user-store".username=my-username
to a version without the quotation:

quarkus.datasource.user-store.db-kind=postgresql
quarkus.datasource.user-store.username=my-username
Notable changes
Notable changes may include internal behavior changes that prevent common misconfigurations, bugs that are fixed, or changes to simplify running Keycloak.

Supported Databases Versions
The supported version of each database is now shown in Configuring the database.

It is not a supported configuration if the underlying database specific Hibernate dialect allows the use of a version that differs from those shown.

From 26.3 to 26.4 the support changed as follows:

Database	Minimum support	Dialect minimum
MariaDB

10.4 (LTS) → 10.6 (LTS)

10.4 (LTS) → 10.6 (LTS)

PostgreSQL

Remained 13.x

12.x → 13.x

Amazon Aurora PostgreSQL

Remained 15.x

12.x → 13.x

Microsoft SQLServer

Remained 2019

2012 → 2014

Usage of the exact request parameter when searching users by attributes
If you are querying users by attributes through the User API where you want to fetch users that match a specific attribute key (regardless the value), consider setting the exact request parameter to false when invoking the /admin/realms/{realm}/users using the GET method.

For instance, searching for all users with the attribute myattribute set should be done as follows:

GET /admin/realms/{realm}/users?exact=false&q=myattribute:
The Keycloak Admin Client is also updated with a new method to search users by attribute using the exact request parameter.

Automatic database connection properties for the PostgreSQL driver
When running PostgreSQL reader and writer instances, Keycloak needs to always connect to the writer instance to do its work.

Starting with this release, and when using the original PostgreSQL driver, Keycloak sets the targetServerType property of the PostgreSQL JDBC driver to primary to ensure that it always connects to a writable primary instance and never connects to a secondary reader instance in failover or switchover scenarios.

You can override this behavior by setting your own value for targetServerType in the DB URL or additional properties.

Bouncy Castle libraries updated to 2.1.x
If you are running Keycloak in FIPS 140-2 mode, note to update your Bouncy Castle libraries to the versions listed in the release documentation.

With the upgrade to Bouncy Castle 2.1.x, EdDSA is now supported in FIPS 140-2 mode.

Creating remote caches automatically on the first startup
When using remote caches, Keycloak now automatically creates the necessary caches during startup if they do not already exist on the Infinispan server.

For a multi-cluster setup, it is still recommended to create the caches using Cache CRs in advance to verify the correct initialization of the caches and to avoid start-up errors while the caches are present in only one of the sites.

MySQL and MariaDB wait_timeout validation
In order to prevent connections being closed unexpectedly by the database server, it is necessary to ensure that the Keycloak connection pool is correctly configured with respect to the server’s wait_timeout setting.

Starting with this release, Keycloak defines a default db-pool-max-lifetime of 7 hours and 50 minutes for MySQL and MariaDB databases as the default wait_timeout is 8 hours.

If the server defines a wait_timeout which is greater than the default, or provided, db-pool-max-lifetime value, then a warning will be logged on Keycloak startup.

Cache configuration removed from cache-ispn.xml
The conf/cache-ispn.xml file no longer contains the default cache configurations. You can still overwrite the cache configurations used by Keycloak in this file, however Keycloak logs a warning if the --cache-config-mutate=true option is not set. You can still add custom caches without setting this option.

When upgrading an existing deployment, remove all default cache configurations from your existing conf/cache-ispn.xml and use the --cache-... options to make changes for example to the cache sizes.

RFC8414 compliant lookup of metadata
Keycloak now exposes an RFC8414-compliant endpoint at the root URL level /.well-known/ to allow clients to discover OAuth 2.0 Authorization Server Metadata and other well-known providers by the issuer URL.

As an example, OAuth 2.0 Authorization Server Metadata information was exposed by this URL:

https://keycloak.example.com/realms/{realm}/.well-known/oauth-authorization-server
It is now available also by this URL:

https://keycloak.example.com/.well-known/oauth-authorization-server/realms/{realm}
To benefit from this, expose the path /.well-known/ in your reverse proxy configuration.

If a http-relative-path is configured, configure a reverse proxy to map the /.well-known/ path to the path with the prefix on the server.
Operator default affinity configuration changed
The default scheduling strategy has been updated so that a topology spread constraint is created for both zones and nodes in order to increase availability in the presence of failures. Previously, the default strategy preferred that all nodes were deployed to the same availability zone. For more details, see the High Availability Guide.

JGroups system properties replaced with CLI options
Previously, configuring JGroups network addresses and ports required that you use the jgroups.bind.* and jgroups.external_* system properties. This release introduces the following CLI options to allow these addresses and ports to be configured directly by Keycloak:

cache-embedded-network-bind-address

cache-embedded-network-bind-port

cache-embedded-network-external-address

cache-embedded-network-external-port.

Configuring ports using the old properties has not changed, but using the CLI options is recommended because the previous method could be deprecated.

Internal representation of client sessions changed
The cache key of the authenticated client sessions has changed for embedded Infinispan, while the public APIs have not changed. Due to this, you should not run 26.4.x concurrently in a cluster with previous versions.

External IDP tokens automatically refreshed
When using the /realms/{realm-name}/broker/{provider_alias}/token endpoint for an OAuth 2.0 IDP that provides refresh tokens and JSON responses or for OIDC IDPs, the tokens will be automatically refreshed each time they are retrieved via the endpoint if the access token has expired and the IDP provided a refresh token.

When using GitHub as an IDP, you can now enable JSON responses to leverage the token refresh for this endpoint.

Persistent User Session Batching Disabled
The batching of persistent user session updates has been turned off by default because it negatively impacts performance with some database vendors, which offsets the benefits with other database vendors. You can enable batching by using the CLI option --spi-user-sessions—​infinispan—​use-batches=true, but users are encouraged to load test their environment to verify performance improvements.

Required field in User Session note mapper
The name of the session note is now shown as a required field in the Admin Console.

Required field in OIDC attribute mapper
The name of the token claim is now shown as a required field in the Admin Console.

Volatile user sessions affecting offline session memory requirements
Starting with this release, Keycloak caches by default only 10,000 entries for offline user and client sessions in memory when volatile user sessions are enabled. This change greatly reduces memory usage.

To change the size of the offline session caches, use the cache-embedded-offline-sessions-max-count and cache-embedded-offline-client-sessions-max-count options.

Translation resource bundle file names
The naming of resource bundles in classloader and folder based themes is now aligned with Java ResourceBunndle#getBundle file names. For all included community languages, such as de or pt-BR, a file is still named messages_de.properties or messages_pt_BR.properties. If you added custom language code, check if your file names are still the same.

The "Chinese (traditional)" and "Chinese (simplified)" languages are named for historical reasons zh-TW and zh-CN in the community themes of Keycloak. As a start to migrate to the new language codes, zh-Hant and zh-Hans, the classloader and folder based themes pick up for the old language codes zh-TW and zh-CN and also the messages_zh_Hant.properties and messages_zh_Hant.properties files. Entries in messages_zh_Hant.properties take precedence over entries in messages_zh_TW.properties, and entries in messages_zh_Hans.properties take precedence over entries in messages_zh_CN.properties.

Update Email Feature is now supported
Update Email is now a supported feature so it is now enabled during the server startup. The feature is enabled for a realm if the Update Email required action is enabled in the realm. The feature slightly changes behavior from previous versions when updating the profile during the authentication flow (such as when running the UPDATE_PROFILE required action). If a user has an email set when updating the profile during the authentication flow, the email attribute is not available.

New database index on the EVENT_ENTITY table
The EVENT_ENTITY table now has an index IDX_EVENT_ENTITY_USER_ID_TYPE on the columns USER_ID, TYPE and EVENT_TIME, which allows a faster search in the Admin Console for events of a specific user and event type.

If the table contains more than 300,000 entries, Keycloak skips the index creation during the automatic schema migration. However, the SQL statement appears on the console during migration so you can apply it manually after Keycloak startup. For details on configuring a different limit, see Migrating the database.

Encryption algorithms for SAML updated
When a SAML client was enabled to Encrypt Assertions, the assertion included in the SAML response was encrypted following the XML Encryption Syntax and Processing specification. The algorithms used for encryption were fixed and outdated. Starting with this release, default encryption options are up to date and better suited in terms of security. In addition, if a specific client needs a different algorithm, you can configure the encryption details. You define new attributes in the client to specify the exact algorithms used for encryption. In the Admin Console, when Encrypt Assertions is enabled in the Keys tab, these attributes appear in the client Settings tab, Signature and Encryption section.

To maintain backwards compatibility, the Keycloak upgrade modifies the existing SAML clients to set the encryption attributes to work as before. As a result, existing clients receive the same encrypted assertion using the same previous algorithms. If the client supports the new default configuration, removing the attributes is recommended.

For more information about client configuration, see Creating a SAML client.

Validate email action
When validating an email address as a required action or an application initiated action, a user can resend the verification email by default only every 30 seconds, while in earlier versions no limitation existed for re-sending the email.

Administrators can configure the interval per realm in the Verify Email required action in the Authentication section of the realm.

Tracing extended for embedded Infinispan caches
When tracing is enabled, calls to other nodes of a Keycloak cluster now create spans in the traces.

To disable this kind of tracing, set the option tracing-infinispan-enabled to false.

LDAP Connection default timeout
If no value is specified either on the LDAP configuration as the connectionTimeout or by the com.sun.jndi.ldap.connect.timeout system property, the default timeout is 5 seconds. This timeout ensures that requests will see errors rather than indefinite waits in obtaining an LDAP connection from the pool or when making a connection to the LDAP server.

Login theme optimized for OTP and recovery code entry
The input fields in the login theme for OTP and recovery codes and have been optimized:

The input mode is now numeric, which will ease the input on mobile devices.

The auto-complete is set to one-time-code to avoid interference with password managers.

Maximum length of the parameters in the OIDC authentication request
When the OIDC authentication request (or OAuth2 authorization request) is sent, a new limit exists for the maximum length of every standard OIDC/OAuth2 parameter. The maximum length of each standard parameter is 4,000 characters, which is a very large number that may be lowered in a future release. For now, it remains large for backwards compatibility. The only exception is the login_hint parameter, which has maximum length of 255 characters. This value is aligned with the maximum length for the username and email attributes configured in the default user profile configuration.

If you want to increase or lower those numbers, start the server with the option req-params-default-max-size for the default maximum length of the standard OIDC/OAuth2 parameters or you can use something such as req-params-max-size for one specific parameter. For more details, see the login-protocol provider configuration in the All provider configuration Guide.

UTF-8 management in the email sender
Starting with this release, Keycloak adds a new option allowutf8 for the realm SMTP configuration (Allow UTF-8 field inside the Email tab in the Realm settings section of the Admin Console). For more information about email configuration, see Configuring email for a realm.

Enabling the option encodes email addresses in UTF-8 when sending them, but it depends on the SMTP server to also support UTF-8 by the SMTPUTF8 extension. If Allow UTF-8 is disabled, Keycloak will encode the domain part of the email address (second part after @) using punycode if non-ASCII characters are used, and will reject email addresses that use non-ASCII characters in the local part. The built-in User Profile email validator also checks that the local part of the address contains only ASCII characters when this option is disabled, avoiding the registration of emails that cannot be used by the SMTP configuration.

If you have an SMTP server configured for your realm, perform the following migration after the upgrade:

If your SMTP server supports SMTPUTF8, enable the Allow UTF-8 option.

If your SMTP server does not support SMTPUTF8:

Keep the Allow UTF-8 option disabled.

Verify that no email addresses of users have non-ASCII characters in the local part of the email address. If you detect emails with non-ASCII characters in the local part, you can use the Verify Profile action to force the user to modify the email after the upgrade.

Aligning the count of users with the actual number of users returned from searches
When searching for users in the Admin Console or by the User API, the count of users returned from the /admin/realms/{realm}/users/count endpoint is now aligned with the actual number of users returned when executing searches by /admin/realms/{realm}/users.

If you are relying on the users count endpoint, make sure to review your clients so that they expect the users count to be aligned with the actual number of users returned from searches.

Welcome Page changes
The Welcome Page creates regular Admin users instead of temporary ones.

Fine-grained admin permissions: new reset-password scope for Users
The fine-grained admin permissions (FGAP) feature now includes a new scope: reset-password. This scope allows for specific permissions to be granted to administrators to reset a user’s password without granting them broader manage scope.

By default, a user with the existing, broader manage scope for the USERS resource type will implicitly have permission to reset a user’s password. The system checks for the explicit reset-password scope first. If that permission is not found, it falls back to checking if the administrator has the manage scope. This ensures that existing administrators with the manage scope continue to have the ability to reset passwords without any changes to their permissions.

This implicit fallback mechanism ensures a smooth upgrade process for deployments already using fine-grained permissions. The fallback will be deprecated and removed in a future releases, so it is recommended to review and update administrator permissions to use the new reset-password scope where appropriate.

For more information about fine-grained admin permissions, see Delegating realm administration using permissions.

Re-created indexes on the CLIENT_ATTRIBUTES and GROUP_ATTRIBUTE tables
In some previous versions of Keycloak, the EnterpriseDB (EDB) was considered unsupported. This has now changed and EDB Advanced is supported starting with this release. If the EDB JDBC driver was used for connecting to EDB in previous versions, some invalid schema changes were applied to the database. To mitigate this, some indexes are automatically re-created during the schema migration to this version. This affects you if you are using a Postgres database (including EDB), regardless if you used EDB with previous releases.

This affects indexes on the CLIENT_ATTRIBUTES and GROUP_ATTRIBUTE tables. If those tables contain more than 300000 entries, Keycloak will skip the index creation by default during the automatic schema migration and instead log the SQL statement on the console during migration to be applied manually after Keycloak’s startup. See the Upgrading Guide for details on how to configure a different limit.

Errors when searching users from LDAP will not fail the request anymore and local users will be returned
Until now, failures when searching for users from an LDAP user federation provider caused the whole request to fail and no users were returned. In this release, if an error occurs during the search, local users will still be returned and the error will be logged at the ERROR level, so that administrators can investigate the root cause of the problem and fix any issue with their LDAP configuration or connectivity with the LDAP server.

This change improves the resilience of the system when there are temporary issues with the LDAP server, ensuring that local users can still be accessed even if the LDAP search fails. If a local user is linked to a failing LDAP provider, the user will be marked as disabled and read-only until the LDAP server is available again.

The serverinfo endpoint only returns the system info for administrators in the administrator realm
Starting with this version, the serverinfo endpoint, which is used by the admin console to obtain some general information of the Keycloak installation, will only return the system information for administrators in the administration (master) realm. This change was done for security reasons.

If, for whatever reason, an administrator in a common realm needs to access the systemInfo, cpuInfo or memoryInfo fields of the serverinfo response, you need to create and assign a new view-system role to that admin user:

In the affected realm, select the management client realm-management, and, in the Roles tab, create a new role called view-system.

In Users select the administrator account, and, in the Role mapping tab, assign the just created view-system client role to the admin user.

The previous workaround is marked as deprecated and it can be removed in a future version of Keycloak.

Refactoring to SimpleHttp
The SimpleHttp util in the server-spi-private module was refactored and moved to the org.keycloak.http.simple package.

Deprecated features
The following sections provide details on deprecated features.

displayTest field in ConsentScopeRepresentation
The displayTest field in the ConsentScopeRepresentation class returned by the Account REST service has been deprecated due to a typo in its name. A new field displayText with the correct spelling has been added to replace it. The old field will be removed in Keycloak 27.0. The Typescript code ConsentScopeRepresentation for the Account Console already contains only the new field.

Lifetime of offline session caches
The options --spi-user-sessions--infinispan--offline-session-cache-entry-lifespan-override and --spi-user-sessions--infinispan--offline-client-session-cache-entry-lifespan-override are now deprecated for removal.

As an alternative, use the cache-embedded-offline-sessions-max-count and cache-embedded-offline-client-sessions-max-count options to limit the memory usage if the default of 10,000 cache offline user and client sessions does not work in your scenario.

Timestamp in the AuthenticatedClientSessionModel
The timestamp of the last refresh token update of OpenID Connect clients is currently available via AuthenticatedClientSessionModel#getTimestamp() and AuthenticatedClientSessionModel#setTimestamp().

This is now deprecated for removal without a replacement.

Passkeys Conditional UI Authenticator requires a feature
The Passkeys Conditional UI Authenticator authenticator was deprecated in the version 26.3.0, but you can still use it if you enable passkeys_conditional_ui_authenticator during server startup. As a result, you can re-configure authentication flows for passkeys authentication as described in Passkeys. Nonetheless, both this startup option and the Passkeys Conditional UI Authenticator are deprecated.

Modifying default cache configurations in the cache config file
All Keycloak default cache configurations have been removed from conf/cache-ispn.xml. Configuration of the default cache configurations in conf/cache-ispn.xml, or in a custom file by --cache-config-file, without specifying --cache-config-mutate=true is now deprecated and will log a warning.

In a future major release, the start-up will fail if default cache configurations are stated in those files and the option is not specified.

Simplified API for UserSessionProvider
In order to retrieve a client session via UserSessionProvider#getClientSession, you no longer need to pass in the client session ID. The old methods have been deprecated and will be removed in a future release. You should also review the other methods that are deprecated for removal in this class.

Simplified API for AuthenticatedClientSessionModel
The clientId note in the authenticated client session is an internal note present only when using the embedded caches, and is now deprecated for removal. Instead, use the getClient() method.

Migrating to 26.3.0
Breaking changes
Edit this section
Report an issue
Breaking changes are identified as requiring changes from existing users to their configurations. In minor or patch releases, we will only do breaking changes to fix important bugs.

Reading information about temporarily locked users
In previous releases there was an inconsistency in the REST endpoint result of getting a user (GET /admin/realms/{realm}/users/{user-id}) and searching for a user (GET /admin/realms/{realm}/users). When BruteForce is enabled and a user was temporarily locked out the former endpoint would return enabled=false while the latter would return enabled=true. If the user was updated and enabled was false due to temporary lockout then the user would be disabled permanently. Both endpoints now return enabled=true when a user is temporarily locked out. To check whether a user is temporarily locked out the BruteForceUserResource endpoint should be utilised (GET /admin/realms/{realm}/attack-detection/brute-force/users/{userId}).

User searches through the User API are now respecting the user profile settings
When querying users through the User API, the user representation and their attributes are now taking into account the user profile settings defined for the realm.

It might happen that attributes in user representations are no longer available depending on the user profile configuration where too much information was returned in the past.

Notable changes
Notable changes where an internal behavior changed to prevent common misconfigurations, fix bugs or simplify running Keycloak.

Different credentials of a user need to have different names
When adding an OTP, WebAuthn or any other 2FA credentials, the name the user assigns to this credential needs to be unique for the given user. This allows the user to distinguish between those credentials, and either update or delete them later. If a user tries to create a credential with an already existing name, there is an error message and the user is asked to change the name of the new credential.

Restrict admin role mappings to server administrators
To enhance security, only users with the admin role in the master realm (server admins) can assign admin roles. This ensures that critical permissions cannot be delegated by realm-level administrators.

Problematic cache configurations ignored
Previous versions of Keycloak warned about problematic configurations, for example, if a wrong number of owners was configured or a cache size was set when it should not have been set when enabling volatile user sessions. The docs also stated to update the cache-ispn.xml configuration file for volatile user sessions.

The current version will always use safe settings for the number of owners and maximum cache size for the affected user and client session caches, and will log only an INFO message. With this behavior, there is no need any more to update the cache-ispn.xml configuration file. If you previously used a custom cache-ispn.xml in order to use volatile user sessions, we recommend reverting those changes and use the standard configuration file.

Email verification is now automatically set when using a OpenID Connect broker with Trust email is enabled and Sync Mode is FORCE
Until now, the OpenID Connect broker did not support the standard email_verified claim available from the ID Tokens issued by OpenID Connect Providers.

In this release, the broker was updated to respect the value from this claim to set the email verification status for the federated (local) user account. Whenever users are federated for the first time or re-authenticating, if the Trust email setting is enabled and Sync Mode is set to FORCE, the user account will be updated to (un)mark the email as verified. If the provider does not send the claim, it defaults to the original behavior and sets the email as verified.

In the future, we might evaluate changing this specific configuration to avoid automatic updates on the email verification status on federated user accounts depending on the use cases and the demand from the community.

Verify existing account by Email is only executed for the email and username sent by the identity provider
The execution Verify Existing Account By Email is one of the alternatives that the First Login Flow has to allow a brokering account to be linked to an existing Keycloak user. This step is executed when the user logs in into Keycloak through the broker for the first time, and the identity provider account is already present in Keycloak. The execution sends an email to the current Keycloak address in order to confirm the user controls that account.

Since this release, the Verify Existing Account By Email execution is only attempted in the First Login Flow if the linking attributes (email and username) sent by the external identity provider are not modified by the user during the review process. This new behavior avoids sending verification emails to an existing Keycloak account that can inadvertently accept the linking.

In case the provider needs to modify the information sent by the identity provider (because emails or usernames are different in the broker), only the other alternative Verify Existing Account By Re-authentication is available to link the new account to the existing Keycloak user.

If the data received from the identity provider is mandatory and cannot be modified, then the Review Profile step in the First Login Flow can be disabled to avoid any user intervention.

For more information, see the First login flow section of the Server Administration Guide.

Signing out from other devices now disabled by default
Previously, when a user updated their credentials, like changing their password or adding another factor like an OTP or Passkey, they had a checkbox Sign out from other devices which was checked by default. Since this release, Keycloak displays the checkbox Sign out from other devices not checked by default. This checkbox should now be intentionally enabled by the user to logout all the other related sessions associated to the same user.

Signing out from other devices logs out offline sessions
Related to the previous point, in previous versions, the Sign out from other devices checkbox logged out only regular sessions. Starting with this release, it logs out also offline sessions as this is what users would expect to happen given the current screen design.

To revert to the old behavior, enable the deprecated feature logout-all-sessions:v1. This deprecated feature will be removed in a future version.

Updates to the user-profile-commons.ftl theme template
The user-profile-commons.ftl changed to improve support for localization. See https://github.com/keycloak/keycloak/issues/38029. As a result, and if you are extending this template, pages might start displaying a locale field. To avoid that, update the theme template with the changes aforementioned.

Subgroup counts are no longer cached
When returning subgroups of a group, the count of subgroups of each subgroup of a group is no longer cached. With the introduction of Fine-Grained Admin Permissions, the result set is filtered at the database level based on any permissions defined to a realm so that the count will change accordingly to these permissions.

Instead of caching the count, a query will be executed every time to obtain the expected number of groups an administrator can access.

Most of the time, this change will not impact clients querying the API to fetch the subgroups of a group. However, if not the case, a new parameter subGroupsCount was introduced to the following endpoints:

/realms/{realm}/groups/{id}/children

/realms/{realm}/groups

With this parameter, clients can decide whether the count should be returned to each individual group returned. To not break existing deployments, this parameter defaults to true so that the count is returned if the parameter is not set.

Upgrade procedure changed for the distribution
If you are upgrading Keycloak by downloading the distribution, the upgrade procedure has been changed. Previously it recommended copying over the contents from the conf/ folder from the old to the new installation. The new procedure recommends to re-apply any changes to cache-ispn.xml or a custom cache configuration based on the file included in the new version.

This prevents accidentally downgrading functionality, for example, by using an old cache-ispn.xml file from a previous version.

Default browser flow changes 2FA to include WebAuthn and Recovery Codes
Previously the default browser flow had a Browser - Conditional OTP conditional sub-flow that enabled One-Time Password (OTP) as a 2nd Factor Authentication (2FA). Starting with this version, the sub-flow is renamed to Browser - Conditional 2FA, the OTP Form is Alternative, and includes two more 2FA methods: WebAuthn Authenticator and Recovery Authentication Code Form. Both new executions are Disabled by default, but they can be set to Alternative to include them into the flow.

Upgraded realms will not be changed. The updated flow will only be available for new realms. Take this change into consideration if you have automated the realm creation.

Syslog counting framing now enabled based on protocol
Syslog messages sent over tcp (or ssl-tcp) protocol now use counting framing by default, prefixing messages with their size as required by some Syslog servers.

To change this behavior, use the --log-syslog-counting-framing option with one of the following values: protocol-dependent (default), true, or false.

Deprecated features
The following sections provide details on deprecated features.

SPI options separating the provider with a single dash
SPI options ending in -enabled, -provider-default, or -provider are treated as build-time options. However, in some instances, this was not correct as a provider could have a configuration property ending in one of those suffixes as well.

To resolve this ambiguity, and any potential ambiguity involving SPI and provider names, a new SPI option format was introduced where the scopes and suffix are separated by --(double dash) instead of -(dash). The new format then reads as spi-<spi-name>--<provider-name>--....

An SPI property ending in -enabled, -provider-default, or -provider should use the new format or else a warning will be emitted. For example spi-<spi-name>--<provider-name>--enabled will be recognized as a build-time option without a warning.

For instance, the correct way to reference your custom email template is: --spi-email-template--mycustomprovider--enabled (not --spi-email-template-mycustomprovider-enabled).

Options using the legacy format and ending in -enabled, -provider-default, or -provider will still be treated as a build-time option, but may not be in future releases.

Kubernetes cache stack has been deprecated
The kubernetes cache stack has been deprecated and will be removed in a future release. Users should transition to the jdbc-ping stack.

Consequently, the Keycloak Operator now uses the jdbc-ping cache stack by default.

Deprecation of method RequiredActionProvider.getMaxAuthAge()
The method RequiredActionProvider.getMaxAuthAge() is deprecated. It is effectively not used now. Please use the method RequiredActionProvider.getMaxAuthAge(KeycloakSession session) instead. This is due to enable individual configuration for required actions.

Deprecation of spi-connections-infinispan-quarkus-site-name
The option spi-connections-infinispan-quarkus-site-name is deprecated and no longer used for multi-site setups, and it will be removed in the future. Use spi-cache-embedded-default-site-name instead in setups when running with embedded distributed caches. See the All provider configuration for more details on these options.

Deprecated proprietary protocol for client initiated linking to the identity provider account
When you want the user, who is authenticated to your client application, to link his or her account to a specific identity provider, consider using the Application initiated action (AIA) based mechanism with the action idp_link. The proprietary custom protocol for client initiated account linking is deprecated now and might be removed in the future versions. For more information, see the Client initiated account link section of the Server Developer Guide.

Deprecated for removal the Instagram Identity Broker
In this release, the Instagram Identity Broker is deprecated for removal and is not enabled by default. If you are using this broker, it is recommended to use the Facebook Identity Broker instead.

For more details, see Deprecate for removal the Instagram social broker.

If you are using the Instagram Identity Broker and want to re-enable it, you can do it by enabling the instagram-broker feature using the features server option:

--features=instagram-broker
It has been a while since discussions started about any activity around the Instagram Identity Broker and any objection from the community about deprecating it for removal. For more details, see Deprecate for removal the Instagram social broker.

Local admin deprecated for removal
UrlType.LOCAL_ADMIN and the corresponding welcome theme variable localAdminUrl have been deprecated for eventual removal. The default welcome resource will now simply mention localhost rather than providing a URL when an admin user has yet to be created.

Deprecated password policy Recovery Codes Warning Threshold
In relation to supported Recovery codes, we deprecated the password policy Recovery Codes Warning Threshold. This password policy might be removed in the future major version of Keycloak. This password policy was not related to passwords at all, but was related to recovery codes, and hence using password policy is not appropriate way for the configuration of the threshold. It is recommended to use the configuration option Warning Threshold of the Recovery Authentication Codes required action instead of using password policy. For more details, see the Recovery codes documentation.

Scope.getPropertyNames deprecated for removal
The org.keycloak.Config.Scope.getPropertyNames method has been deprecated for removal.

Deprecation of the Passkeys Conditional UI Authenticator
The preview feature Passkeys recently introduced a new Passkeys Conditional UI Authenticator that you can use to integrate the passkey auto-fill or conditional UI feature in your login flow. Passkeys are now being seamlessly integrated into Keycloak inside the default username forms. Therefore, the old authenticator is invalid and it is deprecated in this release. The factory and implementation classes will be removed when Passkeys are supported in Keycloak.

Removed features
The following features have been removed from this release.

Removal of jboss.site.name and jboss.node.name
Both system properties have been used internally within Keycloak and have not been part of the official documentation. Keycloak will fail to start if those are present.

Instead, use the command line option spi-cache-embedded-default-site-name as jboss.site.name replacement, and spi-cache-embedded-default-node-name as jboss.node.name replacement. See the All provider configuration for more details on these options.

KeycloakSessionTask.useExistingSession method removed
KeycloakSessionTask.useExistingSession was only useful to private server logic. Now that this logic has been refined, there is no need for this method.

In previous releases there was a default implementation in the interface returning false,Wwe considered it unlikely that it was overwritten in implementations.

Usage of remote stores embedded caches is restricted
The experimental feature cache-embedded-remote-store was removed in this release and usage of remote stores for embedded caches is now restricted.

Consider one of the following cases and recommended migration steps:

If you are using remote stores for running Keycloak in multiple data centers especially if they do not have a direct networking connection to allow all Keycloak nodes to form a cluster, follow the High Availability Guide for deploying a multi-site Keycloak setup.

If you are using remote stores to keep user sessions available after a Keycloak restart, use the peristent-user-session feature which is enabled by default.

Keycloak refuses to start if the persistent-user-session feature is disabled and remote store is configured for any of the user session caches.

With the feature persistent-user-session feature enabled, the remote store configuration is ignored and Keycloak will print a warning.

Migrating to 26.2.0
Breaking changes
Edit this section
Report an issue
Breaking changes are identified as requiring changes from existing users to their configurations.

Changes to port behaviour with the X-Forwarded-Host header
The X-Forwarded-Host header can optionally also contain the port. In previous versions when the port was omitted from the header, Keycloak fell back to the actual request port. For example if Keycloak was listening on port 8080 and the request contained X-Forwarded-Host: example.com header, the resolved URL was http://example.com:8080.

This is now changed and omitting the port results in removing it from the resolved URL. The resolved URL from the previous example would now be http://example.com.

To mitigate that, either make your reverse proxy include the port in the X-Forwarded-Host header or configure it to set the X-Forwarded-Port header with the desired port.

Changes to installing Oracle JDBC driver
The required JAR for the Oracle JDBC driver that needs to be explicitly added to the distribution has changed. Instead of providing ojdbc11 JAR, use ojdbc17 JAR as stated in the Installing the Oracle Database driver guide.

H2 Credentials
With this version, the default H2 based dev-file database changed its credentials. While migrating from an instance using this dev only database is not supported, you may be able to continue to use your existing H2 database if you explicitly provide the old defaults for the database username and password. For example in the keycloak.conf specify:

db-username=sa

db-password=password

JWT Client authentication aligned with the latest OIDC specification
The latest draft version of the OpenID Connect core specification changed the rules for audience validation in JWT client assertions for the Client Authentication methods private_key_jwt and client_secret_jwt.

Previously, the aud claim of a JWT client assertion was loosely defined as The Audience SHOULD be the URL of the Authorization Server’s Token Endpoint, which did not exclude the usage of other URLs.

The revised OIDC Core specification uses a stricter audience check: The Audience value MUST be the OP’s Issuer Identifier passed as a string, and not a single-element array..

We adapted the JWT client authentication authenticators of both private_key_jwt and client_secret_jwt to allow only a single audience in the token by default. For now, the audience can be issuer, token endpoint, introspection endpoint or some other OAuth/OIDC endpoint, which is used by client JWT authentication. However since there is single audience allowed now, it means that it is not possible to use other unrelated audience values, which is to make sure that JWT token is really only useful by the Keycloak for client authentication.

This strict audience check can be reverted to the previous more lenient check with a new option of OIDC login protocol SPI. It will be still allowed to use multiple audiences in JWT if server is started with the option:

--spi-login-protocol-openid-connect-allow-multiple-audiences-for-jwt-client-authentication=true

Note that this option might be removed in the future. Possibly in Keycloak 27. So it is highly recommended to update your clients to use single audience instead of using this option. It is also recommended that your clients use the issuer URL for the audience when sending JWT for client authentication as that is going to be compatible with the future version of OIDC specification.

Notable changes
Notable changes where an internal behavior changed to prevent common misconfigurations, fix bugs or simplify running Keycloak.

proxy-trusted-addresses enforced for built-in X509 client certificate lookup providers
Built-in X.509 client certificate lookup providers now reflect the proxy-trusted-addresses config option. A certificate provided through the HTTP headers will now be processed only if the proxy is trusted, or proxy-trusted-addresses is unset.

Zero-configuration secure cluster communication
For clustering multiple nodes, Keycloak uses distributed caches. Starting with this release for all TCP-based transport stacks, the communication between the nodes is encrypted with TLS and secured with automatically generated ephemeral keys and certificates.

If you are not using a TCP-based transport stack, it is recommended to migrate to the jdbc-ping transport stack to benefit from the simplified configuration and enhanced security.

If you provided your own keystore and truststore to secure the TCP transport stack communication in previous releases, it is now recommended to migrate to the automatically generated ephemeral keys and certificates to benefit from the simplified setup.

If you are using a custom transport stack, this default behavior can be disabled by setting the option cache-embedded-mtls-enabled to false.

If you are using a service mesh, configure it to allow direct mTLS communication between the Keycloak Pods.

For more information, check the Securing Transport Stacks in the distributed caches guide.

Operator creates NetworkPolicies to restrict traffic
The Keycloak Operator now creates by default a NetworkPolicy to restrict traffic to internal ports used for Keycloak’s distributed caches.

This strengthens a secure-by-default setup and minimizes the configuration steps of new setups. We expect this to be backwards compatible to existing deployment, so no additional steps are necessary at the time of the upgrade. You can return to the previous behavior by disabling the creation of NetworkPolicies in the Keycloak CR.

If your deployment scripts add explicit NetworkPolicies for Keycloak, you should consider removing those and migrate to the new functionality provided in the Keycloak CR as a follow-up to the upgrade.

Read more about this in the Operator Advanced configuration.

Supported standard token exchange
In this release, Keycloak added support for the Standard token exchange (Feature token-exchange-standard:v2). In the past Keycloak releases, Keycloak had only a preview token exchange feature, which is now referred to as Legacy token exchange (Feature token-exchange:v1). The legacy token exchange is still in preview and it works the same way as in previous releases. If you used the internal-internal token exchange, consider migrating to the new standard token exchange.

If you prefer to continue using the legacy token exchange, you will find it operates as in previous releases. No need exists to disable the standard token exchange feature. Your clients will use the standard token exchange only if it is enabled on the Keycloak client. However, migration to the standard token exchange is recommended. It is the officially supported method and the priority for enhancements.

Consider the following notes as you plan for migration to the new standard token exchange:

The feature token-exchange-standard, which represents the new Standard token exchange, is enabled by default. It is recommended to disable the token-exchange feature, which represents the Legacy token exchange, to make sure that requests will be served by the new standard token exchange.

You can have both the standard and legacy token exchange features enabled, which can be useful if you need to cover standard use cases (internal-internal) together with the other token exchange use cases that are implemented only by legacy token exchange. For instance, external to internal token exchange is implemented only by the legacy token exchange. In this case, Keycloak serves the standard internal-to-internal requests preferably by the standard token exchange while the other requests are served by the legacy token exchange. The choice of standard or legacy token exchange is determined based on the parameters of the particular request. For example, requests containing non-standard parameters such as requested_issuer or requested_subject are considered legacy.

If you still need legacy token exchange, you also need Fine-grained admin permissions version 1 enabled (FGAP:v1) because version 2 (FGAP:v2) does not have support for token exchange permissions. This is on purpose because token-exchange is conceptually not really an "admin" permission and therefore token exchange permissions were not added to FGAP:v2.

Standard token exchange requires enabling a switch on the client as described in the Token exchange Documentation.

Consider these additional changes in the behavior of the two types of token exchange:

Fine-grained admin permissions are no longer needed or supported for the standard token exchange.

The most notable change regarding the behavior of scopes and audiences is that the applied client scopes are based on the client triggering the token exchange request rather than the "target" client specified by the audience parameter. Support exists for multiple values of the audience parameter as mentioned in the specification. The details are described in the Token exchange Documentation.

Public clients are no longer allowed to send the token exchange requests. Legacy token exchange allowed public clients to exchange tokens with themselves to downscope the original token. This use case can instead be covered by using the refresh token grant, in which the scope parameter can be used to downscope the refreshed access token, as mentioned in the OAuth2 specification.

Exchanging an access token for a SAML assertion is not supported in this release. In other words, using requested_token_type=urn:ietf:params:oauth:token-type:saml2 is not supported.

Exchanging an access token for a refresh token is allowed only if it is explicitly enabled on the client as mentioned in the Token exchange Documentation. Currently, it is not supported to request offline tokens or exchange a refresh token when the subject token was issued from an offline session. The recommended approach is to exchange for access tokens instead of refresh token when possible.

Fine-grained admin permissions supported
Starting with this release, Keycloak introduces fine-grained admin permissions V2, offering an improved and more flexible authorization model for administrative permissions.

FGAP:V2 feature is enabled by default.

FGAP:V1 feature remains in preview and can be enabled using --features=admin-fine-grained-authz:v1. However, V1 may be deprecated and removed in a future releases.

Migration from V1 to V2
Due to fundamental changes in the permission model, automatic migration from V1 to V2 is not available. To simplify the transition:

A new admin-permissions client is introduced. This client is created when you enable the capability for the realm. The client holds the authorization model for FGAP:V2.

The existing FGAP:V1 authorization model remains unchanged within the realm-management client.

Administrators must recreate permissions and policies using the new model, which can be configured in the updated Permissions section of the Admin Console.

Key Differences Between FGAP:V1 and FGAP:V2
Realm-level enablement:

FGAP:V2 can be enabled for a realm using the new Admin Permissions switch in Realm Settings.

Centralized management:

The resource-specific Permissions tabs (for users, groups, clients, and roles) have been removed.

A new Permissions section provides centralized management for all administrative permissions from a single place in the Admin Console.

Explicit operation scoping:

Transitive dependencies between permissions have been removed.

Administrators must now explicitly assign each required permission.

Example: To both view and manage a resource, both view and manage scopes for a permissions must be assigned separately.

Permission model changes:

The user-impersonated user permission has been removed.

The configure client permission has been removed. With the introduction of explicit operation scoping in V2, the distinction between manage and configure became ambiguous.

The user-impersonated user permission has been removed. Instead, you can use the impersonate-members scope of the Groups resource type to allow or deny impersonation of group members.

Permissions to manage-members of a group do not allow a realm administrator to unassign members from groups. The reason for that is that in V1 this was allowing a member of a group to become a regular realm user, and workaround permissions to create users in a realm. In the future, we will be working to provide additional scopes to allow deleting members from groups.

Flexible resource scoping:

Unlike V1, where permissions were granted either to a single resource (for clients, groups, and roles) or all resources (for users), V2 introduces greater flexibility.

Administrators can now define permissions for:

A specific resource

A set of selected resources

All resources of a given type

This applies to all resource types: clients, users,groups, and roles.

LDAP provider now can store new users, groups, and roles in a sub-DN of the base DN
When adding new users, groups, or roles, the LDAP provider would always store them in the same base DN configured for the searches. However, in some deployments admins may want to configure a broader DN with subtree scope to fetch users (or groups/roles) from multiple sub-DNs, but they don’t want new users (or groups/roles) to be stored in this base DN in LDAP. Instead, they would like to chose one of the sub-DNs for that.

It is now possible to control where new users, groups, or roles will be created using the new Relative User Creation DN config option in the LDAP provider and also in the LDAP group and role mappers. For more details, check the LDAP admin guide

Removal of the X-XSS-Protection header
Because the X-XSS-Protection header is no longer supported by any user agents that are supported by Keycloak, it has been removed. This header was a feature of Internet Explorer, Chrome, and Safari that stopped pages from loading when they detected reflected cross-site scripting (XSS) attacks.

We don’t expect that this will impact any deployments due to the lack of support in user agents, as well as this feature being supplanted by Content Security Policy (CSP).

JWT client authentication defines a new max expiration option for the token
When a client is configured to authenticate using the Signed JWT or Signed JWT with Client Secret type, Keycloak now enforces a maximum expiration for the token. This means that, although the exp (expiration) claim in the token may be much later, Keycloak will not accept tokens issued before that max expiration time. The default value is 60 seconds. Note that JWT tokens should be issued right before being sent for authentication. This way, the client has one minute window to send the token for login. Nevertheless this expiration can be tuned using the Max expiration configuration option in the client Credentials tab (see Confidential client credentials in the Server Administration Guide for more information).

Updates to the user-profile-commons.ftl theme template
The user-profile-commons.ftl changed to improve support for localization. See https://github.com/keycloak/keycloak/issues/38029. As a result, and if you are extending this template, pages might start displaying a locale field. To avoid that, update the theme template with the changes aforementioned.

Migrating to 26.1.3
Notable changes
Edit this section
Report an issue
Notable changes where an internal behavior changed to prevent common misconfigurations, fix bugs or simplify running Keycloak.

Send Reset Email force login again for federated users after reset credentials
Previously the reset credentials flow (forgot password feature) kept the user logged in after the reset credentials if the same authentication session (same browser) was used. For federated user providers this behavior can be a security issue. Imagine a provider implementation that detects the user as enabled, performs the password change successfully but the validation of the user password fails for some reason. In this scenario the reset credentials flow allowed a user to be logged in after the successful password change that would have not been allowed to login using the normal browser flow. This scenario is not a common case but should be avoided by default.

For this reason now the authenticator reset-credential-email (Send Reset Email) has a new configuration option called force-login (Force login after reset) with values true (always force the login), false (previous behavior that keeps the user logged in if the same authentication session is used), and only-federated (default value that forces federated users to authenticate again and keeps previous behavior for users stored in Keycloak’s internal database).

For more information about changing this option, see Enable forgot password.

Migrating to 26.1.0
Breaking changes
Edit this section
Report an issue
Breaking changes are identified as requiring changes from existing users to their configurations.

There are no breaking changes in this release to public APIs or documented behavior.

Notable changes
Notable changes where an internal behavior changed to prevent common misconfigurations, fix bugs or simplify running Keycloak.

Offline access removes the associated online session if the offline_scope is requested in the initial exchange
Any offline session in Keycloak is created from an online session. When the offline_access scope is requested, the current online session is used to create the associated offline session for the client. Therefore, any offline_access request finished, until now, created two sessions: one online and one offline. This situation lead to unreliable behavior. For example, when just the login with scope=offline_access was requested, there could be an unused online session created, which is then useless in most cases. This situation caused the unnecessary consumption of server resources.

Starting with this version, Keycloak removes the initial online session if the offline_scope is directly requested as the first interaction for the session. The client retrieves the offline token after the code to token exchange that is associated to the offline session, but the previous online session is removed. If the online session has been used before the offline_scope request, by the same or another client, the online session remains active as today. This situation also means that the SSO session is not created in the browser if the login request with scope=offline_access is used and the user was not already authenticated in the SSO beforehand. Although the new behavior makes sense because the client application is just asking for an offline token, it can affect some scenarios that rely on having the online session still active after the initial offline_scope token request.

New client scope service_account for client_credentials grant mappers
Keycloak introduces a new client scope at the realm level called service_account which is in charge of adding the specific claims for client_credentials grant (client_id, clientHost and clientAddress) via protocol mappers. This scope will be automatically assigned to and unassigned from the client when the serviceAccountsEnabled option is set or unset in the client configuration.

Previously, the three mappers (Client Id, Client Host and Client IP Address) where added directly to the dedicated scope when the client was configured to enable service accounts, and they were never removed.

The behavior should be effectively the same for most Keycloak deployments because claims in the token are effectively same as before. You might be affected in cases when you are using a client credentials grant and you are preparing the Keycloak environment by some tooling that is manually removing or updating the three protocol mappers mentioned above. For instance, if you use an admin CLI script to enable a service-account for a client and then remove the built-in service-account protocol mappers, you may adjust your CLI to instead remove the assignment of the service_account client scope from the client instead of removing protocol mappers.

Deprecation notices
This lists functionality that continues to work as before in this release, but will be removed in a future major release.

Default db option for production deprecated.
In previous releases, the db option defaulted to dev-file both in production (start) and development (start-dev) modes while dev-file has never been supported in the production mode. In this release, we have deprecated this behaviour and in some future release the db option won’t default to dev-file in production mode. For build or non-optimized start and non-server commands import, export, or bootstrap-admin in the production profile, a value should be explicitly supplied. This is to prevent the unintentional usage of the dev-file (H2) database in a production environment, which is typically indicative of a misconfiguration.

Deprecated APIs for JavaScript Authorization client
The following APIs for the JavaScript Authorization client are deprecated and will be removed in the next major release:

The ready property on the KeycloakAuthorization instance.

The init() method on the KeycloakAuthorization instance.

These APIs are no longer needed as initialization is done automatically on demand when calling methods on the KeycloakAuthorization instance. You can safely remove any code that depends on these APIs.

Deprecated endpoint for initiate registration from OIDC client
The /realms/<realm>/protocol/openid-connect/registrations endpoint, which was used for initiating registration by OIDC client, is now deprecated because a standard way exists to initiate registration from the OIDC client. This way is now supported by Keycloak. It uses the parameter prompt=create.

Deprecating getAll() methods in Organizations and OrganizationMembers APIs
getAll() methods in Organizations and OrganizationMembers APIs are now deprecated and will be removed in the next major release. Instead, use corresponding list(first, max) methods in Organizations and OrganizationMembers APIs.

Deprecated transport stacks for distributed caches
The udp, jdbc-ping-udp, tcp, azure, ec2 and google transport stacks have been deprecated. Users should use the TCP based jdbc-ping stack as a direct replacement.

Migrating to 26.0.6
Security improvements for the key resolvers
Edit this section
Report an issue
While using the REALM_FILESEPARATOR_KEY key resolver, Keycloak now restricts access to FileVault secrets outside of its realm. Characters that could cause path traversal when specifying the expression placeholder in the Administration Console are now prohibited.

Additionally, the KEY_ONLY key resolver now escapes the _ character to prevent reading secrets that would otherwise be linked to another realm when the REALM_UNDERSCORE_KEY resolver is used. The escaping simply replaces _ with __, so, for example, ${vault.my_secret} now looks for a file named my__secret. We recognize that this is a breaking change; therefore, a warning is logged to ease the transition.

Migrating to 26.0.0
Infinispan marshalling changes
Edit this section
Report an issue
Marshalling is the process of converting Java objects into bytes to send them across the network between Keycloak servers. With Keycloak 26, the marshalling library has changed from JBoss Marshalling to Infinispan Protostream. The libraries are not compatible between each other and, it requires some steps to ensure the session data is not lost.

JBoss Marshalling and Infinispan Protostream are not compatible with each other and incorrect usage may lead to data loss. Consequently, all caches are cleared when upgrading to this version.
To prevent losing user sessions upgrade to Keycloak 25 first and enable the persistent sessions feature as outlined in the migration guide for Keycloak 25.

Operator no longer defaults to proxy=passthrough
The Operator will no longer default to the hostname v1 setting of proxy=passthrough. This allows deployments using hostname v2 for a fixed edge hostname to work as desired without additional options.

New method in ClusterProvider API
The following method was added to org.keycloak.cluster.ClusterProvider:

void notify(String taskKey, Collection<? extends ClusterEvent> events, boolean ignoreSender, DCNotify dcNotify)

When multiple events are sent to the same taskKey, this method batches events and just perform a single network call. This is an optimization to reduce traffic and network related resources.

In Keycloak 26, the new method has a default implementation to keep backward compatibility with custom implementation. The default implementation performs a single network call per an event, and it will be removed in a future version of Keycloak.

Group-related events no longer fired when removing a realm
With the goal of improving the scalability of groups, they are now removed directly from the database when removing a realm. As a consequence, group-related events like the GroupRemovedEvent are no longer fired when removing a realm.

If you have extensions handling any group-related event when a realm is removed, make sure to use the RealmRemovedEvent instead to perform any cleanup or custom processing when a realm, and their groups, are removed.

The GroupProvider interface is also updated with a new preRemove(RealmModel) method to force implementations to properly handle the removal of groups when a realm is removed.

Automatic redirect from root to relative path
User is automatically redirected to the path where Keycloak is hosted when the http-relative-path property is specified. It means when the relative path is set to /auth, and the user access localhost:8080/, the page is redirected to localhost:8080/auth.

The same applies to the management interface when the http-management-relative-path or http-relative-path property is specified.

It improves user experience as users no longer need to set the relative path to the URL explicitly.

Operator scheduling defaults
Keycloak Pods will now have default affinities to prevent multiple instances from the same CR from being deployed on the same node, and all Pods from the same CR will prefer to be in the same zone to prevent stretch cache clusters.

Operator’s default CPU and memory limits/requests
In order to follow the best practices, the default CPU and memory limits/requests for the Operator were introduced. It affects both non-OLM and OLM installs. To override the default values for the OLM install, edit the resources section in the operator’s subscription.

Deprecations in keycloak-common module
The following items have been deprecated for removal in upcoming Keycloak versions with no replacement:

org.keycloak.common.util.reflections.Reflections.newInstance(java.lang.Class<T>)

org.keycloak.common.util.reflections.Reflections.newInstance(java.lang.Class<?>, java.lang.String)

org.keycloak.common.util.reflections.SetAccessiblePrivilegedAction

org.keycloak.common.util.reflections.UnSetAccessiblePrivilegedAction

Consistent usage of UTF-8 charset for URL encoding
org.keycloak.common.util.Encode now always uses the UTF-8 charset for URL encoding instead relying implicitly on the file.encoding system property.

Configuring the LDAP Connection Pool
In this release, the LDAP connection pool configuration relies solely on system properties. The main reason is that the LDAP connection pool configuration is a JVM-level configuration rather than specific to an individual realm or LDAP provider instance.

Compared to previous releases, any realm configuration related to the LDAP connection pool will be ignored. If you are migrating from previous versions where any of the following settings are set to your LDAP provider(s), consider using system properties instead:

connectionPoolingAuthentication

connectionPoolingInitSize

connectionPoolingMaxSize

connectionPoolingPrefSize

connectionPoolingTimeout

connectionPoolingProtocol

connectionPoolingDebug

For more details, see Configuring the connection pool.

Custom Footer in Login Theme
This release introduced the capability to easily add a custom footer to the login pages for the base/login and keycloak.v2/login theme. In order to use a custom footer, create a footer.ftl file in your custom login theme with the desired content.

For more details, see Adding a custom footer to a login theme.

Persisting revoked access tokens across restarts
In this release, revoked access tokens are written to the database and reloaded when the cluster is restarted by default when using the embedded caches.

To disable this behavior, use the SPI option spi-single-use-object-infinispan-persist-revoked-tokens as outlined in the All provider configuration guide.

The SPI behavior of SingleUseObjectProvider has changed that for revoked tokens only the methods put and contains must be used. This is enforced by default, and can be disabled using the SPI option spi-single-use-object-infinispan-persist-revoked-tokens.

Highly available multi-site deployments
Keycloak 26 introduces significant improvements to the recommended HA multi-site architecture, most notably:

Keycloak deployments are now able to handle user requests simultaneously in both sites. Previous load balancer configurations handling requests only in one site at a time will continue to work.

Active monitoring of the connectivity between the sites is now required to the replication between the sites in case of a failure. The blueprints describe a setup with Alertmanager and AWS Lambda.

The loadbalancer blueprint has been updated to use the AWS Global Accelerator as this avoids prolonged fail-over times caused by DNS caching by clients.

Persistent user sessions are now a requirement of the architecture. Consequently, user sessions will be kept on Keycloak or Infinispan upgrades.

External Infinispan request handling has been improved to reduce memory usage and request latency.

As a consequence of the above changes, the following changes are required to your existing Keycloak deployments.

distributed-cache definitions provided by a cache configuration file are ignored when the multi-site feature is enabled, so you must configure the connection to the external Infinispan deployment via the cache-remote-* command line arguments or Keycloak CR as outlined in the blueprints. All remote-store configurations must be removed from the cache configuration file.

Review your current cache configurations in the external Infinispan and update them with those outlined in the latest version of the Keycloak’s documentation. While previous versions of the cache configurations only logged warnings when the backup replication between sites failed, the new configurations ensure that the state in both sites stays in sync: When the transfer between the two sites fails, the caller will see an error. Due to that, you need to set up monitoring to disconnect the two sites in case of a site failure. The Keycloak High Availability Guide contains a blueprint on how to set this up.

While previous load balancer configurations will continue to work with Keycloak, consider upgrading an existing Route53 configuration to avoid prolonged failover times due to client side DNS caching.

If you have updated your cache configuration XML file with remote-store configurations, those will no longer work. Instead, enable the multi-site feature and use the cache-remove-* options.

External Infinispan in a single-site setup
If you are using an external Infinispan in a single-site setup, this was not supported in earlier versions of Keycloak and it is not supported in Keycloak 26. To protect users from using it accidentally via a manual configuration in Keycloak’s cache XML or via the CLI options, this is now guarded with a feature flag cache-embedded-remote-store. It is marked as experimental and is therefore not supported. Keycloak 26 will not start with such a configuration and show an error instead unless this experimental feature is enabled.

If you have been using an external Infinispan to keep users logged in between restarts and upgrades, use the persistent-user-sessions feature instead which is enabled by default. The external Infinispan is then no longer necessary.

The experimental feature cache-embedded-remote-store will be removed in a future minor release.

Admin Bootstrapping and Recovery
It used to be difficult to regain access to a Keycloak instance when all admin users were locked out. The process required multiple advanced steps, including direct database access and manual changes. In an effort to improve the user experience, Keycloak now provides multiple ways to bootstrap a new admin account, which can be used to recover from such situations.

Consequently, the environment variables KEYCLOAK_ADMIN and KEYCLOAK_ADMIN_PASSWORD have been deprecated. You should use KC_BOOTSTRAP_ADMIN_USERNAME and KC_BOOTSTRAP_ADMIN_PASSWORD instead. These are also general options, so they may be specified via the cli or other config sources, for example --bootstrap-admin-username=admin. For more information, see the new Bootstrap admin and recovery guide.

Application Initiated Required Action redirect now contains kc_action Parameter
The required action provider name is now returned via the kc_action parameter when redirecting back from an application initiated required action execution. This eases the detection of which required action was executed for a client. The outcome of the execution can be determined via the kc_action_status parameter.

Note: This feature required changes to the Keycloak JS adapter, therefore it is recommended to upgrade to the latest version of the adapter if you want to make use of this feature.

Deprecations in keycloak-services module
The class UserSessionCrossDCManager is deprecated and planned to be removed in a future version of Keycloak. Read the UserSessionCrossDCManager Javadoc for the alternative methods to use.

Identity Providers no longer available from the realm representation
As part of the improvements around the scalability of realms and organizations when they have many identity providers, the realm representation no longer holds the list of identity providers. However, they are still available from the realm representation when exporting a realm.

To obtain the query the identity providers in a realm, prefer using the /realms/{realm-name}/identity-provider/instances endpoint. This endpoint supports filters and pagination.

CLI import placeholder replacement
The CLI command kc.[sh|bat] import now has placeholder replacement enabled. Previously placeholder replacement was only enabled for realm import at startup.

If you wish to disable placeholder replacement for the import command, add the system property -Dkeycloak.migration.replace-placeholders=false

New Java API to search realms by name
The RealmProvider Java API now contains a new method Stream<RealmModel> getRealmsStream(String search) which allows searching for a realm by name. While there is a default implementation which filters the stream after loading it from the provider, implementations are encouraged to provide this with more efficient implementation.

Keystore and trust store default format change
Keycloak now determines the format of the keystore and trust store based on the file extension. If the file extension is .p12, .pkcs12 or .pfx, the format is PKCS12. If the file extension is .jks, .keystore or .truststore, the format is JKS. If the file extension is .pem, .crt or .key, the format is PEM.

You can still override automatic detection by specifying the https-key-store-type and https-trust-store-type explicitly. The same applies to the management interface and its https-management-key-store-type. Restrictions for the FIPS strict mode stay unchanged.

The spi-truststore-file-* options and the truststore related options https-trust-store-* are deprecated, we strongly recommend to use System Truststore. For more details refer to the relevant guide.
Improving performance for selection of identity providers
New indexes were added to the IDENTITY_PROVIDER table to improve the performance of queries that fetch the IDPs associated with an organization, and fetch IDPs that are available for login (those that are enabled, not link_only, not marked as hide_on_login).

If the table currently contains more than 300.000 entries, Keycloak will skip the creation of the indexes by default during the automatic schema migration, and will instead log the SQL statements on the console during migration. In this case, the statements must be run manually in the DB after Keycloak’s startup.

Also, the kc.org and hideOnLoginPage configuration attributes were migrated to the identity provider itself, to allow for more efficient queries when searching for providers. As such, API clients should use the getOrganizationId/setOrganizationId and isHideOnLogin/setHideOnLogin methods in the IdentityProviderRepresentation, and avoid setting these properties using the legacy config attributes that are now deprecated.

Removal of GELF logging handler
GELF support has been deprecated for a while now, and with this release it has been finally removed from Keycloak. Other log handlers are available and fully supported to be used as a replacement of GELF, for example Syslog. For details see the Logging guide.

Paths for common theme resources have changed
Some of the paths for the common resources of the keycloak theme have changed, specifically the resources for third-party libraries. Make sure to update your custom themes accordingly:

node_modules/patternfly/dist is now vendor/patternfly-v3

node_modules/@patternfly/patternfly is now vendor/patternfly-v4

node_modules/@patternfly-v5/patternfly is now vendor/patternfly-v5

node_modules/rfc4648/lib is now vendor/rfc4648

Additionally, the following resources have been removed from the common theme:

node_modules/alpinejs

node_modules/jquery

If you previously used any of the removed resources in your theme, make sure to add them to your own theme resources instead.

Additional datasources now require using XA
Keycloak by default does not use XA datasources. However, this is considered unsafe if more than one datasource is used. Starting with this release, you need to use XA datasources if you are adding additional datasources to Keycloak. If the default datasource supports XA, you can do this by setting the --transaction-xa-enabled=true option. For additional datasources, you need to use the quarkus.datasource.<your-datasource-name>.jdbc.transactions=xa option in your quarkus.properties file. At most one datasource can be non-XA. Recovery isn’t supported when you don’t have persistent storage for the transaction store.

Hostname v1 feature removed
The deprecated hostname v1 feature was removed. This feature was deprecated in Keycloak 25 and replaced by hostname v2. If you are still using this feature, you must migrate to hostname v2. For more details, see the Configuring the hostname (v2) and the initial migration guide.

Proxy option removed
The deprecated proxy option was removed. This option was deprecated in Keycloak 24 and replaced by the proxy-headers option in combination with hostname options as needed. For more details, see using a reverse proxy and the initial upgrading guide.

All user sessions are persisted by default
Since the database is now the source of truth for user sessions, it is possible to restrict the size of the session caches to reduce memory usage. If you use the default conf/cache-ispn.xml file the caches for storing user and client sessions are by default configured to store only 10000 sessions and one owner for each entry.

Update your custom embedded Infinispan cache configuration file with configuration similar to one shown below for caches sessions, clientSessions, offlineSessions, and offlineClientSessions:

<distributed-cache name="sessions" owners="1">
    <!-- other configuration -->
    <memory max-count="10000"/>
</distributed-cache>
For more details proceed to the Configuring distributed caches guide.

Grace period for idle sessions removed when persistent sessions are enabled
Previous versions of Keycloak added a grace period of two minutes to idle times of user and client sessions. This was added due to a previous architecture where session refresh times were replicated asynchronously in a cluster. With persistent user sessions, this is no longer necessary, and therefore the grace period is now removed.

To keep the old behavior, update your realm configuration and extend the session and client idle times by two minutes.

Support for legacy redirect_uri parameter and SPI options has been removed
Previous versions of Keycloak had supported automatic logout of the user and redirecting to the application by opening logout endpoint URL such as http(s)://example-host/auth/realms/my-realm-name/protocol/openid-connect/logout?redirect_uri=encodedRedirectUri. This functionality was deprecated in Keycloak 18 and has been removed in this version in favor of following the OpenID Connect specification.

As part of this change the following related configuration options for the SPI have been removed:

--spi-login-protocol-openid-connect-legacy-logout-redirect-uri

--spi-login-protocol-openid-connect-suppress-logout-confirmation-screen

If you were still making use these options or the redirect_uri parameter for logout you should implement the OpenID Connect RP-Initiated Logout specification instead.

Additional validations on the --optimized startup option
The --optimized startup option now requires the optimized server image to be built first. This can be achieved either by running kc.sh|bat build first or by any other server commands (like start, export, import) without the --optimized flag.

Adapter and misc BOM files are removed
The org.keycloak.bom:keycloak-adapter-bom and org.keycloak.bom:keycloak-misc-bom BOM files are removed. The adapter BOM was no longer useful because most of the Java adapters are removed. The misc BOM had contained only one artifact, keycloak-test-helper, and that artifact is also removed in this release.

keycloak-test-helper is removed
The maven artifact org.keycloak:keycloak-test-helper is removed in this release. The artifact provided a few helper methods for dealing with a Java admin client. If you use the helper methods, it is possible to fork them into your application if needed.

JEE admin-client is removed
The JEE admin-client is removed in this release. We still keep supporting Jakarta admin-client.

New generalized event types for credentials
There are now generalized events for updating (UPDATE_CREDENTIAL) and removing (REMOVE_CREDENTIAL) a credential. The credential type is described in the credential_type attribute of the events. The new event types are supported by the Email Event Listener.

The following event types are now deprecated and will be removed in a future version: UPDATE_PASSWORD, UPDATE_PASSWORD_ERROR, UPDATE_TOTP, UPDATE_TOTP_ERROR, REMOVE_TOTP, REMOVE_TOTP_ERROR

--import-realm option can import the master realm
When running a start or start-dev command with the --import-realm option before the master realm exists, it will be imported if it exists in the import material. The previous behavior was that the master realm was created first, then its import skipped.

BouncyCastle FIPS updated
Our FIPS 140-2 integration is now tested and supported with version 2 of BouncyCastle FIPS libraries. This version is certified with Java 21. If you use FIPS 140-2 integration, it is recommended to upgrade BouncyCastle FIPS library to the versions mentioned in the latest documentation.

The BouncyCastle FIPS version 2 is certified with FIPS 140-3. So Keycloak can be FIPS 140-3 compliant as long as it is used on the FIPS 140-3 compliant system. This might be the RHEL 9 based system, which itself is compliant with the FIPS 140-3. But note that RHEL 8 based system is only certified for the FIPS 140-2.

setOrCreateChild() method removed from JavaScript Admin Client
The groups.setOrCreateChild() method has been removed from that JavaScript-based Admin Client. If you are still using this method then use the createChildGroup() or updateChildGroup() methods instead.

Keycloak JS
This release includes several changes to Keycloak JS library that should be taken into account. The main motivation for these changes is to de-couple the library from the Keycloak server, so that it can be refactored independently, simplifying the code and making it easier to maintain in the future. The changes are as follows:

The library is no longer served statically from the server
The Keycloak JS library is no longer served statically from the Keycloak server. This means that the following URLs are no longer available:

/js/keycloak-authz.js

/js/keycloak-authz.min.js

/js/keycloak.js

/js/keycloak.min.js

/js/{version}/keycloak-authz.js

/js/{version}/keycloak-authz.min.js

/js/{version}/keycloak.js

/js/{version}/keycloak.min.js

Additionally, the keycloakJsUrl property that linked to the library on these URLs has been removed from the admin console theme. If your custom theme was using this property to include the library, you should update your theme to include the library using a different method.

If you are not already you should include the library in your project using a package manager like NPM. The library is available on the NPM registry as keycloak-js. You can install it using the following command:

npm install keycloak-js
Alternatively, the distribution of the server includes a copy of the library in the keycloak-js-26.0.0.tgz archive. You can copy the library from there into your project. If you are using the library directly in the browser without a build, you’ll need to host the library yourself. A package manager is still the recommended way to include the library in your project, as it will make it easier to update the library in the future.

Support for the UMD distribution has been removed
The UMD distribution Universal Module Definition of the Keycloak JS library has been removed. This means that the library is no longer exposed as a global variable, and instead must be imported as a module. This change is in line with modern JavaScript development practices, and allows for a more consistent experience between browsers and build tooling, and generally results in more predictable code with less side-effects.

If you are using a bundler like Vite or Webpack nothing changes, you’ll have the same experience as before. If you are using the library directly in the browser, you’ll need to update your code to import the library as a module:

<!-- Before -->
<script src="/path/to/keycloak.js"></script>
<script>
    const keycloak = new Keycloak();
</script>

<!-- After -->
<script type="module">
    import Keycloak from '/path/to/keycloak.js';
    const keycloak = new Keycloak();
</script>
You can also opt to use an import map make the import of the library less verbose:

<script type="importmap">
    {
        "imports": {
            "keycloak-js": "/path/to/keycloak.js"
        }
    }
</script>
<script type="module">
    // The library can now be imported without specifying the full path, providing a similar experience as with a bundler.
    import Keycloak from 'keycloak-js';
    const keycloak = new Keycloak();
</script>
If you are using TypeScript you may need to update your tsconfig.json to be able to resolve the library:

{
    "compilerOptions": {
        "moduleResolution": "Bundler"
    }
}
The configuration for the Keycloak instance is now required
Previously it was possible to construct a Keycloak instance without passing any configuration. The configuration would then automatically be loaded from the server from a keycloak.json file based on the path of the included keycloak.js script. Since the library is no longer statically served from the server this feature has been removed. You now need to pass the configuration explicitly when constructing a Keycloak instance:

// Before
const keycloak = new Keycloak();

// After
const keycloak = new Keycloak({
    url: "http://keycloak-server",
    realm: "my-realm",
    clientId: "my-app"
});

// Alternatively, you can pass a URL to a `keycloak.json` file.
// Note this is not recommended as it creates additional network requests, and is prone to change in the future.
const keycloak = new Keycloak('http://keycloak-server/path/to/keycloak.json');
Methods for login are now async
Keycloak JS now utilizes the Web Crypto API for various cryptographic functions. Due to the asynchronous nature of this API the following public methods will now always return a Promise:

login()

createLoginUrl()

createRegisterUrl()

Make sure to update your code to await these methods:

// Before
keycloak.login();
const loginUrl = keycloak.createLoginUrl();
const registerUrl = keycloak.createRegisterUrl();

// After
await keycloak.login();
const loginUrl = await keycloak.createLoginUrl();
const registerUrl = await keycloak.createRegisterUrl();
Make sure to update your code to await these methods.

A secure context is now required
Keycloak JS now requires a secure context to run. The reason for this is that the library now uses the Web Crypto API for various cryptographic functions. This API is only available in secure contexts, which are contexts that are served over HTTPS, localhost or a .localhost domain. If you are using the library in a non-secure context you’ll need to update your development environment to use a secure context.

Stricter startup behavior for build-time options
When the provided build-time options differ at startup from the values persisted in the server image during the last optimized Keycloak build, Keycloak will now fail to start. Previously, a warning message was displayed in such cases.

Features renamed
With feature versions the features account3, admin2, and login2 have been renamed. When disabling a feature there is no need to use the version, for example the admin console is now disabled with --features-disabled=admin.

To use a specific version of login use --features=login:v1.

Migrating to 25.0.3
Concurrent login requests are blocked by default when brute force is enabled
Edit this section
Report an issue
If an attacker launched many login attempts in parallel then the attacker could have more guesses at a password than the brute force protection configuration permits. This was due to the brute force check occurring before the brute force protector has locked the user. To prevent this race the Brute Force Protector now rejects all login attempts that occur while another login is in progress in the same server.

If, for whatever reason, the new feature wants to be disabled there is a startup factory option:

bin/kc.[sh|bat] start --spi-brute-force-protector-default-brute-force-detector-allow-concurrent-requests=true
Migrating to 25.0.2
Improving performance for deletion of user consents
Edit this section
Report an issue
When a client scope or the full realm are deleted the associated user consents should also be removed. A new index over the table USER_CONSENT_CLIENT_SCOPE has been added to increase the performance.

Note that, if the table contains more than 300.000 entries, by default Keycloak skips the creation of the indexes during the automatic schema migration and logs the SQL statements to the console instead. The statements must be run manually in the DB after Keycloak’s startup. Check the Upgrading Guide for details on how to configure a different limit.

Migrating to 25.0.0
New Hostname options
Edit this section
Report an issue
Hostname v2 options are supported by default, as the old hostname options are deprecated and will be removed in the following releases. New options are activated by default, so Keycloak will not recognize the old options.

List of necessary migrations:

Old options	New options
hostname <hostname>
hostname-url <url>
hostname-path <path>
hostname-port <port>

hostname <hostname/url>

hostname-admin <hostname>
hostname-admin-url <url>

hostname-admin <url>

hostname-strict-backchannel <true/false>

hostname-backchannel-dynamic <true/false>

As you can see, the *-url suffixes were removed for hostname and hostname-admin options. Option hostname accepts both hostname and URL, but hostname-admin accepts only full URL now.

Additionally, there is no way to set path or port separately. You can achieve it by providing the full URL for the hostname and hostname-admin options.

If the port is not part of the URL, it is dynamically resolved from the incoming request headers.

HTTPS is no longer enforced unless it is part of hostname and hostname-admin URLs. If not specified, the used protocol (http/https) is dynamically resolved from the incoming request. The hostname-strict-https option is removed.

Removed options
hostname-url

hostname-admin-url

hostname-path

hostname-port

hostname-strict-backchannel

hostname-strict-https

In order to use the old hostname options to have more time for migration, turn on the feature hostname:v1, e.g. features=hostname:v1. Be aware, that either hostname:v1 or hostname:v2 can be enabled, not both at the same time.
Examples
Simplified notation
# Hostname v1
bin/kc.[sh|bat] start --hostname=mykeycloak.org --https-port=8543 --hostname-path=/auth --hostname-strict-https=true

# Hostname v2
bin/kc.[sh|bat] start --hostname=https://mykeycloak.org:8543/auth
As you can see in the example, all the parts of a URL can be now specified via single hostname option, which simplifies the hostname setup process. Notice that HTTPS is not enforced by the hostname-strict-https option, but by specifying it in the hostname URL.

Backchannel setting
# Hostname v1
bin/kc.[sh|bat] start --hostname=mykeycloak.org --hostname-strict-backchannel=true

# Hostname v2
bin/kc.[sh|bat] start --hostname=mykeycloak.org --hostname-backchannel-dynamic=false
Be aware that there is a change in behavior if the same URL is to be used for both backend and frontend endpoints. Previously, in hostname v1, the backchannel URL was dynamically resolved from request headers. Therefore, to achieve the required results, you had to specify the hostname-strict-backchannel=true.

For hostname v2, the backchannel URLs are already the same as the frontend ones. In order to dynamically resolve it from request headers, you need to set the hostname-backchannel-dynamic=true and provide a full URL for the hostname option.

For more details and more comprehensive scenarios, see Configuring the hostname (v2).

security-admin-console Client Redirect URIs
The handling of the ${authAdminUrl} has changed in hostname v1. Previously with hostname v1 the admin URL was resolved dynamically from the request if the hostname-admin or hostname-admin-url options were not set. With hostname v2 the admin URL will default instead to the frontend URL. If the hostname option is set and hostname-strict is true, this change will prevent redirect URIs with alternative hostnames from working for Clients using the Root URL ${authAdminUrl}. You should consider using the hostname-admin option instead of the redirect URIs to allow a single alternative hostname. Alternative hostname redirects should be removed as the security-admin-console Client only needs the default redirect URI of /admin/master/console/* with Root URL of ${authAdminUrl}.

Persistent user sessions
Previous versions of Keycloak stored only offline user and offline client sessions in the databases. The new feature persistent-user-sessions stores online user sessions and online client sessions not only in memory, but also in the database. This will allow a user to stay logged in even if all instances of Keycloak are restarted or upgraded.

Enabling persistent user sessions
The feature is a preview feature and disabled by default. To use it, add the following to your build command:

bin/kc.sh build --features=persistent-user-sessions ...
For more details see the Enabling and disabling features guide. The sizing guide contains a new paragraph describing the updated resource requirements when this feature is enabled.

If this feature is enabled for an existing deployment that is using only the embedded Infinispan for storing sessions, the existing online user and client sessions will not be migrated to the database. It will only affect newly created online user and online client sessions.
With persistent sessions enabled, the in-memory caches for online user sessions, offline user sessions, online client sessions and offline client sessions are limited to 10000 entries per node by default which will reduce the overall memory usage of Keycloak for larger installations. Items which are evicted from memory will be loaded on-demand from the database when needed. To set different sizes for the caches, edit Keycloak’s cache config file to set a <memory max-count="..."/> for those caches. Once this feature is enabled, expect an increased database utilization on each login, logout and refresh token request.

To configure the cache size in an external Infinispan in a Keycloak multi-site setup, consult the updated Deploy Infinispan for HA with the Infinispan Operator guide.

With this feature enabled, the options spi-user-sessions-infinispan-offline-session-cache-entry-lifespan-override and spi-user-sessions-infinispan-offline-client-session-cache-entry-lifespan-override are no longer available, as they were previously used to override the time offline sessions were kept in-memory.

Migrating user sessions during the upgrade
When upgrading from Keycloak 24 or earlier, admins can choose to migrate existing online user and client sessions to persistent sessions. For this to work, those existing sessions need to be stored in either a remote Infinispan or in a database configured as JDBC persistence for Keycloak’s embedded cache. Migrating in-memory sessions for Keycloak 24 is not supported as all Keycloak instances need to be shut down before the upgrade due to a major version upgrade of the embedded Infinispan.

The migration of user sessions only works when the persistent user sessions is enabled when upgrading to Keycloak 25. If you chose to upgrade to 25 without enabling persistent user sessions, there is currently no possibility to trigger the migration of existing sessions at a later point in time.

Enabling this feature later, by a configuration change, can result in an undefined behavior of Keycloak related to sessions if both persisted and non-persisted sessions co-exist. To prevent that, remove all existing online user and client sessions before the first node is started with the feature enabled. This means all Keycloak nodes need to be stopped and, if used, Infinispan remote cache store and embedded Infinispan JDBC persistence need to be cleared.

To migrate the user sessions during an upgrade of Keycloak, perform the following steps:

Stop all running old instances of Keycloak.

Create backups:

Create a backup Keycloak’s database.

If JDBC persistence is used, create a backup of that database if you want to be able to retry the migration of the sessions.

If an external Infinispan is used, create a backup of its data if you want to be able to retry the migration of the sessions.

Start the new instances Keycloak with the persistent user sessions feature enabled.

The first starting node will:

Migrate the database to the schema version 25.

Copy all session information from either the remote Infinispan or the JDBC persistence configured for Keycloak’s embedded cache to the database of Keycloak.

The data will be stored in the tables offline_user_session and offline_client_session with offline_flag set to false.

Clear the caches.

This includes clearing the caches of the external Infinispan if one is used, and clearing the JDBC persistence if one is used.

Update the cache configuration XML of Keycloak for caches sessions and clientSessions:

If JDBC persistence is used, remove the configuration for JDBC persistence.

If the remote Infinispan has been used in a single-site setup solely for keeping user sessions across Keycloak restarts, remove the remote Infinispan configuration for those caches.

If the remote Infinispan is used in a multi-site setup, you can reduce the resource consumption by the external Infinispan by configuring the number of entries in memory. Use the settings outlined in Deploy Infinispan for HA with the Infinispan Operator guide.
Rolling restart of Keycloak to activate the new cache configuration XML.

Signing out existing users
In previous versions and when the feature is disabled, a restart of all Keycloak nodes logged out all users. To sign out all online users sessions of a realm with the persistent-user-sessions feature enabled, use the following steps as before:

Log in to the Admin Console.

Select the menu entry Sessions.

Select the action Sign out all active sessions.

Metrics for embedded caches enabled by default
Metrics for the embedded caches are now enabled by default. To enable histograms for latencies, set the option cache-metrics-histograms-enabled to true.

Metrics for HTTP endpoints enabled by default
The metrics provided by Keycloak now include HTTP server metrics starting with http_server. See below for some examples.

http_server_active_requests 1.0
http_server_requests_seconds_count{method="GET",outcome="SUCCESS",status="200",uri="/realms/{realm}/protocol/{protocol}/auth"} 1.0
http_server_requests_seconds_sum{method="GET",outcome="SUCCESS",status="200",uri="/realms/{realm}/protocol/{protocol}/auth"} 0.048717142
Use the new options http-metrics-histograms-enabled and http-metrics-slos to enable default histogram buckets or specific buckets for service level objectives (SLOs). Read more about histograms in the Prometheus documentation about histograms on how to use the additional metrics series provided in http_server_requests_seconds_bucket.

Argon2 password hashing
In Keycloak 24 release, we had a change in the password hashing algorithm which resulted in an increased CPU usage. To address that, we opted to a different default hashing algorithm Argon2 for non-FIPS environments which brings the CPU usage back to where it was prior to the Keycloak 24 release.

Expected improvement in overall CPU usage and temporary increased database activity
The Concepts for sizing CPU and memory resources in the Keycloak High Availability guide have been updated to reflect the new hashing defaults.

After the upgrade, during a password-based login, the user’s passwords will be re-hashed with the new hash algorithm and hash iterations as a one-off activity and updated in the database. As this clears the user from Keycloak’s internal cache, you’ll also see an increased read activity on the database level. This increased database activity will decrease over time as more and more user’s passwords have been re-hashed.

Updated JVM garbage collection settings
To support the memory intensive nature of Argon2, we have updated the default GC from ParallelGC to G1GC for a better heap utilization. Please monitor the JVM heap utilization closely after this upgrade. Additional tuning may be necessary depending on your specific workload.

Limiting memory usage when consuming HTTP responses
In some scenarios like brokering Keycloak uses HTTP to talk to external servers. To avoid a denial of service when those providers send too much data, Keycloak now restricts responses to 10 MB by default.

Users can configure this limit by setting the provider configuration option spi-connections-http-client-default-max-consumed-response-size:

Restricting the consumed responses to 1 MB
bin/kc.[sh|bat] --spi-connections-http-client-default-max-consumed-response-size=1000000
Hostname Verification Policy
The default for spi-truststore-file-hostname-verification-policy and the new tls-hostname-verifier option is now DEFAULT, rather than WILDCARD. The WILDCARD and STRICT option values have been deprecated - you should simply rely upon DEFAULT instead.

Behavior supported by WILDCARD, that is not supported by DEFAULT: * allows wildcards in subdomain names (e.g. *.foo.com) to match anything, including multiple levels (e.g. a.b.foo.com). * allows matching against well known public suffixes - e.g. foo.co.gl may match *.co.gl

Behavior supported by STRICT, that is not supported by DEFAULT: * STRICT uses a small exclusion list for 2 or 3 letter domain names ending in a 2 letter top level (*.XXX.YY) when determining if a wildcard matches. Instead DEFAULT uses a more complete list of public suffix rules and exclusions from https://publicsuffix.org/list/

It is not expected that you should be relying upon these behaviors from the WILDCARD or STRICT options.

Addressed 'You are already logged in' for expired authentication sessions
Keycloak now does not display the message You are already logged in to the end user when an authentication session expires and user is already logged-in. Instead it redirects the error about the expired authentication session to the client application, so the client can act on it and restart authentication as described in the Server Administration Guide authentication sessions chapter. You may consider updating your applications to being able to handle this error.

Removed a model module
The module org.keycloak:keycloak-model-legacy module was deprecated in a previous release and is removed in this release. Use the org.keycloak:keycloak-model-storage module instead.

XA Transaction Changes
The option transaction-xa-enabled will default to false, rather than true. If you want XA transaction support you will now need to explicitly set this option to true.

XA Transaction recovery support is enabled by default. Transaction logs will be stored at KEYCLOAK_HOME/data/transaction-logs.

Removed offline session preloading
The old behavior to preload offline sessions at startup is now removed after it has been deprecated in the previous release.

Specify cache options at runtime
Options cache, cache-stack, and cache-config-file are no longer build options, and they can be specified only during runtime. This eliminates the need to execute the build phase and rebuild your image due to them. Be aware that they will not be recognized during the build phase, so you need to remove them from the build phase and add them to the runtime phase. If you do not add your current caching options to the runtime phase, Keycloak will fall back to the default caching settings.

kcadm and kcreg changes
How kcadm and kcreg parse and handle options and parameters has changed. Error messages from usage errors, the wrong option or parameter, may be slightly different than previous versions. Also usage errors will have an exit code of 2 instead of 1.

Removing custom user attribute indexes
When searching for users by user attribute, Keycloak no longer searches for user attribute names forcing lower case comparisons. This means Keycloak’s native index on the user attribute table will now be used when searching. If you have created your own index based on `lower(name)`to speed up searches, you can now remove it.

New default client scope basic
The new client scope named basic is added as a realm "default" client scope and hence will be added to all newly created OIDC clients. The client scope is also automatically added to all existing OIDC clients during migration.

This scope contains preconfigured protocol mappers for the following claims:

sub (See the details below in the dedicated section)

auth_time

This provides additional help to reduce the number of claims in a lightweight access token, but also gives the chance to configure claims that were always added automatically.

In case you already have client scope named basic in some of your realms, then the new client scope basic will not be added to your realm and will not be added to any clients. The migration would be ignored for this particular case. In that case, you either need to make sure to rename your client scope to something different than basic before you migrate to this Keycloak version or you need to manually deal with missing sub and auth_time claims in case you need them in your tokens and you may need to manually add corresponding protocol mappers to some of your client scopes.
Removed session_state claim
The session_state claim, which contains the same value as the sid claim, is now removed from all tokens as it is not required according to the OpenID Connect Front-Channel Logout and OpenID Connect Back-Channel Logout specifications. The session_state claim remains present in the Access Token Response in accordance with OpenID Connect Session Management specification.

Note that the setSessionState() method is also removed from the IDToken class in favor of the setSessionId() method, and the getSessionState() method is now deprecated.

A new Session State (session_state) mapper is also included and can be assigned to client scopes (for instance basic client scope) to revert to the old behavior.

If an old version of the JS adapter is used, the Session State (session_state) mapper should also be used by using client scopes as described above.

sub claim is added to access token via protocol mapper
The sub claim, which was always added to the access token, is now added by default but using a new Subject (sub) protocol mapper.

The Subject (sub) mapper is configured by default in the basic client scope. Therefore, no extra configuration is required after upgrading to this version.

If you are using the Pairwise subject identifier mapper to map a sub claim for an access token, you can consider disabling or removing the Subject (sub) mapper, however it is not strictly needed as the Subject (sub) protocol mapper is executed before the Pairwise subject identifier mapper and hence the pairwise value will override the value added by Subject (sub) mapper. This may apply also to other custom protocol mapper implementations, which override the sub claim, as the Subject (sub) mapper is currently executed as first protocol mapper.

You can use the Subject (sub) mapper to configure the sub claim only for access token, lightweight access token, and introspection response. IDToken and Userinfo always contain sub claim.

The mapper has no effects for service accounts, because no user session exists, and the sub claim is always added to the access token.

Nonce claim is only added to the ID token
The nonce claim is now only added to the ID token strictly following the OpenID Connect Core 1.0 specification. As indicated in the specification, the claim is compulsory inside the ID token when the same parameter was sent in the authorization request. The specification also recommends to not add the nonce after a refresh request. Previously, the claim was set to all the tokens (Access, Refresh and ID) in all the responses (refresh included).

A new Nonce backwards compatible mapper is also included in the software that can be assigned to client scopes to revert to the old behavior. For example, the JS adapter checked the returned nonce claim in all the tokens before fixing issue #26651 in version 24.0.0. Therefore, if an old version of the JS adapter is used, the mapper should be added to the required clients by using client scopes.

Changed userId for events related to refresh token
The userId in the REFRESH_TOKEN event is now always taken from user session instead of sub claim in the refresh token. The userId in the REFRESH_TOKEN_ERROR event is now always null. The reason for this change is that the value of the sub claim in the refresh token may be null with the introduction of the optional sub claim or even different from the real user id when using pairwise subject identifiers or other ways to override the sub claim.

However a refresh_token_sub detail is now added as backwards compatibility to have info about the user in the case of missing userId in the REFRESH_TOKEN_ERROR event.

Using older javascript adapter
If you use the latest Keycloak server with older versions of the javascript adapter in your applications, you may be affected by the token changes mentioned above as previous versions of javascript adapter rely on the claims, which were added by Keycloak, but not supported by the OIDC specification. This includes:

Adding the Session State (session_state) mapper in case of using the Keycloak Javascript adapter 24.0.3 or older

Adding the Nonce backwards compatible mapper in case of using a Keycloak Javascript adapter that is older than Keycloak 24

You can add the protocol mappers directly to the corresponding client or to some client scope, which can be used by your client applications relying on older versions of the Keycloak Javascript adapter. Some more details are in the previous sections dedicated to session_state and nonce claims.

Default http-pool-max-threads reduced
http-pool-max-threads if left unset will default to the greater of 50 or 4 x (available processors). Previously it defaulted to the greater of 200 or 8 x (available processors). Reducing the number or task threads for most usage scenarios will result in slightly higher performance due to less context switching among active threads.

Management port for metrics and health endpoints
The /health and /metrics endpoints are accessible on the management port 9000, which is turned on by default. That means these endpoints are no longer exposed to the standard Keycloak ports 8080 and 8443.

In order to reflect the old behavior, use the property --legacy-observability-interface=true, which will not expose these endpoints on the management port. However, this property is deprecated and will be removed in future releases, so it is recommended not to use it.

The management interface uses a different HTTP server than the default Keycloak HTTP server, and it is possible to configure them separately. Beware, if no values are supplied for the management interface properties, they are inherited from the default Keycloak HTTP server.

For more details, see Configuring the Management Interface.

Escaping slashes in group paths
Keycloak has never escaped slashes in the group paths. Because of that, a group named group/slash child of top uses the full path /top/group/slash, which is clearly misleading. Starting with this version, the server can be started to perform escaping of those slashes in the name:

bin/kc.[sh|bat] start --spi-group-jpa-escape-slashes-in-group-path=true
The escape char is the tilde character ~. The previous example results in the path /top/group~/slash. The escape marks the last slash is part of the name and not a hierarchy separator.

The escaping is currently disabled by default because it represents a change in behavior. Nevertheless enabling escaping is recommended and it can be the default in future versions.

Change to class EnvironmentDependentProviderFactory
The method EnvironmentDependentProviderFactory.isSupported() was deprecated for several releases and has now been removed.

Instead, implement isSupported(Config.Scope config).

Removal of the deprecated LinkedIn provider
In version 22.0.2 the OAuh 2.0 social provider for LinkedIn was replaced by a new OpenId Connect implementation. The legacy provider was deprecated but not removed, just in case it was still functional in some existing realms. Keycloak 25.0.0 is definitely removing the old provider and its associated linkedin-oauth feature. From now on, the default LinkedIn social provider is the only option available.

Improved performance of findGrantedResources and findGrantedOwnerResources queries
These queries performed poorly when the RESOURCE_SERVER_RESOURCE and RESOURCE_SERVER_PERM_TICKET tables had over 100k entries and users were granted access to over 1k resources. The queries were simplified and new indexes for the requester and owner columns were introduced.

The new indexes are both applied to the RESOURCE_SERVER_PERM_TICKET table. If the table currently contains more than 300.000 entries, Keycloak will skip the creation of the indexes by default during the automatic schema migration, and will instead log the SQL statements on the console during migration. In this case, the statements must be run manually in the DB after Keycloak’s startup.

See the Upgrading Guide for details on how to configure a different limit.

Removing deprecated methods from AccessToken, IDToken, and JsonWebToken classes
The following methods were removed from the AccessToken class:

expiration. Use the exp method instead.

notBefore. Use the nbf method instead.

issuedAt. Use the iat method instead.

The following methods were removed from the IDToken class:

getAuthTime and setAuthTime. Use the getAuth_time and setAuth_time methods, respectively.

notBefore. Use the nbf method instead.

issuedAt. Use the iat method instead.

setSessionState. Use the setSessionId method instead (See the details above in the section about session_state claim)

The following methods were removed from the JsonWebToken class:

expiration. Use the exp method instead.

notBefore. Use the nbf method instead.

issuedAt. Use the iat method instead.

You should also expect both exp and nbf claims not set in tokens as they are optional. Previously, these claims were being set with a value of 0 what does not make mush sense because their value should be a valid NumericDate.

Method getExp added to SingleUseObjectKeyModel
As a consequence of the removal of deprecated methods from AccessToken, IDToken, and JsonWebToken, the SingleUseObjectKeyModel also changed to keep consistency with the method names related to expiration values.

The previous getExpiration method is now deprecated and you should prefer using new newly introduced getExp method to avoid overflow after 2038.

Method encode deprecated on PasswordHashProvider
Method String encode(String rawPassword, int iterations) on the interface org.keycloak.credential.hash.PasswordHashProvider is deprecated. The method will be removed in one of the future Keycloak releases. It might be Keycloak 27 release.

CollectionUtil intersection method removed
The method org.keycloak.common.util.CollectionUtil.intersection has been removed. You should use the 'java.util.Collection.retainAll' instead on an existing collection.

Resteasy util class is deprecated
org.keycloak.common.util.Resteasy has been deprecated. You should use the org.keycloak.util.KeycloakSessionUtil to obtain the KeycloakSession instead.

It is highly recommended to avoid obtaining the KeycloakSession by means other than when creating your custom provider.

Small changes in session lifespan and idle calculations
In previous versions the session max lifespan and idle timeout calculation was slightly different when validating if a session was still valid. Since now that validation uses the same code than the rest of the project.

If the session is using the remember me feature, the idle timeout and max lifespan are the maximum value between the common SSO and the remember me configuration values.

External Infinispan requirements
Keycloak now requires a Infinispan server version of at least 15.0.0 for external Infinispan deployments. An external Infinispan deployment is supported for multi-site setups as outlined in the HA guide.

Oracle Database driver not part of the distribution
The Oracle Database JDBC driver is no longer part of the Keycloak distribution. If you wish to use Oracle DB, you must manually install a version of the Oracle Driver that is compatible with your specific environment. Instructions for this process can be found in the Configuring the database guide.

Deprecated theme variables
The following variables were deprecated in the Admin theme and will be removed in a future version:

authServerUrl. Use serverBaseUrl instead.

authUrl. Use adminBaseUrl instead.

The following variables were deprecated in the Account theme and will be removed in a future version:

authServerUrl. Use serverBaseUrl instead, note serverBaseUrl does not include trailing slash.

authUrl. Use serverBaseUrl instead, note serverBaseUrl does not include trailing slash.

Methods to get and set current refresh token in client session are now deprecated
The methods String getCurrentRefreshToken(), void setCurrentRefreshToken(String currentRefreshToken), int getCurrentRefreshTokenUseCount(), and void setCurrentRefreshTokenUseCount(int currentRefreshTokenUseCount) in the interface org.keycloak.models.AuthenticatedClientSessionModel are deprecated. They have been replaced by similar methods that require an identifier as a parameter such as getRefreshToken(String reuseId) to manage multiple refresh tokens within a client session. The methods will be removed in one of the future Keycloak releases. It might be Keycloak 27 release.

Migrating to 24.0.4
Partial update to user attributes when updating users through the Admin User API is no longer supported
Edit this section
Report an issue
When updating user attributes through the Admin User API, you cannot execute partial updates when updating the user attributes, including the root attributes like username, email, firstName, and lastName.

If you are updating user attributes through the Admin User API without passing all the attributes that the administrator has write permissions, the missing attributes will be removed. On the other hand, if an attribute is marked as read-only for administrators, not sending the attribute won’t remove it.

See the User Profile Documentation for the details about the user profile settings.

Migrating to 24.0.3
Changes to the org.keycloak.userprofile.UserProfileDecorator interface
Edit this section
Report an issue
To properly support multiple user storage providers within a realm, the org.keycloak.userprofile.UserProfileDecorator interface has changed.

The decorateUserProfile method is no longer invoked when parsing the user profile configuration for the first time (and caching it), but every time a user is being managed through the user profile provider. As a result, the method changed its contract to:

List<AttributeMetadata> decorateUserProfile(String providerId, UserProfileMetadata metadata)
Differently than the previous contract and behavior, this method is only invoked for the user storage provider from where the user was loaded from.

Changes in redirect URI verification when using wildcards
Because of security concerns, the redirect URI verification now performs a exact string matching (no wildcard involved) if the passed redirect uri contains a userinfo part or its path accesses parent directory (/../).

The full wildcard * can still be used as a valid redirect in development for http(s) URIs with those characteristics. In production environments a exact valid redirect URI without wildcard needs to be configured for any URI of that type.

Please note that wildcard valid redirect URIs are not recommended for production and not covered by the OAuth 2.0 specification.

Deprecated Account REST endpoint for removing credential
The Account REST endpoint for removing the credential of the user is deprecated. Starting at this version, the Account Console no longer uses this endpoint. It is replaced by the Delete Credential application-initiated action, which is triggered by the Account Console when a user want to remove the credential of a user.

Migrating to 24.0.2
Changes to Password Hashing
Edit this section
Report an issue
The release notes for Keycloak 24.0.0 have been updated with corrected description of the expected performance impact for the change, as well as sizing guide.

Migrating to 24.0.0
Changes to the Welcome theme
Edit this section
Report an issue
The 'welcome' theme has has been updated to use a new layout and now uses PatternFly 5, rather than PatternFly 3. If you are extending the theme, or providing your own, you may need to update it as follows:

Migrate from PatternFly 3 to PatternFly 5
The welcome theme was one of the more outdated themes in Keycloak. It was originally based on PatternFly 3, but has now been updated to use PatternFly 5, skipping a major version in the process. If your custom theme extends the built-in theme, you will need to update it to use PatternFly 5 syntax. Consult the PatternFly 5 documentation for details.

If you are still using PatternFly 3 in your own custom theme (not extending the built-in one), you can continue to use it, but PatternFly 3 support will be removed in a future release, so you should consider migrating to PatternFly 5 as soon as possible.

Automatic redirect to the Admin Console
If the Admin Console is enabled, the welcome page will automatically redirect to it if the administrative user already exists. This behavior can be modified by setting the redirectToAdmin in your theme.properties file. By default, the property is set to false, unless you are extending the built-in theme, in which case, the property is set to true.

The documentationUrl and displayCommunityLinks properties have been removed.
These properties were previously used for navigational elements that are now no longer present. If you are extending the built-in theme, you will need to remove these properties from your theme.properties file, as they no longer have any effect.

Assets are now loaded from 'common' resources
Images such as the background, logo and favicon are now loaded from the 'common' resources, rather than the theme resources. This change means that if you are extending the built-in theme, and are overwriting these images, you will need to move them to the 'common' resources of your theme, and update your theme.properties file to include the new paths:

# This defaults to 'common/keycloak' if not set.
import=common/your-theme-name
Changes to the Account Console theme customization
If you were previously extending the now deprecated version 2 of the Account Console theme, you will need to update your theme to use the new version 3 of the Account Console theme. The new version of the Account Console theme comes with some changes in regards to how it is customized. To start with a clean slate, you can follow the new customization quickstart.

To move your custom theme start by changing the parent to the new theme:

# Before
parent=keycloak.v2

# After
parent=keycloak.v3
If you have any custom React components, you will import React directly, rather than using a relative path:

// Before
import * as React from "../../../../common/keycloak/web_modules/react.js";

// After
import React from "react";
If you are using content.json to customize the theme there are some changes to the structure of the file, specifically:

The content property has been renamed to children.

The id, icon and componentName properties have been removed, as modulePath provides the same functionality.

Keycloak JS imports might need to be updated
If you are loading Keycloak JS directly from the Keycloak server, this section can be safely ignored. If you are loading Keycloak JS from the NPM package and are using a bundler like Webpack, Vite, and so on, you might need to make some changes to your code. The Keycloak JS package now uses the exports field in the package.json file. This means that you might have to change your imports:

// Before
import Keycloak from 'keycloak-js/dist/keycloak.js';
import AuthZ from 'keycloak-js/dist/keycloak-authz.js';

// After
import Keycloak from 'keycloak-js';
import AuthZ from 'keycloak-js/authz';
Features Changes
It is no longer allowed to have the same feature in both the --features and --features-disabled list. The feature should appear in only one list.

The usage of unversioned feature names, such as docker, in the --features list will allow for the most supported / latest feature version to be enabled for you. If you need more predictable behavior across releases, reference the particular version you want instead, such as docker:v1.

User Profile Changes
User profile enabled by default
The user profile feature is now enabled by default. The `declarative-user-profile`feature is no longer available, because the user profile is assumed to be enabled. Therefore, the User Profile Enabled switch is removed from the Realm Settings and replaced by Unmanaged attributes. When migrating from previous version, the behavior is as follows:

For the deployments where User Profile Enabled was set to ON, Unmanaged attributes will be set to OFF after the upgrade. As a result, only user attributes supported explicitly by user profile will be allowed.

For the deployments where the User Profile Enabled was set to OFF (which was also the default settings for the deployments with declarative-user-profile feature disabled, which was the default), Unmanaged attributes will be set to ON` after the upgrade. As a result, the behavior should be basically the same as in previous versions with the user profile disabled. The Attributes tab will remain in the user details part of the Admin Console. Also users can now set arbitrary attributes through UI pages such as the registration page and update profile page as long as a particular custom theme supports it. The custom themes should work as before as well. However, consider updating your themes to use the user-profile and maybe even remove your custom themes if those themes were need to add custom attributes. See the subsequent section on themes. Also, consider toggling Unmanaged attributes to OFF or enable this switch only for administrators so that you can rely on mainly on using managed attributes.

See the User Profile Documentation for the details about the Unmanaged attributes.

Default validations
Default user profile configuration comes with a set of default validations for the basic predefined fields. Those validations were not present in previous versions when the declarative-user-profile feature was disabled by default. If you have issues due to backward compatibility, you can change the default validators according to your needs. The default validators are as follows:

The`username`, email, firstName and lastName attributes have a maximum length of 255 characters. These validations were indirectly present in previous versions as well because of the database constraint on the table USER_ENTITY for those fields with a maximum length of 255 characters. However, when using user storage providers, it might be possible before to use longer values.

The username attribute has a minimum length of three characters. Username has also username-prohibited-characters and up-username-not-idn-homograph validator by default, which were not present in previous versions. See the Validation section of the User Profile Documentation for the details about those attributes. Note that username is not editable by default unless you have the realm switch Edit username enabled. This change means that existing users with incorrect usernames should still work and they will not be enforced to update their usernames. But new users will be enforced to use correct usernames during their registration or creation by the admin REST API.

The firstName and lastName attributes have the person-name-prohibited-characters validator on them, which were not present in previous versions. See the Validation section of the User Profile Documentation for the details about those attributes. Note that both first name and last name are editable by default, so users, who already have such incorrect first/last name from a previous version will be forced to update them when updating their user profiles.

User attribute names with strange characters
In previous versions, you could create a user with attribute names such as some:attribute or some/attribute. The user profile intentionally does not allow you to create attributes with such strange names in the user profile configuration. So you may need to configure Unmanaged attributes for your realm and enable unmanaged attributes for administrators (ideally) or for end users (if really needed). Although it is strongly preferred to avoid using such attribute names.

Verify Profile required action enabled by default
The verify-profile required action is enabled by default for new realms. However, when you migrate from a previous version, your existing realms will have the same state of this verify-profile action as before, which usually means disabled as it was disabled by default in previous versions. For the details about this required action, see the User Profile Documentation.

Breaking changes to the User Profile SPI
If you are using the User Profile SPI in your extension, you might be impacted by the API changes introduced in this release.

The org.keycloak.userprofile.Attributes interface includes the following changes:

Method getValues was renamed to get to make it more aligned with the same operation from a regular Java Map

Method isRootAttribute was moved to the utility class org.keycloak.userprofile.UserProfileUtil.isRootAttribute

Method getFirstValue was renamed to getFirst to make it less verbose

Method getReadable(boolean) was removed and now all attributes (including root attributes) are returned whenever they have read rights.

Changes to Freemarker templates to render pages based on the user profile and realm
In this release, the following templates were updated to make it possible to dynamically render attributes based on the user profile configuration set to a realm:

login-update-profile.ftl

register.ftl

update-email.ftl

These templates are responsible for rendering the update profile (when the Update Profile required action is enabled for a user), the registration, and the update email (when the UPDATE_EMAIL feature is enabled) pages, respectively.

If you use a custom theme to change these templates, they will function as expected because only the content is updated. However, we recommend you to take a look at how to configure a {declarative user profile} and possibly avoid changing the built-in templates by using all the capabilities provided by this feature.

Also, the templates used by the declarative-user-profile feature to render the pages for the same flows are no longer necessary and removed in this release:

update-user-profile.ftl

register-user-profile.ftl

If you were using the declarative-user-profile feature in a previous release with customizations to the above templates, update the login-update-profile.ftl and register.ftl accordingly.

New Freemarker template for the update profile page at first login through a broker
In this release, the server will render the update profile page when the user is authenticating through a broker for the first time using the idp-review-user-profile.ftl template.

In previous releases, the template used to update the profile during the first broker login flow was the login-update-profile.ftl, the same used to update the profile when users are authenticating to a realm.

By using separate templates for each flow, a more clear distinction exist as to which flow a template is actually used rather than sharing a same template, and potentially introduce unexpected changes and behavior that should only affect pages for a specific flow.

If you have customizations to the login-update-profile.ftl template to customize how users update their profiles when authenticating through a broker, make sure to move your changes to the new template.

Truststore Changes
The spi-truststore-file-* options and the truststore related options https-trust-store-* are deprecated. Therefore, use the new default location for truststore material, conf/truststores, or specify your desired paths by using the truststore-paths option. For details, see the relevant guide.

The tls-hostname-verifier property should be used instead of the spi-truststore-file-hostname-verification-policy property.

A collateral effect of the changes is that now the truststore provider is always configured with some certificates (at least the default java trusted certificates are present). This new behavior can affect other parts of Keycloak.

For example, webauthn registration can fail if attestation conveyance was configured to Direct validation. Previously, if the truststore provider was not configured the incoming certificate was not validated. But now this validation is always performed. The registration fails with invalid cert path error as the certificate chain sent by the dongle is not trusted by Keycloak. The Certificate Authorities of the authenticator need to be present in the truststore provider to correctly perform the attestation.

Deprecated --proxy option
The --proxy option has been deprecated and will be removed in a future release. The following table explains how the deprecated option maps to supported options.

Deprecated usage	New usage
kc.sh (no proxy option set)

kc.sh

kc.sh --proxy none

kc.sh

kc.sh --proxy edge

kc.sh --proxy-headers forwarded|xforwarded --http-enabled true

kc.sh --proxy passthrough

kc.sh --hostname-port 80|443 (depending if HTTPS is used)

kc.sh --proxy reencrypt

kc.sh --proxy-headers forwarded|xforwarded

For hardened security, the --proxy-headers option does not allow selecting both forwarded and xforwarded values at the same time (as it was the case before for --proxy edge and --proxy reencrypt).
When using the proxy headers option, make sure your reverse proxy properly sets and overwrites the Forwarded or X-Forwarded-* headers respectively. To set these headers, consult the documentation for your reverse proxy. Misconfiguration will leave Keycloak exposed to security vulnerabilities.
You can also set the proxy headers when using the Operator:

apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: example-kc
spec:
  ...
  proxy:
    headers: forwarded|xforwarded
If the proxy.headers field is not specified, the Operator falls back to the previous behavior by implicitly setting proxy=passthrough by default. This results in deprecation warnings in the server log. This fallback will be removed in a future release.
Changes to the user representation in both Admin API and Account contexts
Both org.keycloak.representations.idm.UserRepresentation and org.keycloak.representations.account.UserRepresentation representation classes have changed so that the root user attributes (such as username, email, firstName, lastName, and locale) have a consistent representation when fetching or sending the representation payload to the Admin and Account APIS, respectively.

The username, email, firstName, lastName, and locale attributes were moved to a new org.keycloak.representations.idm.AbstractUserRepresentation base class.

Also the getAttributes method is targeted for representing only custom attributes, so you should not expect any root attribute in the map returned by this method. This method is mainly targeted for clients when updating or fetching any custom attribute for a give user.

In order to resolve all the attributes including the root attributes, a new getRawAttributes method was added so that the resulting map also includes the root attributes. However, this method is not available from the representation payload and it is targeted to be used by the server when managing user profiles.

https-client-auth is a build time option
Option https-client-auth had been treated as a run time option, however this is not supported by Quarkus. The option needs to be handled at build time instead.

Sequential loading of offline sessions and remote sessions
Starting with this release, the first member of a Keycloak cluster will load remote sessions sequentially instead of in parallel. If offline session preloading is enabled, those will be loaded sequentially as well.

The previous code led to high resource-consumption across the cluster at startup and was challenging to analyze in production environments and could lead to complex failure scenarios if a node was restarted during loading. Therefore, it was changed to sequential session loading.

For offline sessions, the default in this and previous versions of Keycloak is to load those sessions on demand, which scales better with a lot of offline sessions than the attempt to preload them in parallel. Setups that use this default setup are not affected by the change of the loading strategy for offline sessions. Setups that have offline session preloading enabled should migrate to a setup where offline-session preloading is disabled.

Deprecated offline session preloading
The default behavior of Keycloak is to load offline sessions on demand. The old behavior to preload them at startup is now deprecated, as preloading them at startup does not scale well with a growing number of sessions, and increases Keycloak memory usage. The old behavior will be removed in a future release.

To re-enable old behavior while it is deprecated and not removed yet, use the feature flag and the SPI option as shown below:

bin/kc.[sh|bat] start --features-enabled offline-session-preloading --spi-user-sessions-infinispan-preload-offline-sessions-from-database=true
The API of UserSessionProvider deprecated the method getOfflineUserSessionByBrokerSessionId(RealmModel realm, String brokerSessionId). Instead of this method, use getOfflineUserSessionByBrokerUserIdStream(RealmModel, String brokerUserId) to first get the sessions of a user, and then filter by the broker session ID as needed.

Infinispan metrics use labels for cache manager and cache names
When enabling metrics for Keycloak’s embedded caches, the metrics now use labels for the cache manager and the cache names.

Old metric example without labels
vendor_cache_manager_keycloak_cache_sessions_statistics_approximate_entries_in_memory{cache="sessions",node="..."}
New metric example with labels
vendor_statistics_approximate_entries_in_memory{cache="sessions",cache_manager="keycloak",node="..."}
To revert the change for an installation, use a custom Infinispan XML configuration and change the configuration as follows:

<metrics names-as-tags="false" />
User attribute value length extension
As of this release, Keycloak supports storing and searching by user attribute values longer than 255 characters, which was previously a limitation.

In setups where users are allowed to update attributes, for example, via the account console, prevent denial of service attacks by adding validations. Ensure that no unmanaged attributes are allowed and all editable attributes have a validation that limits the input length.

For unmanaged attributes, the maximum length is 2048 characters. For managed attributes, the default maximum length is 2048 characters. Administrator can change this by adding a validator of type length.

Keycloak caches user-related objects in its internal caches. Using longer attributes increases the memory that is consumed by the cache. Therefore, limiting the size of the length attributes is recommended. Consider storing large objects outside Keycloak and reference them by ID or URL.
This change adds new indexes on the tables USER_ATTRIBUTE and FED_USER_ATTRIBUTE. If those tables contain more than 300000 entries, Keycloak will skip the index creation by default during the automatic schema migration and instead log the SQL statement on the console during migration to be applied manually after Keycloak’s startup. See the Upgrading Guide for details on how to configure a different limit.

The newly added indexes USER_ATTR_LONG_VALUES_LOWER_CASE and FED_USER_ATTR_LONG_VALUES_LOWER_CASE may exceed the maximum limit of 30 characters set by Oracle, in case the database is running in compatibility mode. Since Oracle version 12.2, there is a support for longer index names.
Additional migration steps for LDAP
This is for installations that match all the following criteria:

User attributes in the LDAP directory are larger than 2048 characters or binary attributes that are larger than 1500 bytes.

The attributes are changed by admins or users via the admin console, the APIs or the account console.

To be able to enable changing those attributes via UI and REST APIs, perform the following steps:

Declare the attributes identified above as managed attributes in the user profile of the realm.

Define a length validator for each attribute added in the previous step specifying the desired minimum and maximum length of the attribute value. For binary values, add 33 percent to the expected binary length to count in the overhead for Keycloak’s internal base64 encoding of binary values.

Additional migration steps for custom user storage providers
This is for installations that match all the following criteria:

Running MariaDB or MySQL as a database for Keycloak.

Entries in table FED_USER_ATTRIBUTE with contents in the VALUE column that are larger than 2048 characters. This table is used for custom user providers which have federation enabled.

The long attributes are changed by admins or users via the admin console or the account console.

To be able to enable changing those attributes via UI and REST APIs, perform the following steps:

Declare the attributes identified above as managed attributes in the user profile of the realm.

Define a length validator for each attribute added in the previous step specifying the desired minimum and maximum length of the attribute value.

The Admin send-verify-email API now uses the same email verification template
PUT /admin/realms/{realm-name}/users/{id}/send-verify-email
In this release, the API will use the email-verification.ftl template instead of executeActions.ftl.

Before upgrading
Perform the following action(s): Verify Email
After upgrading
Confirm validity of e-mail address email@example.org.
If you have customized the executeActions.ftl template to modify how users verify their email using this API, ensure that you transfer your modifications to the new template.

A new parameter called lifespan will be introduced to allow overriding of the default lifespan value (12 hours).

If you prefer the previous behavior, use the execute-actions-email API as follows.

PUT /admin/realms/{realm-name}/users/{id}/execute-actions-email

["VERIFY_EMAIL"]
Removal of the deprecated mode for SAML encryption
The compatibility mode for SAML encryption introduced in version 21 is now removed. The system property keycloak.saml.deprecated.encryption is not managed anymore by the server. The clients which still used the old signing key for encryption should update it from the new IDP configuration metadata.

Changes to Password Hashing
In this release, we adapted the password hashing defaults to match the OWASP recommendations for Password Storage.

As part of this change, the default password hashing provider has changed from pbkdf2-sha256 to pbkdf2-sha512. Also, the number of default hash iterations for pbkdf2 based password hashing algorithms changed as follows:

Provider ID	Algorithm	Old Iterations	New Iterations
pbkdf2

PBKDF2WithHmacSHA1

20.000

1.300.000

pbkdf2-sha256

PBKDF2WithHmacSHA256

27.500

600.000

pbkdf2-sha512

PBKDF2WithHmacSHA512

30.000

210.000

If a realm does not explicitly configure a password policy with hashAlgorithm and hashIterations, then the new configuration will take effect on the next password based login, or when a user password is created or updated.

Performance of new password hashing configuration
Tests on a machine with an Intel i9-8950HK CPU (12) @ 4.800GHz yielded the following ⌀ time differences for hashing 1000 passwords (averages from 3 runs). Note that the average duration for the PBKDF2WithHmacSHA1 was computed with a lower number of passwords due to the long runtime.

Provider ID	Algorithm	Old duration	New duration	Difference
pbkdf2

PBKDF2WithHmacSHA1

122ms

3.114ms

+2.992ms

pbkdf2-sha256

PBKDF2WithHmacSHA256

20ms

451ms

+431ms

pbkdf2-sha512

PBKDF2WithHmacSHA512

33ms

224ms

+191ms

Users of the pbkdf2 provider might need to explicitly reduce the number of hash iterations to regain acceptable performance. This can be done by configuring the hash iterations explicitly in the password policy of the realm.

Expected increased overall CPU usage and temporary increased database activity
The Concepts for sizing CPU and memory resources in the Keycloak High Availability guide have been updated to reflect the new hashing defaults. The CPU usage per password-based login in our tests increased by the factor of five, which includes both the changed password hashing and unchanged TLS connection handling. The overall CPU increase should be around the factor of two to three due to the averaging effect of Keycloak’s other activities like refreshing access tokens and client credential grants. Still, this depends on the unique workload of an installation.

After the upgrade, during a password-based login, the user’s passwords will be re-hashed with the new hash algorithm and hash iterations as a one-off activity and updated in the database. As this clears the user from Keycloak’s internal cache, you will also see an increased read activity on the database level. This increased database activity will decrease over time as more and more user’s passwords have been re-hashed.

How to keep using the old pbkdf2-sha256 password hashing?
To keep the old password hashing for a realm, specify hashAlgorithm and hashIterations explicitly in the realm password policy.

Hashing Algorithm: pbkdf2-sha256

Hashing Iterations: 27500

Operator Referenced Resource Polling
Secrets and ConfigMaps referenced via the Keycloak CR will now be polled for changes, rather than watched via the api server. It may take around 1 minute for changes to be detected.

This was done so to not require label manipulation on those resources. After upgrading if any Secret still has the operator.keycloak.org/component label, it may be removed or ignored.

Renaming JPA provider configuration options for migration
After removal of the Map Store the following configuration options were renamed:

spi-connections-jpa-legacy-initialize-empty to spi-connections-jpa-quarkus-initialize-empty

spi-connections-jpa-legacy-migration-export to spi-connections-jpa-quarkus-migration-export

spi-connections-jpa-legacy-migration-strategy to spi-connections-jpa-quarkus-migration-strategy

Renaming model modules
After removal of the Map Store the following modules were renamed:

org.keycloak:keycloak-model-legacy-private to org.keycloak:keycloak-model-storage-private

org.keycloak:keycloak-model-legacy-services to org.keycloak:keycloak-model-storage-services

and org.keycloak:keycloak-model-legacy module was deprecated and will be removed in the next release in favour of org.keycloak:keycloak-model-storage module.

Temporary lockout log replaced with event
There is now a new event USER_DISABLED_BY_TEMPORARY_LOCKOUT when a user is temporarily locked out by the brute force protector. The log with ID KC-SERVICES0053 has been removed as the new event offers the information in a structured form.

As it is a success event, the new event is logged by default at the DEBUG level. Use the setting spi-events-listener-jboss-logging-success-level as described in the Event listener chapter in the Server Administration Guide to change the log level of all success events.

To trigger custom actions or custom log entries, write a custom event listener as described in the Event Listener SPI in the Server Developer Guide.

Operator Customization Property Keys
The property keys used by the operator for advanced configuration have changed from operator.keycloak to kc.operator.keycloak.

Keycloak CR resources options
When no resources options are specified in the Keycloak CR and KeycloakRealmImport CR, default values are used. The default requests memory for Keycloak deployment and the realm import Job is set to 1700MiB, and the limits memory is set to 2GiB.

Updates to cookies
As part of refactoring cookie handling in Keycloak there are some changes to how cookies are set:

All cookies will now have the secure attribute set if the request is through a secure context

WELCOME_STATE_CHECKER cookies now set SameSite=Strict

For custom extensions there may be some changes needed:

LocaleSelectorProvider.KEYCLOAK_LOCALE is deprecated as cookies are now managed through the CookieProvider

HttpResponse.setWriteCookiesOnTransactionComplete has been removed

HttpCookie is deprecated, please use NewCookie.Builder instead

ServerCookie is deprecated, please use NewCookie.Builder instead

Internal algorithm changed from HS256 to HS512
The algorithm that Keycloak uses to sign internal tokens (a JWT which is consumed by Keycloak itself, for example a refresh or action token) is being changed from HS256 to the more secure HS512. A new key provider named hmac-generated-hs512 is now added for realms. Note that in migrated realms the old hmac-generated provider and the old HS256 key are maintained and still validate tokens issued before the upgrade. The HS256 provider can be manually deleted when no more old tokens exist following the rotating keys guidelines.

Different JVM memory settings when running in a container
The JVM options -Xms and -Xmx were replaced by -XX:InitialRAMPercentage and -XX:MaxRAMPercentage when running in a container. Instead of the static maximum heap size settings, Keycloak specifies the maximum as 70% of the total container memory.

As the heap size is dynamically calculated based on the total container memory, you should always set the memory limit for the container.

If the memory limit is not set, the memory consumption rapidly increases as the maximum heap size grows up to 70% of the total container memory.
For more details, see the Running Keycloak in a container guide.

GELF log handler has been deprecated
With sunsetting of the underlying library providing integration with GELF, Keycloak will no longer support the GELF log handler out-of-the-box. This feature will be removed in a future release. If you require an external log management, consider using file log parsing.

