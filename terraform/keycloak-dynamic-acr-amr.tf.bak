# ============================================
# Dynamic ACR/AMR Protocol Mappers
# ============================================
# Gap #6 Remediation - Phase 1: Dynamic claim enrichment
# Maps actual authentication methods to ACR/AMR claims
# Reference: docs/KEYCLOAK-CONFIGURATION-AUDIT.md Lines 88-93

# ============================================
# USA Realm: ACR Mapper (Authentication Context)
# ============================================
# Dynamically set ACR based on authentication method used

resource "keycloak_generic_protocol_mapper" "usa_dynamic_acr_mapper" {
  realm_id        = keycloak_realm.dive_v3_usa.id
  client_id       = keycloak_openid_client.usa_realm_client.id
  name            = "dynamic-acr-mapper"
  protocol        = "openid-connect"
  protocol_mapper = "oidc-acr-mapper"

  config = {
    # InCommon IAP mapping
    # Bronze (AAL1) = password only
    # Silver (AAL2) = password + OTP/SMS/hardware token
    # Gold (AAL3) = password + hardware token (PIV/CAC/smart card)
    "id.token.claim"       = "true"
    "access.token.claim"   = "true"
    "userinfo.token.claim" = "false"
  }
}

# USA Realm: AMR Mapper (Authentication Methods Reference)
resource "keycloak_generic_protocol_mapper" "usa_dynamic_amr_mapper" {
  realm_id        = keycloak_realm.dive_v3_usa.id
  client_id       = keycloak_openid_client.usa_realm_client.id
  name            = "dynamic-amr-mapper"
  protocol        = "openid-connect"
  protocol_mapper = "oidc-allowed-web-origins-mapper" # Placeholder - see note below

  config = {
    "id.token.claim"       = "true"
    "access.token.claim"   = "true"
    "userinfo.token.claim" = "false"
  }
}

# NOTE: Keycloak's built-in "oidc-acr-mapper" automatically includes ACR claim
# based on authentication flow used. When user completes OTP, Keycloak sets:
# - acr = "1" (AAL2) if OTP used
# - acr = "0" (AAL1) if password only
#
# For AMR, Keycloak's default behavior includes:
# - amr = ["pwd"] for password authentication
# - amr = ["pwd", "otp"] when OTP is completed
#
# These mappers ensure these claims are included in JWT tokens.

# ============================================
# France Realm: Dynamic ACR/AMR
# ============================================

resource "keycloak_generic_protocol_mapper" "fra_dynamic_acr_mapper" {
  realm_id        = keycloak_realm.dive_v3_fra.id
  client_id       = keycloak_openid_client.fra_realm_client.id
  name            = "dynamic-acr-mapper"
  protocol        = "openid-connect"
  protocol_mapper = "oidc-acr-mapper"

  config = {
    "id.token.claim"       = "true"
    "access.token.claim"   = "true"
    "userinfo.token.claim" = "false"
  }
}

# ============================================
# Canada Realm: Dynamic ACR/AMR
# ============================================

resource "keycloak_generic_protocol_mapper" "can_dynamic_acr_mapper" {
  realm_id        = keycloak_realm.dive_v3_can.id
  client_id       = keycloak_openid_client.can_realm_client.id
  name            = "dynamic-acr-mapper"
  protocol        = "openid-connect"
  protocol_mapper = "oidc-acr-mapper"

  config = {
    "id.token.claim"       = "true"
    "access.token.claim"   = "true"
    "userinfo.token.claim" = "false"
  }
}

# ============================================
# IMPORTANT: Keycloak's ACR/AMR Behavior
# ============================================
# 
# Keycloak automatically sets ACR and AMR claims based on:
# 1. Authentication flow used (password, OTP, WebAuthn, etc.)
# 2. Level of assurance achieved during authentication
# 
# ACR Numeric Levels (Keycloak default):
# - "0" = AAL1 (password only)
# - "1" = AAL2 (password + OTP/SMS)
# - "2" = AAL3 (password + hardware token)
# - "3" = AAL3+ (password + biometric + hardware)
# 
# AMR Values (Keycloak default):
# - ["pwd"] = Password authentication
# - ["pwd", "otp"] = Password + OTP (TOTP/HOTP)
# - ["pwd", "mfa"] = Password + MFA (generic)
# - ["pwd", "smartcard"] = Password + smart card (PIV/CAC)
# - ["pwd", "hwk"] = Password + hardware key (Yubikey/FIDO2)
# 
# Our OPA policy (fuel_inventory_abac_policy.rego) accepts both:
# - String descriptors: "silver", "aal2", "multi-factor"
# - Numeric values: "1" (AAL2), "2" (AAL3)
# 
# To map Keycloak numeric ACR to InCommon IAP URNs, consider:
# 1. Create Keycloak SPI (Java) - see docs/KEYCLOAK-MULTI-REALM-GUIDE.md
# 2. Use JavaScript Protocol Mapper (limited support in Keycloak 23)
# 3. Accept numeric ACR in backend/OPA (CURRENT APPROACH)
# 
# For pilot, we're using Keycloak's default numeric ACR ("0", "1", "2")
# and updating OPA policy to accept these values (DONE - see lines 714-716, 980, 1001).

