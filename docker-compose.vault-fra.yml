# =============================================================================
# DIVE V3 - Vault Integration Overlay for FRA Instance
# =============================================================================
# Usage: docker compose -f docker-compose.fra.yml -f docker-compose.vault-fra.yml up -d
# =============================================================================

services:
  # Vault sync init container for FRA
  keycloak-vault-sync-fra:
    image: google/cloud-sdk:slim
    container_name: dive-v3-vault-sync-fra
    volumes:
      - keycloak_vault_fra:/opt/keycloak/vault
      - ./config:/config:ro
      - ./scripts/vault/sync-secrets-to-files.sh:/sync.sh:ro
      - ${GCP_SA_KEY_FILE:-./gcp/fra-sa-key.json}:/gcp/service-account.json:ro
    environment:
      INSTANCE: fra
      REALM: dive-v3-broker
      VAULT_DIR: /opt/keycloak/vault
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-dive25}
      GOOGLE_APPLICATION_CREDENTIALS: /gcp/service-account.json
      REGISTRY_FILE: /config/federation-registry.json
    entrypoint: ["/bin/bash", "-c"]
    command: ["gcloud auth activate-service-account --key-file=/gcp/service-account.json && /sync.sh"]
    restart: "no"
    networks:
      - dive-fra-network

  # Override keycloak-fra to add vault configuration
  keycloak-fra:
    depends_on:
      keycloak-vault-sync-fra:
        condition: service_completed_successfully
      postgres-fra:
        condition: service_healthy
    volumes:
      - ./keycloak/certs:/opt/keycloak/certs:ro
      - ./keycloak/themes:/opt/keycloak/themes:ro
      - keycloak_vault_fra:/opt/keycloak/vault:ro
    command: >
      start-dev
      --spi-login-protocol-openid-connect-suppress-logout-confirmation-screen=true
      --features=scripts
      --vault=file
      --vault-dir=/opt/keycloak/vault
      --spi-vault-file-key-resolvers=REALM_UNDERSCORE_KEY

volumes:
  keycloak_vault_fra:
    driver: local

networks:
  dive-fra-network:
    external: true
    name: fra_dive-fra-network

