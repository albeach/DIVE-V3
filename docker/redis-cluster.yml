# DIVE V3 - Redis Sentinel Cluster
# Phase 7: Production Hardening
# 
# Provides high-availability Redis cluster with:
# - Master/replica replication
# - Sentinel for automatic failover
# - Password authentication
# - Distributed cache invalidation
#
# Architecture:
#   redis-master (6379) <-- redis-replica-1 (6380)
#         |               <-- redis-replica-2 (6381)
#         v
#   sentinel-1 (26379)
#   sentinel-2 (26380)
#   sentinel-3 (26381)
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker/redis-cluster.yml up -d
#
# @version 1.0.0
# @date 2025-12-03

version: '3.8'

networks:
  dive-network:
    external: true
    name: dive-v3_dive-network

volumes:
  redis-master-data:
  redis-replica-1-data:
  redis-replica-2-data:

services:
  # =============================================================================
  # Redis Master
  # =============================================================================
  redis-master:
    image: redis:7.2-alpine
    container_name: dive-v3-redis-master
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-}
      --masterauth ${REDIS_PASSWORD:-}
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
      --loglevel notice
    ports:
      - "6379:6379"
    networks:
      - dive-network
    volumes:
      - redis-master-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # Redis Replica 1
  # =============================================================================
  redis-replica-1:
    image: redis:7.2-alpine
    container_name: dive-v3-redis-replica-1
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-}
      --masterauth ${REDIS_PASSWORD:-}
      --replicaof redis-master 6379
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --loglevel notice
    ports:
      - "6380:6379"
    networks:
      - dive-network
    volumes:
      - redis-replica-1-data:/data
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # Redis Replica 2
  # =============================================================================
  redis-replica-2:
    image: redis:7.2-alpine
    container_name: dive-v3-redis-replica-2
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-}
      --masterauth ${REDIS_PASSWORD:-}
      --replicaof redis-master 6379
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --loglevel notice
    ports:
      - "6381:6379"
    networks:
      - dive-network
    volumes:
      - redis-replica-2-data:/data
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # Sentinel 1
  # =============================================================================
  redis-sentinel-1:
    image: redis:7.2-alpine
    container_name: dive-v3-sentinel-1
    restart: unless-stopped
    entrypoint: >
      sh -c "
        cat > /tmp/sentinel.conf << EOF
      port 26379
      sentinel monitor mymaster redis-master 6379 2
      sentinel auth-pass mymaster ${REDIS_PASSWORD:-}
      sentinel down-after-milliseconds mymaster 5000
      sentinel failover-timeout mymaster 60000
      sentinel parallel-syncs mymaster 1
      sentinel resolve-hostnames yes
      sentinel announce-hostnames yes
      EOF
        redis-server /tmp/sentinel.conf --sentinel
      "
    ports:
      - "26379:26379"
    networks:
      - dive-network
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica-1:
        condition: service_healthy
      redis-replica-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # =============================================================================
  # Sentinel 2
  # =============================================================================
  redis-sentinel-2:
    image: redis:7.2-alpine
    container_name: dive-v3-sentinel-2
    restart: unless-stopped
    entrypoint: >
      sh -c "
        cat > /tmp/sentinel.conf << EOF
      port 26379
      sentinel monitor mymaster redis-master 6379 2
      sentinel auth-pass mymaster ${REDIS_PASSWORD:-}
      sentinel down-after-milliseconds mymaster 5000
      sentinel failover-timeout mymaster 60000
      sentinel parallel-syncs mymaster 1
      sentinel resolve-hostnames yes
      sentinel announce-hostnames yes
      EOF
        redis-server /tmp/sentinel.conf --sentinel
      "
    ports:
      - "26380:26379"
    networks:
      - dive-network
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica-1:
        condition: service_healthy
      redis-replica-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # =============================================================================
  # Sentinel 3
  # =============================================================================
  redis-sentinel-3:
    image: redis:7.2-alpine
    container_name: dive-v3-sentinel-3
    restart: unless-stopped
    entrypoint: >
      sh -c "
        cat > /tmp/sentinel.conf << EOF
      port 26379
      sentinel monitor mymaster redis-master 6379 2
      sentinel auth-pass mymaster ${REDIS_PASSWORD:-}
      sentinel down-after-milliseconds mymaster 5000
      sentinel failover-timeout mymaster 60000
      sentinel parallel-syncs mymaster 1
      sentinel resolve-hostnames yes
      sentinel announce-hostnames yes
      EOF
        redis-server /tmp/sentinel.conf --sentinel
      "
    ports:
      - "26381:26379"
    networks:
      - dive-network
    depends_on:
      redis-master:
        condition: service_healthy
      redis-replica-1:
        condition: service_healthy
      redis-replica-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s





