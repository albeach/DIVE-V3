# =============================================================================
# DIVE V3 - Base Docker Compose Template
# =============================================================================
# This file contains reusable service definitions using YAML anchors.
# Instance-specific compose files extend these definitions.
#
# Best Practice: DRY (Don't Repeat Yourself) - define once, use everywhere
# =============================================================================

# -----------------------------------------------------------------------------
# YAML Anchors - Reusable Service Definitions
# -----------------------------------------------------------------------------

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

# -----------------------------------------------------------------------------
# PostgreSQL Base Definition
# -----------------------------------------------------------------------------
x-postgres: &postgres-base
  image: postgres:15-alpine
  restart: unless-stopped
  logging: *default-logging
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD-SHELL", "pg_isready -U postgres"]
    start_period: 30s

# -----------------------------------------------------------------------------
# Keycloak Base Definition
# -----------------------------------------------------------------------------
x-keycloak: &keycloak-base
  image: quay.io/keycloak/keycloak:latest
  platform: linux/amd64
  restart: unless-stopped
  logging: *default-logging
  command: start-dev --spi-login-protocol-openid-connect-suppress-logout-confirmation-screen=true --features=scripts
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /realms/master HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && head -1 <&3 | grep -q 'HTTP/1.1 200'"]

# -----------------------------------------------------------------------------
# MongoDB Base Definition
# -----------------------------------------------------------------------------
x-mongodb: &mongodb-base
  image: mongo:7
  restart: unless-stopped
  logging: *default-logging
  healthcheck:
    <<: *healthcheck-defaults
    test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
    start_period: 30s

# -----------------------------------------------------------------------------
# Redis Base Definition
# -----------------------------------------------------------------------------
x-redis: &redis-base
  image: redis:7-alpine
  restart: unless-stopped
  logging: *default-logging
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD", "redis-cli", "ping"]
    start_period: 10s

# -----------------------------------------------------------------------------
# OPA (Open Policy Agent) Base Definition
# -----------------------------------------------------------------------------
x-opa: &opa-base
  image: openpolicyagent/opa:latest
  restart: unless-stopped
  logging: *default-logging
  command:
    - run
    - --server
    - --addr=0.0.0.0:8181
    - --tls-cert-file=/certs/certificate.pem
    - --tls-private-key-file=/certs/key.pem
    - --bundle
    - /policies
    - --log-level=info
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD", "wget", "--no-check-certificate", "-qO-", "https://localhost:8181/health"]
    start_period: 30s

# -----------------------------------------------------------------------------
# KAS (Key Access Service) Base Definition
# -----------------------------------------------------------------------------
x-kas: &kas-base
  build:
    context: ../../kas
    dockerfile: Dockerfile
  restart: unless-stopped
  logging: *default-logging
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD", "wget", "--no-check-certificate", "-qO-", "https://localhost:8080/health"]

# -----------------------------------------------------------------------------
# Backend API Base Definition
# -----------------------------------------------------------------------------
x-backend: &backend-base
  build:
    context: ../../backend
    dockerfile: Dockerfile.dev
  restart: unless-stopped
  logging: *default-logging
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD-SHELL", "wget --no-check-certificate -qO- https://localhost:4000/health || exit 1"]

# -----------------------------------------------------------------------------
# Frontend Base Definition
# -----------------------------------------------------------------------------
x-frontend: &frontend-base
  build:
    context: ../../frontend
    dockerfile: Dockerfile.dev
  restart: unless-stopped
  logging: *default-logging
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD-SHELL", "wget --no-check-certificate -qO- https://localhost:3000 || exit 1"]
    start_period: 120s

# -----------------------------------------------------------------------------
# Cloudflare Tunnel Base Definition
# -----------------------------------------------------------------------------
x-cloudflared: &cloudflared-base
  image: cloudflare/cloudflared:latest
  restart: unless-stopped
  logging: *default-logging
  command: tunnel --config /etc/cloudflared/config.yml run






