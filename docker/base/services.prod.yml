# =============================================================================
# DIVE V3 - Production Docker Compose Service Templates
# =============================================================================
# Production-ready services with pre-built images and optimized settings.
# Use these for pilot, staging, and production deployments.
#
# Key Differences from services.yml (dev):
#   - Uses production Dockerfiles (multi-stage builds)
#   - No hot reload or npm install at runtime
#   - Optimized healthcheck intervals
#   - NODE_ENV=production
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL - Database Backend
  # ---------------------------------------------------------------------------
  postgres-base:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-keycloak}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # MongoDB - Resource Metadata Store
  # ---------------------------------------------------------------------------
  mongodb-base:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/27017'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Redis - Session/Cache Store
  # ---------------------------------------------------------------------------
  redis-base:
    image: redis:7.2-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Keycloak - Identity Provider/Broker (Production Mode)
  # ---------------------------------------------------------------------------
  keycloak-base:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION:-26.4.7}
    restart: unless-stopped
    entrypoint: ["/bin/bash", "/opt/keycloak/scripts/import-realm.sh"]
    command: ["start", "--optimized", "--spi-login-protocol-openid-connect-suppress-logout-confirmation-screen=true"]
    environment:
      KC_DB: postgres
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HTTPS_PORT: "8443"
      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_FEATURES: scripts
      KEYCLOAK_ADMIN: admin
    healthcheck:
      test: ["CMD-SHELL", "curl -ksf https://localhost:8443/health/ready || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # OPA - Open Policy Agent (Policy Decision Point)
  # ---------------------------------------------------------------------------
  opa-base:
    image: openpolicyagent/opa:latest
    platform: linux/amd64
    restart: unless-stopped
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
      - "--log-format=json"
      - "/policies"
    healthcheck:
      test: ["CMD", "/opa", "version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # KAS - Key Access Service (Production)
  # ---------------------------------------------------------------------------
  kas-base:
    build:
      context: ../../kas
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "8080"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate -q -O- https://localhost:8080/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Backend API - Policy Enforcement Point (Production)
  # ---------------------------------------------------------------------------
  backend-base:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "4000"
      # SECURITY: Production should use properly issued certificates
      # NODE_EXTRA_CA_CERTS only needed if using internal CAs
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:4000/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Frontend - Next.js Application (Production)
  # ---------------------------------------------------------------------------
  frontend-base:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.prod
    restart: unless-stopped
    environment:
      NODE_ENV: production
      # SECURITY: Production should use properly issued certificates
    extra_hosts:
      - "localhost:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "curl -ksf https://localhost:3000/ >/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # OPAL Client - Policy Sync from Hub
  # ---------------------------------------------------------------------------
  opal-client-base:
    image: permitio/opal-client:latest
    restart: unless-stopped
    environment:
      OPAL_INLINE_OPA_ENABLED: "false"
      OPAL_LOG_LEVEL: ${OPAL_LOG_LEVEL:-INFO}
      OPAL_KEEP_ALIVE_TIMEOUT: "60"
      OPAL_RECONNECT_INTERVAL: "5"
      OPAL_RECONNECT_MAX_INTERVAL: "300"
      OPAL_POLICY_REFRESH_INTERVAL: "60"
      OPAL_POLICY_STORE_TYPE: "OPA"
      SSL_CERT_FILE: /var/opal/certs/mkcert-rootCA.pem
      REQUESTS_CA_BUNDLE: /var/opal/certs/mkcert-rootCA.pem
      WEBSOCKET_SSL_CERT: /var/opal/certs/mkcert-rootCA.pem
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # OPAL Server - Policy Distribution Hub
  # ---------------------------------------------------------------------------
  opal-server-base:
    image: permitio/opal-server:latest
    restart: unless-stopped
    environment:
      OPAL_LOG_LEVEL: ${OPAL_LOG_LEVEL:-INFO}
      OPAL_REPO_WATCHER_ENABLED: "true"
      OPAL_DATA_TOPICS_DEFAULT: policy_data
      UVICORN_PORT: 7002
      UVICORN_HOST: 0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:7002/healthcheck"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Cloudflare Tunnel - Secure External Access
  # ---------------------------------------------------------------------------
  cloudflared-base:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"


