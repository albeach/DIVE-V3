# ğŸ”§ Fix: Configuration Error After Multi-Realm Switch

**Issue**: `http://localhost:3000/?error=Configuration` when logging in  
**Cause**: Broker client has different secret than original client  
**Solution**: Get broker client secret and update .env files

---

## ğŸ¯ The Problem

When you switched from `dive-v3-pilot` to `dive-v3-broker`:
- Client ID changed: `dive-v3-client` â†’ `dive-v3-client-broker`
- Client Secret: Different (auto-generated by Keycloak)
- Frontend/Backend: Using old client secret â†’ **Authentication fails**

---

## âœ… Solution: Get Correct Broker Client Secret

### Step 1: Get Broker Client Secret from Keycloak Admin Console

**Method A: Via Admin Console (Easiest)**

1. Go to: http://localhost:8081/admin
2. Login: admin / admin
3. Select Realm: **dive-v3-broker** (dropdown top-left)
4. Click: **Clients** (left menu)
5. Find and click: **dive-v3-client-broker**
6. Go to: **Credentials** tab
7. Copy the **Client secret** value

**Method B: Via Terraform (If you have jq)**

```bash
cd terraform

# This might work if Keycloak provider exposes it:
terraform show | grep -A 5 "dive-v3-client-broker" | grep client_secret

# Or check Keycloak directly:
# Get admin token, then query client
```

---

### Step 2: Update .env Files with Correct Secret

**Update Root `.env.local`**:
```env
KEYCLOAK_REALM=dive-v3-broker
KEYCLOAK_CLIENT_ID=dive-v3-client-broker
KEYCLOAK_CLIENT_SECRET=<paste-broker-secret-here>
```

**Update `frontend/.env.local`**:
```env
KEYCLOAK_REALM=dive-v3-broker
KEYCLOAK_CLIENT_ID=dive-v3-client-broker
KEYCLOAK_CLIENT_SECRET=<paste-same-secret-here>

NEXT_PUBLIC_KEYCLOAK_REALM=dive-v3-broker
```

---

### Step 3: Restart Services

```bash
# Terminal 1 - Backend
cd backend
# Ctrl+C to stop
npm run dev
# Should log: "KEYCLOAK_CLIENT_ID: dive-v3-client-broker"

# Terminal 2 - Frontend
cd frontend
# Ctrl+C to stop
npm run dev
# Wont for "Ready on http://localhost:3000"
```

---

## ğŸ”„ Alternative: Revert to Single Realm (Temporary)

If you want to test the existing features first before multi-realm:

**Revert `.env.local` files**:
```env
KEYCLOAK_REALM=dive-v3-pilot
KEYCLOAK_CLIENT_ID=dive-v3-client
KEYCLOAK_CLIENT_SECRET=8AcfbgtdNIZp3tbrcmc2voiUfxNb8d6L
```

**Then restart** - everything will work with single realm

**When ready for multi-realm**:
- Get broker client secret
- Update .env files
- Restart services

---

## ğŸ¯ Expected Behavior After Fix

### With Correct Broker Client Secret

**Login Flow**:
1. Go to http://localhost:3000
2. Click "Login"
3. Redirected to Keycloak broker realm
4. **See 4 IdP choices:**
   - United States (DoD)
   - France (MinistÃ¨re des ArmÃ©es)
   - Canada (Forces canadiennes)
   - Industry Partners (Contractors)
5. Select one â†’ Login â†’ Success!

### With Incorrect Client Secret

**Error**:
- `http://localhost:3000/?error=Configuration`
- Backend logs: "invalid_client" or authentication errors
- Frontend logs: NextAuth configuration error

---

## ğŸ“‹ Quick Fix Checklist

- [ ] Get broker client secret from Keycloak admin console
- [ ] Update root `.env.local` with correct secret
- [ ] Update `frontend/.env.local` with same secret
- [ ] Verify both files saved
- [ ] Restart backend (Ctrl+C, then `npm run dev`)
- [ ] Restart frontend (Ctrl+C, then `npm run dev`)
- [ ] Test: http://localhost:3000 â†’ Login
- [ ] Expected: See 4 IdP choices

---

## ğŸ” How to Verify It's Fixed

### Backend Logs Should Show:
```
KEYCLOAK_REALM: dive-v3-broker âœ…
KEYCLOAK_CLIENT_ID: dive-v3-client-broker âœ…
Backend API started on port 4000 âœ…
```

### Frontend Logs Should Show:
```
Ready on http://localhost:3000 âœ…
No NextAuth errors âœ…
```

### Browser Should Show:
```
Login â†’ Keycloak â†’ 4 IdP choices âœ…
NOT: error=Configuration âŒ
```

---

## ğŸ’¡ Understanding Multi-Realm Client Setup

### Original Single-Realm
```
dive-v3-pilot realm:
â””â”€â”€ Client: dive-v3-client
    â””â”€â”€ Secret: 8AcfbgtdNIZp3tbrcmc2voiUfxNb8d6L
```

### New Multi-Realm
```
dive-v3-broker realm:
â””â”€â”€ Client: dive-v3-client-broker
    â””â”€â”€ Secret: <DIFFERENT - auto-generated by Keycloak>
```

**Each client has its own secret!** You must use the broker client's secret.

---

## ğŸš€ Quick Resolution

**Fastest path**:

1. Open Keycloak Admin: http://localhost:8081/admin
2. Switch to: dive-v3-broker realm
3. Go to: Clients â†’ dive-v3-client-broker â†’ Credentials
4. Copy client secret
5. Update both .env.local files
6. Restart services
7. Test!

**Estimated time**: 5 minutes

---

**Status**: Known issue, easy fix  
**Root Cause**: Different client secrets for different clients  
**Solution**: Get broker client secret from Keycloak admin console

ğŸ‘‰ **Get the secret, update .env files, restart â†’ Fixed!**


