#!/usr/local/bin/bash
# =============================================================================
# DIVE V3 CLI - Modular Unified Management Script
# =============================================================================
# Usage:
#   ./dive [options] [command] [subcommand] [args...]
#
# Global Options:
#   --env local|gcp|pilot    Set environment (default: local)
#   --instance usa|fra|deu   Set instance (default: usa)
#   --dry-run                Show what would be done without executing
#   --verbose                Show detailed output
#   --quiet                  Suppress non-essential output
#
# Examples:
#   ./dive up                      # Start locally with defaults
#   ./dive --dry-run deploy        # Preview full deployment
#   ./dive --env gcp up            # Start with GCP secrets
#   ./dive pilot up                # Start on remote pilot VM
# =============================================================================

set -e

# Project root
DIVE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export DIVE_ROOT

# Modules directory
MODULES_DIR="${DIVE_ROOT}/scripts/dive-modules"

# =============================================================================
# LOAD COMMON MODULE
# =============================================================================

if [ -f "${MODULES_DIR}/common.sh" ]; then
    source "${MODULES_DIR}/common.sh"
    export DIVE_COMMON_LOADED=1
else
    echo "ERROR: Common module not found at ${MODULES_DIR}/common.sh"
    echo "Please ensure the dive-modules directory exists."
    exit 1
fi

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

# Parse global options
while [[ $# -gt 0 ]]; do
    case "$1" in
        --env)
            ENVIRONMENT="$2"
            shift 2
            ;;
        --instance)
            INSTANCE="$2"
            export INSTANCE
            shift 2
            ;;
        --dry-run|-n)
            DRY_RUN=true
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        -h|--help)
            source "${MODULES_DIR}/help.sh"
            cmd_help
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Guard against misplaced global flags after the command
for arg in "$@"; do
    if [[ "$arg" == "--instance" || "$arg" == "--env" ]]; then
        log_error "Place global flags before the command. Example: ./dive --instance usa secrets load"
        exit 1
    fi
done

# =============================================================================
# MAIN COMMAND DISPATCH
# =============================================================================

COMMAND="${1:-help}"
shift || true

cd "$DIVE_ROOT"

case "$COMMAND" in
    # Core commands (core.sh)
    up|down|restart|logs|ps|exec)
        source "${MODULES_DIR}/core.sh"
        case "$COMMAND" in
            up)      cmd_up "$@" ;;
            down)    cmd_down "$@" ;;
            restart) cmd_restart "$@" ;;
            logs)    cmd_logs "$@" ;;
            ps)      cmd_ps "$@" ;;
            exec)    cmd_exec "$@" ;;
        esac
        ;;

    # Status commands (status.sh)
    status|health|validate|info|diagnostics|brief)
        source "${MODULES_DIR}/status.sh"
        case "$COMMAND" in
            status)   cmd_status "$@" ;;
            health)   cmd_health "$@" ;;
            diagnostics) cmd_diagnostics "$@" ;;
            validate) cmd_validate "$@" ;;
            info)     cmd_info "$@" ;;
            brief)    cmd_status_brief "$@" ;;
        esac
        ;;

    # Deployment commands (deploy.sh)
    deploy|reset|clean|nuke)
        source "${MODULES_DIR}/deploy.sh"
        case "$COMMAND" in
            deploy) cmd_deploy "$@" ;;
            reset)  cmd_reset "$@" ;;
            clean)  cmd_reset "$@" ;;
            nuke)   cmd_nuke "$@" ;;
        esac
        ;;

    # Database commands (db.sh)
    seed|backup|restore)
        source "${MODULES_DIR}/db.sh"
        case "$COMMAND" in
            seed)    cmd_seed "$@" ;;
            backup)  cmd_backup ;;
            restore) cmd_restore "$@" ;;
        esac
        ;;

    # Terraform commands (terraform.sh)
    tf|terraform)
        source "${MODULES_DIR}/terraform.sh"
        module_terraform "$@"
        ;;

    # Secrets commands (secrets.sh)
    secrets)
        source "${MODULES_DIR}/secrets.sh"
        module_secrets "$@"
        ;;

    # Orchestration database commands (orchestration-state-db.sh)
    orchestration-db|orch-db|odb)
        source "${MODULES_DIR}/orchestration-state-db.sh"
        case "${1:-help}" in
            migrate|migrate-state)
                shift
                orch_db_migrate_state_files "$@"
                ;;
            validate|validate-consistency)
                shift
                orch_db_validate_consistency "$@"
                ;;
            rollback|rollback-state)
                shift
                orch_db_rollback_state "$@"
                ;;
            status|db-status)
                shift
                if orch_db_check_connection; then
                    echo "‚úÖ Orchestration database is connected"
                    state_count=$(orch_db_exec "SELECT COUNT(*) FROM deployment_states" 2>/dev/null || echo "0")
                    echo "üìä State records: $state_count"
                    transition_count=$(orch_db_exec "SELECT COUNT(*) FROM state_transitions" 2>/dev/null || echo "0")
                    echo "üîÑ Transition records: $transition_count"
                else
                    echo "‚ùå Orchestration database is not available"
                fi
                ;;
            *)
                echo "DIVE V3 Orchestration Database Management"
                echo "=========================================="
                echo ""
                echo "Commands:"
                echo "  ./dive orch-db migrate              Migrate existing .dive-state files to database"
                echo "  ./dive orch-db validate             Validate consistency between files and database"
                echo "  ./dive orch-db rollback <instance>  Rollback last state transition for instance"
                echo "  ./dive orch-db status               Show database connection and statistics"
                echo ""
                echo "Examples:"
                echo "  ./dive orch-db migrate              # Migrate all state files"
                echo "  ./dive orch-db validate NZL         # Check consistency for NZL"
                echo "  ./dive orch-db rollback NZL         # Rollback NZL to previous state"
                ;;
        esac
        ;;

    # Pilot VM commands (pilot.sh)
    pilot)
        source "${MODULES_DIR}/pilot.sh"
        module_pilot "$@"
        ;;

    # Federation commands (federation.sh)
    federation|fed)
        source "${MODULES_DIR}/federation.sh"
        module_federation "$@"
        ;;

    # Hub commands (hub.sh - Phase 3 enhanced spoke management)
    hub)
        source "${MODULES_DIR}/hub.sh"
        module_hub "$@"
        ;;

    # Spoke commands (spoke.sh)
    spoke)
        source "${MODULES_DIR}/spoke.sh"
        module_spoke "$@"
        ;;

    # SP Client commands (sp.sh)
    sp)
        source "${MODULES_DIR}/sp.sh"
        module_sp "$@"
        ;;

    # Policy commands (policy.sh)
    policy)
        source "${MODULES_DIR}/policy.sh"
        module_policy "$@"
        ;;

    # Certificate commands (certificates.sh)
    certs|certificates)
        source "${MODULES_DIR}/certificates.sh"
        module_certificates "$@"
        ;;

    # Naming conventions (naming.sh)
    naming)
        source "${MODULES_DIR}/naming.sh"
        module_naming "$@"
        ;;

    # Federation setup commands (federation-setup.sh)
    federation-setup|fed-setup)
        source "${MODULES_DIR}/federation-setup.sh"
        module_federation_setup "$@"
        ;;

    # Test commands (test.sh) - Phase 4: Testing & Validation
    test)
        TEST_TARGET="${1:-help}"
        shift || true
        case "$TEST_TARGET" in
            orchestration|orch)
                source "${MODULES_DIR}/orchestration-test-framework.sh"
                orch_test_run_category "$@"
                ;;
            multi-instance|multi)
                source "${MODULES_DIR}/multi-instance-test.sh"
                case "${1:-help}" in
                    concurrent)
                        multi_test_concurrent_all
                        ;;
                    staggered)
                        multi_test_staggered_deployment
                        ;;
                    federation)
                        multi_test_federation_scaling
                        ;;
                    load)
                        multi_load_test
                        ;;
                    cleanup)
                        multi_test_cleanup_all
                        ;;
                    *)
                        echo "Multi-Instance Test Commands:"
                        echo "  ./dive test multi concurrent     Run concurrent deployment test"
                        echo "  ./dive test multi staggered      Run staggered deployment test"
                        echo "  ./dive test multi federation     Test federation scaling"
                        echo "  ./dive test multi load           Run load testing scenarios"
                        echo "  ./dive test multi cleanup        Clean up test instances"
                        ;;
                esac
                ;;
            all)
                source "${MODULES_DIR}/orchestration-test-framework.sh"
                orch_test_run_all
                ;;
            unit)
                source "${MODULES_DIR}/orchestration-test-framework.sh"
                orch_test_run_category "unit"
                ;;
            integration)
                source "${MODULES_DIR}/orchestration-test-framework.sh"
                orch_test_run_category "integration"
                ;;
            resilience)
                source "${MODULES_DIR}/orchestration-test-framework.sh"
                orch_test_run_category "resilience"
                ;;
            performance)
                source "${MODULES_DIR}/orchestration-test-framework.sh"
                orch_test_run_category "performance"
                ;;
            *)
                echo "DIVE V3 Testing Framework - Phase 4"
                echo "==================================="
                echo ""
                echo "Orchestration Tests (Phase 3 Validation):"
                echo "  ./dive test all                    Run complete test suite"
                echo "  ./dive test unit                   Run unit tests only"
                echo "  ./dive test integration            Run integration tests"
                echo "  ./dive test resilience             Run resilience tests"
                echo "  ./dive test performance            Run performance tests"
                echo "  ./dive test orchestration <type>   Run specific orchestration tests"
                echo ""
                echo "Multi-Instance Tests (Enterprise Validation):"
                echo "  ./dive test multi concurrent       Concurrent NATO deployments"
                echo "  ./dive test multi staggered        Staggered deployment testing"
                echo "  ./dive test multi federation       Federation scaling tests"
                echo "  ./dive test multi load             Load testing scenarios"
                echo "  ./dive test multi cleanup          Clean up test instances"
                echo ""
                echo "Test Coverage:"
                echo "  ‚úÖ Circuit breaker functionality"
                echo "  ‚úÖ Smart retry algorithms"
                echo "  ‚úÖ State management integrity"
                echo "  ‚úÖ Error handling & recovery"
                echo "  ‚úÖ Checkpoint & rollback"
                echo "  ‚úÖ Real-time metrics"
                echo "  ‚úÖ Multi-instance concurrent deployments"
                echo "  ‚úÖ Federation scaling validation"
                echo "  ‚úÖ Enterprise load testing"
                ;;
        esac
        ;;

    # Verify commands - Phase 6
    verify)
        VERIFY_TARGET="${1:-help}"
        shift || true
        case "$VERIFY_TARGET" in
            hub)
                source "${MODULES_DIR}/hub.sh"
                hub_verify "$@"
                ;;
            spoke)
                source "${MODULES_DIR}/spoke.sh"
                spoke_verify "$@"
                ;;
            *)
                echo -e "${BOLD}DIVE Verify Commands (Phase 6):${NC}"
                echo ""
                echo "Usage:"
                echo "  ./dive verify hub                    10-point hub verification"
                echo "  ./dive verify spoke                  12-point spoke verification"
                echo "  ./dive --instance <code> verify spoke   Verify specific spoke"
                echo ""
                ;;
        esac
        ;;

    # Environment helpers (status.sh)
    env)
        source "${MODULES_DIR}/status.sh"
        cmd_env_print "$@"
        ;;

    # Fix command - run federation fixes
    fix)
        FIX_TARGET="${1:-all}"
        shift || true
        case "$FIX_TARGET" in
            federation|fed)
                # Run federation issues fix script
                if [ -n "$INSTANCE" ] && [ "$INSTANCE" != "usa" ]; then
                    bash "${DIVE_ROOT}/scripts/fix-federation-issues.sh" --spoke "$(echo "$INSTANCE" | tr '[:lower:]' '[:upper:]')"
                else
                    bash "${DIVE_ROOT}/scripts/fix-federation-issues.sh" "$@"
                fi
                ;;
            hub)
                bash "${DIVE_ROOT}/scripts/fix-federation-issues.sh" --hub-only
                ;;
            spoke)
                if [ -n "$INSTANCE" ]; then
                    bash "${DIVE_ROOT}/scripts/fix-federation-issues.sh" --spoke "$(echo "$INSTANCE" | tr '[:lower:]' '[:upper:]')"
                else
                    log_error "Specify instance with --instance <CODE> or use: ./dive fix federation"
                    exit 1
                fi
                ;;
            session-resilience|session|token)
                # Run session token resilience fix deployment
                log_info "Deploying Session Token Resilience Fix..."

                if [ -n "$INSTANCE" ]; then
                    # Deploy to specific instance
                    bash "${DIVE_ROOT}/scripts/dive-modules/deploy-session-resilience-fix.sh" "$(echo "$INSTANCE" | tr '[:lower:]' '[:upper:]')"
                else
                    # Deploy to all instances
                    bash "${DIVE_ROOT}/scripts/dive-modules/deploy-session-resilience-fix.sh" --all
                fi
                ;;
            diagnose-session|session-diagnose)
                # Run session diagnostics
                if [ -z "$1" ]; then
                    log_error "Usage: ./dive fix diagnose-session <user-email>"
                    log_info "Example: ./dive fix diagnose-session testuser-usa-4@mil"
                    exit 1
                fi

                bash "${DIVE_ROOT}/scripts/diagnose-session-token-flow.sh" "$1"
                ;;
            all)
                bash "${DIVE_ROOT}/scripts/fix-federation-issues.sh" "$@"
                ;;
            *)
                echo -e "${BOLD}DIVE Fix Commands:${NC}"
                echo ""
                echo "Usage:"
                echo "  ./dive fix federation                Fix all federation issues (hub + all spokes)"
                echo "  ./dive fix hub                       Fix hub logout/redirect issues only"
                echo "  ./dive --instance ALB fix spoke      Fix specific spoke federation"
                echo "  ./dive fix session-resilience        Deploy session token resilience fix"
                echo "  ./dive fix diagnose-session <email>  Diagnose session/token issues for user"
                echo "  ./dive fix all                       Fix all federation issues"
                echo ""
                echo "Federation Fixes:"
                echo "  1. Logout redirect to internal container name"
                echo "  2. 'Invalid parameter: redirect_uri' errors"
                echo "  3. Cross-border IdP not loading"
                echo ""
                echo "Session Resilience Fixes:"
                echo "  - Automatic token refresh in API routes"
                echo "  - Race condition handling (session callback vs API routes)"
                echo "  - Improved error messages"
                echo ""
                ;;
        esac
        ;;

    # Redis commands (redis.sh)
    redis)
        source "${MODULES_DIR}/redis.sh"
        module_redis "$@"
        ;;

    # KAS commands (kas.sh)
    kas)
        source "${MODULES_DIR}/kas.sh"
        module_kas "$@"
        ;;

    # Help
    help|--help|-h)
        source "${MODULES_DIR}/help.sh"
        cmd_help
        ;;

    # Unknown command
    *)
        log_error "Unknown command: $COMMAND"
        echo ""
        echo "Run './dive help' for usage information."
        exit 1
        ;;
esac

