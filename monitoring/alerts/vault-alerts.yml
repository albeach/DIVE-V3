#
# DIVE V3 Vault HA Cluster Alerting Rules
# Phase 4: Vault Monitoring & Automated Backups
#
# Monitors: 4-container Vault HA cluster (seal + 3-node Raft)
# Metrics source: /v1/sys/metrics?format=prometheus (unauthenticated)
#
# Verified metric names against Vault 1.21.0 OSS telemetry output.
#

groups:
  - name: vault_cluster_alerts
    interval: 30s
    rules:
      # -----------------------------------------------------------------------
      # SEAL STATUS — Critical: sealed node cannot serve requests
      # -----------------------------------------------------------------------
      - alert: VaultNodeSealed
        expr: vault_core_unsealed == 0
        for: 1m
        labels:
          severity: critical
          service: vault
        annotations:
          summary: "Vault node is sealed"
          description: "{{ $labels.instance }} has been sealed for more than 1 minute. Auto-unseal may have failed."

      # -----------------------------------------------------------------------
      # AUTOPILOT HEALTH — Warning: cluster health degraded
      # -----------------------------------------------------------------------
      - alert: VaultAutopilotUnhealthy
        expr: vault_autopilot_healthy == 0
        for: 2m
        labels:
          severity: warning
          service: vault
        annotations:
          summary: "Vault autopilot reports cluster unhealthy"
          description: "Autopilot has reported the cluster as unhealthy for >2m. Check node status."

      # -----------------------------------------------------------------------
      # LEADERSHIP — Warning: frequent elections indicate instability
      # -----------------------------------------------------------------------
      - alert: VaultLeadershipFlapping
        expr: changes(vault_core_active[5m]) > 2
        for: 1m
        labels:
          severity: warning
          service: vault
        annotations:
          summary: "Vault leadership is flapping"
          description: "Leader changed {{ $value }} times in 5 minutes. Check network and disk health."

      # -----------------------------------------------------------------------
      # BARRIER LATENCY — Warning: slow storage operations
      # -----------------------------------------------------------------------
      - alert: VaultHighBarrierLatency
        expr: vault_barrier_get{quantile="0.99"} > 50
        for: 5m
        labels:
          severity: warning
          service: vault
        annotations:
          summary: "Vault storage barrier p99 latency is high (>50ms)"
          description: "p99 barrier get latency is {{ $value }}ms on {{ $labels.instance }}"

      # -----------------------------------------------------------------------
      # SEAL VAULT — Critical: Transit auto-unseal depends on this
      # -----------------------------------------------------------------------
      - alert: VaultSealNodeDown
        expr: up{job="vault-cluster",service="vault-seal"} == 0
        for: 2m
        labels:
          severity: critical
          service: vault-seal
        annotations:
          summary: "Vault seal node is down"
          description: "The Transit seal vault has been unreachable for >2m. Cluster nodes will fail to auto-unseal on restart."

      # -----------------------------------------------------------------------
      # CLUSTER NODE DOWN — Warning: a Raft node is unreachable
      # -----------------------------------------------------------------------
      - alert: VaultClusterNodeDown
        expr: up{job="vault-cluster",service="vault"} == 0
        for: 2m
        labels:
          severity: warning
          service: vault
        annotations:
          summary: "Vault cluster node is down"
          description: "{{ $labels.instance }} has been unreachable for >2m. Raft cluster operating with reduced capacity."

      # -----------------------------------------------------------------------
      # FOLLOWER LAG — Warning: follower falling behind leader
      # -----------------------------------------------------------------------
      - alert: VaultFollowerLagging
        expr: vault_raft_storage_follower_applied_index_delta > 100
        for: 2m
        labels:
          severity: warning
          service: vault
        annotations:
          summary: "Vault Raft follower is lagging behind leader"
          description: "Follower {{ $labels.peer_id }} has index delta of {{ $value }}. Check disk I/O and network."

  - name: vault_lease_alerts
    interval: 60s
    rules:
      # -----------------------------------------------------------------------
      # LEASE EXPIRY — Warning: high rate of expiring leases
      # -----------------------------------------------------------------------
      - alert: VaultHighLeaseExpiryRate
        expr: rate(vault_expire_num_leases[5m]) < -10
        for: 5m
        labels:
          severity: warning
          service: vault
        annotations:
          summary: "High Vault lease expiry rate"
          description: "Leases are expiring at {{ $value }}/s. Services may be failing to renew credentials."
