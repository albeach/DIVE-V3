# DIVE V3 - Secrets & Infrastructure Audit Prompt

## ğŸš¨ CRITICAL ISSUE IDENTIFIED

The current deployment has **NO Single Source of Truth (SSOT)** for secrets. Secrets exist in multiple locations with NO synchronization:

1. **GCP Secret Manager** - Contains secrets that are NOT being used
2. **Terraform** - Generates NEW secrets on every apply (client secrets)
3. **docker-compose.yml files** - Have HARDCODED secrets inline
4. **.tfvars files** - Have HARDCODED admin passwords
5. **.env.gcp file** - Manual copy that gets stale immediately

This results in:
- Keycloak admin passwords that don't match between Terraform and running containers
- Client secrets generated by Terraform that are NEVER synced to GCP or docker-compose
- Backend containers that can't authenticate to Keycloak
- Complete deployment failures

---

## ğŸ“‹ AUDIT OBJECTIVES

### Phase 1: Discovery & Documentation
1. **Identify ALL secret locations** in the codebase
2. **Map secret dependencies** - which service needs which secret
3. **Document current secret flow** - how secrets move (or don't) between systems
4. **Identify hardcoded secrets** in ALL files (not just obvious ones)

### Phase 2: Architecture Design
1. **Define SSOT** - GCP Secret Manager should be THE source
2. **Design sync mechanism** - How Terraform-generated secrets get to GCP
3. **Design consumption pattern** - How containers get secrets at runtime
4. **Eliminate hardcoding** - No secrets in ANY file in version control

### Phase 3: Implementation
1. **Update Terraform** to either:
   - READ existing secrets from GCP (for admin passwords)
   - WRITE generated secrets TO GCP (for client secrets)
2. **Update docker-compose files** to use ONLY environment variables
3. **Create sync-secrets.sh** that:
   - Fetches ALL secrets from GCP
   - Exports them for docker-compose consumption
   - Validates no hardcoded secrets exist
4. **Update deployment scripts** to enforce secrets sync before start

### Phase 4: Validation
1. **Clean slate test** - Delete all volumes, start fresh, verify everything works
2. **Cross-instance test** - USA, FRA, GBR all work with their respective secrets
3. **Terraform idempotency** - Multiple applies don't break secrets
4. **Documentation** - Clear runbook for deployment

---

## ğŸ” FILES TO AUDIT

### Docker Compose Files
```
docker-compose.yml
docker-compose.fra.yml
docker-compose.gbr.yml
docker-compose.deu.yml
docker-compose.shared.yml
docker-compose.monitoring.yml
```
**Check for**: Any inline secret values (passwords, tokens, keys)

### Terraform Files
```
terraform/instances/*.tfvars
terraform/modules/*/variables.tf
terraform/modules/*/main.tf
```
**Check for**: 
- Hardcoded passwords in .tfvars
- Missing secret outputs that should sync to GCP
- Secrets being generated that never get persisted

### Script Files
```
scripts/deploy-dive-instance.sh
scripts/dev-start.sh
scripts/sync-gcp-secrets.sh
scripts/seed-*.sh
```
**Check for**:
- Secret generation without persistence
- Hardcoded default values
- Missing GCP sync steps

### Backend/Frontend Code
```
backend/src/utils/gcp-secrets.ts
backend/src/scripts/*.ts
frontend/.env*
```
**Check for**:
- Fallback defaults that are actual secrets
- Hardcoded connection strings with passwords

---

## ğŸ¯ TARGET ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GCP SECRET MANAGER (SSOT)                     â”‚
â”‚  dive-v3-keycloak-usa, dive-v3-mongodb-usa, etc.                â”‚
â”‚  dive-v3-client-secret-usa (NEW - synced from Terraform)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    sync-gcp-secrets.sh                           â”‚
â”‚  1. Fetch ALL secrets from GCP                                   â”‚
â”‚  2. Export as environment variables                              â”‚
â”‚  3. Validate completeness                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    docker-compose.yml                            â”‚
â”‚  ALL secrets referenced as: ${VAR_NAME:?error message}          â”‚
â”‚  NO inline secrets, NO hardcoded defaults                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Running Containers                            â”‚
â”‚  Secrets injected via environment variables                      â”‚
â”‚  Same secrets used by Terraform (passwords match)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TERRAFORM (Keycloak IaC)                      â”‚
â”‚  1. READS admin passwords FROM GCP (not from .tfvars)            â”‚
â”‚  2. Creates realms, clients, users                               â”‚
â”‚  3. WRITES generated client secrets TO GCP                       â”‚
â”‚  4. State file tracks what was created                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ SPECIFIC ISSUES FOUND

### Issue 1: docker-compose.yml has hardcoded KEYCLOAK_CLIENT_SECRET
```yaml
# WRONG - This is hardcoded
KEYCLOAK_CLIENT_SECRET: 8AcfbgtdNIZp3tbrcmc2voiUfxNb8d6L

# CORRECT - Reference environment variable
KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:?GCP secret required}
```

### Issue 2: usa.tfvars has hardcoded keycloak_admin_password
```hcl
# WRONG - Hardcoded and out of sync with GCP
keycloak_admin_password = "DivePilot2025!SecureAdmin"

# CORRECT - Read from environment (sourced from GCP)
# In provider.tf, use: password = var.keycloak_admin_password
# The variable should come from TF_VAR_keycloak_admin_password env var
```

### Issue 3: Terraform generates client_secret but never syncs to GCP
```hcl
# Terraform creates this secret
resource "keycloak_openid_client" "broker_client" {
  # ... client_secret is auto-generated
}

# MISSING: Sync to GCP Secret Manager
resource "google_secret_manager_secret_version" "client_secret" {
  secret      = "dive-v3-client-secret-${var.instance_code}"
  secret_data = keycloak_openid_client.broker_client.client_secret
}
```

### Issue 4: No validation that secrets are loaded before starting
```bash
# deploy scripts should FAIL FAST if secrets aren't loaded
if [ -z "$KEYCLOAK_ADMIN_PASSWORD" ]; then
  echo "ERROR: KEYCLOAK_ADMIN_PASSWORD not set. Run: source ./scripts/sync-gcp-secrets.sh"
  exit 1
fi
```

---

## âœ… ACCEPTANCE CRITERIA

1. **Zero hardcoded secrets** in version control
2. **GCP Secret Manager is SSOT** for all secrets
3. **Terraform syncs TO GCP** - generated secrets are persisted
4. **Terraform reads FROM GCP** - admin passwords come from GCP
5. **docker-compose uses ONLY env vars** - no inline values
6. **Deployment scripts validate** - fail fast if secrets missing
7. **Clean slate works** - fresh `docker volume prune && terraform apply && docker-compose up` succeeds
8. **All instances work** - USA, FRA, GBR, DEU all start correctly
9. **Tests pass** - backend tests don't fail due to secrets mismatch

---

## ğŸš€ EXECUTION STEPS

```bash
# Step 1: Audit - Find all hardcoded secrets
grep -rn "password\|secret\|PASSWORD\|SECRET" --include="*.yml" --include="*.yaml" --include="*.tf" --include="*.tfvars" . | grep -v ".terraform" | grep -v "node_modules"

# Step 2: List all GCP secrets
gcloud secrets list --project=dive25 --filter="name:dive-v3"

# Step 3: Compare - What's in GCP vs what's in files
# (manual comparison of values)

# Step 4: Fix docker-compose files
# Replace ALL hardcoded secrets with ${VAR:?message} syntax

# Step 5: Fix Terraform
# Add GCP Secret Manager provider
# Read admin passwords from GCP
# Write client secrets to GCP

# Step 6: Update sync script
# Ensure ALL required secrets are fetched and exported

# Step 7: Update deployment scripts
# Add validation before docker-compose up

# Step 8: Clean slate test
docker compose down -v
docker volume prune -f
source ./scripts/sync-gcp-secrets.sh
terraform -chdir=terraform/instances workspace select usa
terraform -chdir=terraform/instances apply -var-file=usa.tfvars -auto-approve
docker compose --env-file .env.gcp -p usa up -d
# Verify everything works

# Step 9: Document
# Update SECRETS-MANAGEMENT.md with the correct architecture
```

---

## ğŸ“Š CURRENT STATE SUMMARY

| Secret Type | GCP Secret Manager | .tfvars | docker-compose | Terraform Generated | IN SYNC? |
|-------------|-------------------|---------|----------------|---------------------|----------|
| Keycloak Admin PW | âœ… dive-v3-keycloak-usa | âŒ Hardcoded different value | âŒ Reads from env (if set) | N/A | âŒ NO |
| Client Secret | âœ… dive-v3-keycloak-client-secret | N/A | âŒ HARDCODED | âœ… Generated fresh | âŒ NO |
| MongoDB PW | âœ… dive-v3-mongodb-usa | N/A | âŒ Partially env | N/A | âš ï¸ MAYBE |
| Postgres PW | âœ… dive-v3-postgres-usa | âŒ Hardcoded | âŒ Reads from env | N/A | âŒ NO |

---

## ğŸ¯ PRIORITY ORDER

1. **HIGH**: Fix docker-compose.yml hardcoded KEYCLOAK_CLIENT_SECRET
2. **HIGH**: Fix usa.tfvars hardcoded keycloak_admin_password 
3. **HIGH**: Add Terraform â†’ GCP sync for client_secret
4. **MEDIUM**: Fix all other docker-compose files
5. **MEDIUM**: Add pre-flight validation to deployment scripts
6. **LOW**: Update documentation

---

## PROMPT FOR AI ASSISTANT

```
You are auditing the DIVE V3 infrastructure. Your task is to:

1. SCAN the entire codebase for hardcoded secrets (passwords, tokens, keys)
2. DOCUMENT where each secret is defined and where it's consumed
3. IDENTIFY mismatches between GCP Secret Manager and other locations
4. FIX all hardcoded secrets to use environment variables
5. UPDATE Terraform to sync generated secrets to GCP
6. UPDATE deployment scripts to validate secrets before starting
7. TEST with a clean slate deployment

Rules:
- GCP Secret Manager is the SINGLE SOURCE OF TRUTH
- NO hardcoded secrets in ANY file
- ALL docker-compose secrets use ${VAR:?message} syntax
- Terraform READS admin passwords FROM environment (sourced from GCP)
- Terraform WRITES generated secrets TO GCP
- Deployment FAILS FAST if required secrets are missing

Start by running:
grep -rn "password\|secret\|PASSWORD\|SECRET" --include="*.yml" --include="*.tf" . | grep -v ".terraform" | grep -v "node_modules" | head -100

Then systematically fix each finding.
```






