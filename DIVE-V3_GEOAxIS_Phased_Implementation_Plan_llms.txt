# DIVE-V3 × GEOAxIS Phased Implementation Plan (Optimized for Claude Sonnet)
## Context
This document describes a **3–5 day Phased Implementation Plan** to integrate the **DIVE-V3 Pilot** with the **GEOAxIS ICAM Services** (Unclassified Test Environment: https://portal-tst.geoaxis.gs.mil/). 
It focuses on four primary ICAM components: **Authentication (AuthN)**, **Authoritative Attributes (AuthA)**, **Authorization (AuthZ)**, and **Non-Person Entity (NPE)**.
The environment is a **proof-of-concept (PoC)** demonstrating interoperability between U.S. and partner nation identity systems via Keycloak federation and Attribute-Based Access Control (ABAC).

---

## PHASED IMPLEMENTATION OVERVIEW

### DAY 1 – Initial Setup & Connectivity (AuthN Groundwork)
**Goal:** Establish network connectivity, verify GEOAxIS endpoints, and prepare NPE & Keycloak configuration.

**Key Tasks:**
1. Log into GEOAxIS Unclassified Test Portal and verify environment registration.
2. Confirm “Identity Broker” and “Authentication (OIDC)” services are enabled.
3. Review or create the **Non-Person Entity (NPE)** client for DIVE-V3.
4. Generate CSR and request an **NPE PKI certificate** via GEOAxIS portal.
5. Enable HTTPS on local **Keycloak** (Docker-based), import GEOAxIS CA certs.
6. Test connectivity with `curl https://oidc.geoaxis.gs.mil/.well-known/openid-configuration`.
7. Plan for OIDC Client Registration (dynamic API or portal).

**Deliverable:** Confirmed connectivity to GEOAxIS endpoints, NPE CSR submitted, Keycloak HTTPS operational.

---

### DAY 2 – Identity Federation (AuthN Integration)
**Goal:** Establish OIDC federation between DIVE-V3 (Keycloak) and GEOAxIS Identity Broker.

**Key Tasks:**
1. Register the DIVE-V3 OIDC client in GEOAxIS (AuthN via Authorization Code Flow).
   - Endpoint: `https://<gxisapi_VIP>/openid/connect/register`
   - Required Scopes: `openid profile email uiasenterprise eiasenterprise`
2. Configure Keycloak Identity Provider (OIDC Broker):
   - Authorization URL: `https://oauth.geoaxis.gs.mil/auth/oauth/v2/authorize`
   - Token URL: `https://oauth.geoaxis.gs.mil/auth/oauth/v2/token`
   - User Info URL: `https://oauth.geoaxis.gs.mil/openid/connect/v1/userinfo`
   - JWKS: `https://oauth.geoaxis.gs.mil/openid/connect/jwks.json`
3. Input GEOAxIS client_id, secret, and scopes.
4. Verify redirect URIs match in both systems.
5. Test AuthN flow: Login → GEOAxIS → Redirect to Keycloak → ID Token validation.

**Deliverable:** Functional OIDC login via GEOAxIS; validated AuthN in Keycloak.

---

### DAY 3 – Authoritative Attributes (AuthA Integration)
**Goal:** Retrieve and map GEOAxIS attributes into Keycloak and DIVE-V3 tokens.

**Key Tasks:**
1. Fetch attributes via `/openid/connect/v1/userinfo` using the GEOAxIS Access Token.
2. Enable **Fetch User Info** in Keycloak Identity Provider configuration.
3. Map GEOAxIS claims → Keycloak attributes (e.g., clearance, EDIPI, countryOfAffiliation).
4. Add Keycloak Protocol Mappers to inject attributes into DIVE-V3 tokens.
5. Validate tokens: confirm AuthA data (clearance, roles) included.
6. (Optional) Implement refresh logic to maintain updated attributes.

**Deliverable:** Attributes flow from GEOAxIS → Keycloak → DIVE-V3 tokens.

---

### DAY 4 – Authorization & Policy Enforcement (AuthZ Integration)
**Goal:** Use OPA/Rego policies to enforce ABAC decisions based on GEOAxIS attributes.

**Key Tasks:**
1. Integrate **Open Policy Agent (OPA)** with DIVE-V3 API/service layer.
2. Provide Keycloak JWT (with GEOAxIS attributes) as OPA input.
3. Develop Rego policies using attributes like `clearance`, `geoaxisRoles`, `countryOfAffiliation`.
4. Validate tokens locally using JWKS (Keycloak or GEOAxIS).
5. Optionally test **token introspection** endpoint for active/valid status.
6. Test policy enforcement end-to-end: user allowed/denied based on attribute values.

**Deliverable:** OPA-driven ABAC operational; AuthZ verified using GEOAxIS-derived attributes.

---

### DAY 5 – NPE Certificate Finalization & Stretch Goals
**Goal:** Finalize secure client-side configuration and advanced OIDC operations.

**Key Tasks:**
1. Install issued **NPE certificate** and test mTLS authentication to GEOAxIS APIs.
2. Enable **Refresh Token** handling (optional).
3. Implement **Single Logout** via GEOAxIS `end_session_endpoint`.
4. Test **Token Revocation** endpoint for security response.
5. Finalize documentation and perform complete E2E test.

**Deliverable:** Fully functional pilot integration covering AuthN, AuthA, AuthZ, and NPE.

---

## STRETCH GOALS
- Attribute enrichment (merge GEOAxIS data with partner attributes).
- Advanced Rego policies (multi-attribute, resource-context).
- Automated token refresh and logout synchronization.
- Monitoring and alerting for token or attribute service failures.

---

## REFERENCES
- GEOAxIS Identity Broker Integration Guide (Gx-0417 v5.2)
- GEOAxIS Connectivity Guide (Gx-0475 v2.1)
- DIVE-V3 Requirements Document
- NGA ICAM Standards for Federation and ABAC

---

## Claude Sonnet Implementation Prompt

**Prompt:**
You are an expert ICAM and OIDC integration engineer specializing in Keycloak, OPA/Rego, and GEOAxIS federation.  
Using the “DIVE-V3 × GEOAxIS Phased Implementation Plan” below, assist the engineering team in implementing the integration.  

Your objectives:
1. Execute configuration tasks day by day.
2. Optimize Keycloak ↔ GEOAxIS OIDC trust.
3. Automate NPE certificate registration & mTLS client integration.
4. Validate AuthN → AuthA → AuthZ → NPE pipeline end-to-end.
5. Generate documentation or scripts (JSON, YAML, or shell) as needed.
6. Assume a local Docker-based Keycloak and OPA environment.

Begin by setting up **Day 1 – Connectivity & NPE Configuration**, verifying access to GEOAxIS endpoints, and preparing Keycloak for OIDC registration.

---
