# =============================================================================
# OPTIMIZED Production Dockerfile for DIVE V3 Backend (Express.js)
# =============================================================================
# Size Reduction: 1.02GB â†’ ~180MB (82% reduction)
# Strategy:
#   - Multi-stage build with production-only dependencies
#   - Remove test frameworks (jest, supertest)
#   - Only include compiled dist/ (no TypeScript source)
#   - Minimal runtime without dev tools
# =============================================================================

FROM node:24-alpine AS base
RUN apk add --no-cache bash curl jq ca-certificates tzdata libc6-compat
WORKDIR /app

# =============================================================================
# STAGE 1: Install PRODUCTION dependencies only
# =============================================================================
FROM base AS deps-prod
WORKDIR /app

COPY package.json package-lock.json* ./

# Install ONLY production dependencies
RUN npm ci --only=production --ignore-scripts --no-audit --no-fund && \
    npm cache clean --force

# =============================================================================
# STAGE 2: Build TypeScript application
# =============================================================================
FROM base AS builder
WORKDIR /app

# Copy dependency manifests
COPY package.json package-lock.json* ./

# Install ALL dependencies (needed for TypeScript compilation)
RUN npm ci --no-audit --no-fund

# Copy TypeScript source
COPY tsconfig.json ./
COPY src ./src

# Compile TypeScript to JavaScript
ENV NODE_ENV=production
RUN npm run build

# =============================================================================
# STAGE 3: Production runtime (minimal)
# =============================================================================
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 expressjs

# Copy ONLY production dependencies (no test/dev tools)
COPY --from=deps-prod --chown=expressjs:nodejs /app/node_modules ./node_modules

# Copy compiled JavaScript (no TypeScript source)
COPY --from=builder --chown=expressjs:nodejs /app/dist ./dist

# Copy package.json for runtime metadata
COPY --from=builder --chown=expressjs:nodejs /app/package.json ./

# Create necessary directories
RUN mkdir -p logs uploads/idp-themes config examples/examples && \
    chown -R expressjs:nodejs /app

USER expressjs

EXPOSE 4000

ENV PORT=4000

# Health check (HTTPS for mTLS)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --no-check-certificate -qO- https://localhost:4000/health || exit 1

# Run compiled JavaScript (HTTPS server for mTLS)
CMD ["node", "dist/https-server.js"]

# =============================================================================
# Expected Image Size: 150-200MB (vs 1.02GB original)
# =============================================================================
# Components:
#   - Base alpine image: ~50MB
#   - Node.js runtime: ~150MB
#   - Production node_modules: ~80MB (vs 420MB with test deps)
#   - Compiled dist/: ~10MB
#   - Total: ~180MB
# =============================================================================
