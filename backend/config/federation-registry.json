{
  "$schema": "./federation-registry.schema.json",
  "version": "3.1.0",
  "metadata": {
    "lastUpdated": "2025-11-30T12:00:00Z",
    "maintainer": "DIVE V3 Ops Team",
    "compliance": [
      "ACP-240",
      "NIST 800-63",
      "STANAG 4774",
      "STANAG 4778"
    ],
    "description": "DIVE V3 Federation Registry - Single Source of Truth for ALL instance configurations including service definitions, ports, routing, and healthcheck configurations"
  },
  "serviceDefaults": {
    "_comment": "Default internal ports for all services - containers always listen on these ports",
    "frontend": {
      "internalPort": 3000,
      "protocol": "https",
      "healthcheck": "/",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "30s"
    },
    "backend": {
      "internalPort": 4000,
      "protocol": "https",
      "healthcheck": "/health",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "30s"
    },
    "keycloak": {
      "internalPort": 8443,
      "internalPortHttp": 8080,
      "protocol": "https",
      "healthcheck": "/health/ready",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "60s"
    },
    "kas": {
      "internalPort": 8080,
      "protocol": "http",
      "healthcheck": "/health",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "30s"
    },
    "postgres": {
      "internalPort": 5432,
      "protocol": "tcp",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "30s"
    },
    "mongodb": {
      "internalPort": 27017,
      "protocol": "tcp",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "30s"
    },
    "redis": {
      "internalPort": 6379,
      "protocol": "tcp",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "10s"
    },
    "opa": {
      "internalPort": 8181,
      "protocol": "http",
      "healthcheck": "/health",
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "10s"
    },
    "cloudflared": {
      "restartPolicy": "unless-stopped",
      "stopGracePeriod": "10s"
    }
  },
  "healthcheckTemplates": {
    "_comment": "Standardized healthcheck configurations for Docker Compose (P0 hardening - Nov 30, 2025)",
    "postgres": {
      "test": [
        "CMD-SHELL",
        "pg_isready -U ${POSTGRES_USER:-postgres}"
      ],
      "interval": "10s",
      "timeout": "5s",
      "retries": 5,
      "startPeriod": "10s"
    },
    "mongodb": {
      "test": [
        "CMD",
        "mongosh",
        "--eval",
        "db.adminCommand('ping')"
      ],
      "interval": "10s",
      "timeout": "5s",
      "retries": 5,
      "startPeriod": "10s"
    },
    "redis": {
      "test": [
        "CMD",
        "redis-cli",
        "ping"
      ],
      "interval": "10s",
      "timeout": "5s",
      "retries": 5,
      "startPeriod": "5s"
    },
    "keycloak": {
      "test": [
        "CMD-SHELL",
        "curl -ksf https://localhost:9000/health/ready || exit 1"
      ],
      "interval": "30s",
      "timeout": "10s",
      "retries": 5,
      "startPeriod": "90s",
      "_note": "Keycloak 26+ health on management port 9000 (HTTPS)"
    },
    "opa": {
      "test": [
        "CMD",
        "/opa",
        "version"
      ],
      "interval": "10s",
      "timeout": "5s",
      "retries": 5,
      "startPeriod": "10s",
      "_note": "OPA distroless image only has /opa binary, no wget/curl"
    },
    "backend": {
      "test": [
        "CMD",
        "curl",
        "-kfs",
        "https://localhost:4000/health"
      ],
      "interval": "15s",
      "timeout": "10s",
      "retries": 5,
      "startPeriod": "30s"
    },
    "frontend": {
      "test": [
        "CMD",
        "curl",
        "-kfsI",
        "--max-time",
        "10",
        "https://localhost:3000/"
      ],
      "interval": "30s",
      "timeout": "15s",
      "retries": 10,
      "startPeriod": "120s",
      "_note": "P0 Fix (Dec 2025): max-time increased from 5s to 10s to prevent false unhealthy due to slow SSR"
    },
    "kas": {
      "test": [
        "CMD",
        "curl",
        "-kfs",
        "https://localhost:8080/health"
      ],
      "interval": "15s",
      "timeout": "10s",
      "retries": 5,
      "startPeriod": "30s"
    },
    "cloudflared": {
      "test": [
        "CMD",
        "cloudflared",
        "version"
      ],
      "interval": "30s",
      "timeout": "10s",
      "retries": 5,
      "startPeriod": "30s"
    }
  },
  "defaults": {
    "realm": "dive-v3-broker",
    "clientId": "dive-v3-broker",
    "tokenLifetime": "15m",
    "sessionLifetime": "10h",
    "clearanceLevels": [
      "UNCLASSIFIED",
      "CONFIDENTIAL",
      "SECRET",
      "TOP_SECRET"
    ],
    "passwordPolicy": {
      "minLength": 16,
      "requireUppercase": true,
      "requireLowercase": true,
      "requireDigits": true,
      "requireSpecialChars": true,
      "passwordHistory": 5
    }
  },
  "instances": {
    "usa": {
      "code": "USA",
      "name": "United States",
      "locale": "en-US",
      "type": "local",
      "primary": true,
      "enabled": true,
      "deployment": {
        "provider": "docker",
        "host": "localhost",
        "domain": "dive25.com",
        "composeFile": "docker-compose.yml",
        "projectName": "usa"
      },
      "services": {
        "_comment": "USA is the primary instance - services use base names without suffix",
        "frontend": {
          "name": "frontend",
          "containerName": "dive-v3-frontend",
          "internalPort": 3000,
          "externalPort": 3000,
          "protocol": "https",
          "hostname": "usa-app.dive25.com"
        },
        "backend": {
          "name": "backend",
          "containerName": "dive-v3-backend",
          "internalPort": 4000,
          "externalPort": 4000,
          "protocol": "https",
          "hostname": "usa-api.dive25.com"
        },
        "keycloak": {
          "name": "keycloak",
          "containerName": "dive-v3-keycloak",
          "internalPort": 8443,
          "externalPort": 8443,
          "protocol": "https",
          "hostname": "usa-idp.dive25.com"
        },
        "kas": {
          "name": "kas",
          "containerName": "dive-v3-kas",
          "internalPort": 8080,
          "externalPort": 8090,
          "protocol": "http",
          "hostname": "usa-kas.dive25.com"
        },
        "postgres": {
          "name": "postgres",
          "containerName": "dive-v3-postgres",
          "internalPort": 5432,
          "externalPort": 5433
        },
        "mongodb": {
          "name": "mongo",
          "containerName": "dive-v3-mongo",
          "internalPort": 27017,
          "externalPort": 27017
        },
        "redis": {
          "name": "redis",
          "containerName": "dive-v3-redis",
          "internalPort": 6379,
          "externalPort": 6379
        },
        "opa": {
          "name": "opa",
          "containerName": "dive-v3-opa",
          "internalPort": 8181,
          "externalPort": 8181
        }
      },
      "cloudflare": {
        "tunnelId": "f8e6c558-847b-4952-b8b2-27f98a85e36c",
        "tunnelName": "dive-v3-tunnel",
        "credentialsFile": "cloudflared/tunnel-credentials.json",
        "configFile": "cloudflared/config.yml",
        "metricsPort": 9126
      },
      "secrets": {
        "gcpProjectId": "dive25",
        "keycloakAdmin": "dive-v3-keycloak-usa",
        "keycloakClientSecret": "dive-v3-keycloak-client-secret-usa",
        "postgres": "dive-v3-postgres-usa",
        "mongodb": "dive-v3-mongodb-usa",
        "redis": "dive-v3-redis-usa",
        "authSecret": "dive-v3-auth-secret-usa",
        "jwtSecret": "dive-v3-jwt-secret-usa",
        "nextauthSecret": "dive-v3-nextauth-secret-usa"
      },
      "keycloak": {
        "adminUsername": "admin",
        "database": {
          "name": "keycloak_db",
          "user": "postgres"
        },
        "theme": "dive-v3-usa"
      },
      "mongodb": {
        "database": "dive-v3",
        "user": "admin"
      },
      "testUsers": {
        "create": true,
        "clearances": [
          1,
          2,
          3,
          4
        ],
        "usernameTemplate": "testuser-{code}-{level}",
        "emailDomain": "dive-demo.example"
      }
    },
    "fra": {
      "code": "FRA",
      "name": "France",
      "locale": "fr-FR",
      "type": "local",
      "primary": false,
      "enabled": true,
      "deployment": {
        "provider": "docker",
        "host": "localhost",
        "domain": "dive25.com",
        "composeFile": "docker-compose.fra.yml",
        "projectName": "fra"
      },
      "services": {
        "_comment": "FRA uses -fra suffix on all service names",
        "frontend": {
          "name": "frontend-fra",
          "containerName": "dive-v3-frontend-fra",
          "internalPort": 3000,
          "externalPort": 3001,
          "protocol": "https",
          "hostname": "fra-app.dive25.com"
        },
        "backend": {
          "name": "backend-fra",
          "containerName": "dive-v3-backend-fra",
          "internalPort": 4000,
          "externalPort": 4001,
          "protocol": "https",
          "hostname": "fra-api.dive25.com"
        },
        "keycloak": {
          "name": "keycloak-fra",
          "containerName": "dive-v3-keycloak-fra",
          "internalPort": 8443,
          "externalPort": 8444,
          "protocol": "https",
          "hostname": "fra-idp.dive25.com"
        },
        "kas": {
          "name": "kas-fra",
          "containerName": "dive-v3-kas-fra",
          "internalPort": 8080,
          "externalPort": 8091,
          "protocol": "http",
          "hostname": "fra-kas.dive25.com"
        },
        "postgres": {
          "name": "postgres-fra",
          "containerName": "dive-v3-postgres-fra",
          "internalPort": 5432,
          "externalPort": 5434
        },
        "mongodb": {
          "name": "mongodb-fra",
          "containerName": "dive-v3-mongodb-fra",
          "internalPort": 27017,
          "externalPort": 27018
        },
        "redis": {
          "name": "redis-fra",
          "containerName": "dive-v3-redis-fra",
          "internalPort": 6379,
          "externalPort": 6380
        },
        "opa": {
          "name": "opa-fra",
          "containerName": "dive-v3-opa-fra",
          "internalPort": 8181,
          "externalPort": 8182
        }
      },
      "cloudflare": {
        "tunnelId": "e07574bd-6f32-478b-8f71-42fc3d4073f7",
        "tunnelName": "dive-v3-fra",
        "credentialsFile": "cloudflared/fra-tunnel-credentials.json",
        "configFile": "cloudflared/config-fra.yml",
        "metricsPort": 9127
      },
      "secrets": {
        "gcpProjectId": "dive25",
        "keycloakAdmin": "dive-v3-keycloak-fra",
        "keycloakClientSecret": "dive-v3-keycloak-client-secret-fra",
        "postgres": "dive-v3-postgres-fra",
        "mongodb": "dive-v3-mongodb-fra",
        "redis": "dive-v3-redis-fra",
        "authSecret": "dive-v3-auth-secret-fra",
        "jwtSecret": "dive-v3-jwt-secret-fra",
        "nextauthSecret": "dive-v3-nextauth-secret-fra"
      },
      "keycloak": {
        "adminUsername": "admin",
        "database": {
          "name": "keycloak",
          "user": "keycloak"
        },
        "theme": "dive-v3-fra"
      },
      "mongodb": {
        "database": "dive-v3-fra",
        "user": "admin"
      },
      "testUsers": {
        "create": true,
        "clearances": [
          1,
          2,
          3,
          4
        ],
        "usernameTemplate": "testuser-{code}-{level}",
        "emailDomain": "dive-demo.example"
      }
    },
    "gbr": {
      "code": "GBR",
      "name": "United Kingdom",
      "locale": "en-GB",
      "type": "local",
      "primary": false,
      "enabled": true,
      "deployment": {
        "provider": "docker",
        "host": "localhost",
        "domain": "localhost",
        "composeFile": "instances/gbr/docker-compose.yml",
        "projectName": "gbr"
      },
      "services": {
        "_comment": "GBR uses -gbr suffix on all service names",
        "frontend": {
          "name": "frontend-gbr",
          "containerName": "dive-v3-frontend-gbr",
          "internalPort": 3000,
          "externalPort": 3003,
          "protocol": "https",
          "hostname": "localhost"
        },
        "backend": {
          "name": "backend-gbr",
          "containerName": "dive-v3-backend-gbr",
          "internalPort": 4000,
          "externalPort": 4003,
          "protocol": "https",
          "hostname": "localhost"
        },
        "keycloak": {
          "name": "keycloak-gbr",
          "containerName": "dive-v3-keycloak-gbr",
          "internalPort": 8443,
          "externalPort": 8446,
          "protocol": "https",
          "hostname": "localhost"
        },
        "kas": {
          "name": "kas-gbr",
          "containerName": "dive-v3-kas-gbr",
          "internalPort": 8080,
          "externalPort": 8092,
          "protocol": "http",
          "hostname": "gbr-kas.dive25.com"
        },
        "postgres": {
          "name": "postgres-gbr",
          "containerName": "dive-v3-postgres-gbr",
          "internalPort": 5432,
          "externalPort": 5435
        },
        "mongodb": {
          "name": "mongodb-gbr",
          "containerName": "dive-v3-mongodb-gbr",
          "internalPort": 27017,
          "externalPort": 27019
        },
        "redis": {
          "name": "redis-gbr",
          "containerName": "dive-v3-redis-gbr",
          "internalPort": 6379,
          "externalPort": 6381
        },
        "opa": {
          "name": "opa-gbr",
          "containerName": "dive-v3-opa-gbr",
          "internalPort": 8181,
          "externalPort": 8183
        }
      },
      "cloudflare": {
        "tunnelId": "375d2bed-2002-4604-9fa6-22ca251ac957",
        "tunnelName": "dive-v3-gbr",
        "credentialsFile": "cloudflared/gbr-tunnel-credentials.json",
        "configFile": "cloudflared/config-gbr.yml",
        "metricsPort": 9128
      },
      "secrets": {
        "gcpProjectId": "dive25",
        "keycloakAdmin": "dive-v3-keycloak-gbr",
        "keycloakClientSecret": "dive-v3-keycloak-client-secret-gbr",
        "postgres": "dive-v3-postgres-gbr",
        "mongodb": "dive-v3-mongodb-gbr",
        "redis": "dive-v3-redis-gbr",
        "authSecret": "dive-v3-auth-secret-gbr",
        "jwtSecret": "dive-v3-jwt-secret-gbr",
        "nextauthSecret": "dive-v3-nextauth-secret-gbr"
      },
      "keycloak": {
        "adminUsername": "admin",
        "database": {
          "name": "keycloak",
          "user": "keycloak"
        },
        "theme": "dive-v3-gbr"
      },
      "mongodb": {
        "database": "dive-v3-gbr",
        "user": "admin"
      },
      "testUsers": {
        "create": true,
        "clearances": [
          1,
          2,
          3,
          4
        ],
        "usernameTemplate": "testuser-{code}-{level}",
        "emailDomain": "dive-demo.example"
      }
    },
    "deu": {
      "code": "DEU",
      "name": "Germany",
      "locale": "de-DE",
      "type": "remote",
      "primary": false,
      "enabled": true,
      "deployment": {
        "provider": "docker",
        "host": "192.168.42.120",
        "domain": "prosecurity.biz",
        "composeFile": "docker-compose.deu.yml",
        "projectName": "deu",
        "sshUser": "mike",
        "sshKeyPath": "~/.ssh/id_rsa",
        "remotePath": "/opt/dive-v3"
      },
      "services": {
        "_comment": "DEU uses -deu suffix on all service names",
        "frontend": {
          "name": "frontend-deu",
          "containerName": "dive-v3-frontend-deu",
          "internalPort": 3000,
          "externalPort": 3000,
          "protocol": "https",
          "hostname": "deu-app.prosecurity.biz"
        },
        "backend": {
          "name": "backend-deu",
          "containerName": "dive-v3-backend-deu",
          "internalPort": 4000,
          "externalPort": 4000,
          "protocol": "https",
          "hostname": "deu-api.prosecurity.biz"
        },
        "keycloak": {
          "name": "keycloak-deu",
          "containerName": "dive-v3-keycloak-deu",
          "internalPort": 8443,
          "externalPort": 8443,
          "protocol": "https",
          "hostname": "deu-idp.prosecurity.biz"
        },
        "kas": {
          "name": "kas-deu",
          "containerName": "dive-v3-kas-deu",
          "internalPort": 8080,
          "externalPort": 8080,
          "protocol": "http",
          "hostname": "deu-kas.prosecurity.biz"
        },
        "postgres": {
          "name": "postgres-deu",
          "containerName": "dive-v3-postgres-deu",
          "internalPort": 5432,
          "externalPort": 5432
        },
        "mongodb": {
          "name": "mongodb-deu",
          "containerName": "dive-v3-mongodb-deu",
          "internalPort": 27017,
          "externalPort": 27017
        },
        "redis": {
          "name": "redis-deu",
          "containerName": "dive-v3-redis-deu",
          "internalPort": 6379,
          "externalPort": 6379
        },
        "opa": {
          "name": "opa-deu",
          "containerName": "dive-v3-opa-deu",
          "internalPort": 8181,
          "externalPort": 8181
        }
      },
      "cloudflare": {
        "tunnelId": "2112e264-61e3-463f-9d13-b55273bde204",
        "tunnelName": "dive-v3-deu-prosecurity",
        "credentialsFile": "cloudflared/deu-tunnel-credentials.json",
        "configFile": "cloudflared/config-deu.yml",
        "metricsPort": 9129
      },
      "secrets": {
        "gcpProjectId": "dive25",
        "keycloakAdmin": "dive-v3-keycloak-deu",
        "keycloakClientSecret": "dive-v3-keycloak-client-secret-deu",
        "postgres": "dive-v3-postgres-deu",
        "mongodb": "dive-v3-mongodb-deu",
        "redis": "dive-v3-redis-deu",
        "authSecret": "dive-v3-auth-secret-deu",
        "jwtSecret": "dive-v3-jwt-secret-deu",
        "nextauthSecret": "dive-v3-nextauth-secret-deu"
      },
      "keycloak": {
        "adminUsername": "admin",
        "database": {
          "name": "keycloak",
          "user": "keycloak"
        },
        "theme": "dive-v3-deu"
      },
      "mongodb": {
        "database": "dive-v3-deu",
        "user": "admin"
      },
      "testUsers": {
        "create": true,
        "clearances": [
          1,
          2,
          3,
          4
        ],
        "usernameTemplate": "testuser-{code}-{level}",
        "emailDomain": "dive-demo.example"
      }
    },
    "hun": {
      "code": "HUN",
      "name": "Hungary",
      "locale": "hu-HU",
      "type": "local",
      "primary": false,
      "enabled": true,
      "deployment": {
        "provider": "docker",
        "host": "localhost",
        "domain": "dive25.com",
        "composeFile": "docker-compose.hun.yml",
        "projectName": "hun"
      },
      "services": {
        "_comment": "HUN uses hun- prefix on all service names",
        "frontend": {
          "name": "frontend-hun",
          "containerName": "hun-frontend-hun-1",
          "internalPort": 3000,
          "externalPort": 3457,
          "protocol": "https",
          "hostname": "hun-app.dive25.com"
        },
        "backend": {
          "name": "backend-hun",
          "containerName": "hun-backend-hun-1",
          "internalPort": 4000,
          "externalPort": 4457,
          "protocol": "https",
          "hostname": "hun-api.dive25.com"
        },
        "keycloak": {
          "name": "keycloak-hun",
          "containerName": "hun-keycloak-hun-1",
          "internalPort": 8443,
          "externalPort": 8456,
          "protocol": "https",
          "hostname": "hun-idp.dive25.com"
        },
        "kas": {
          "name": "kas-hun",
          "containerName": "hun-kas-hun-1",
          "internalPort": 8080,
          "externalPort": 8457,
          "protocol": "http",
          "hostname": "hun-kas.dive25.com"
        },
        "mongodb": {
          "name": "mongodb-hun",
          "containerName": "hun-mongodb-hun-1",
          "internalPort": 27017,
          "externalPort": 27020,
          "protocol": "mongodb"
        },
        "redis": {
          "name": "redis-hun",
          "containerName": "hun-redis-hun-1",
          "internalPort": 6379,
          "externalPort": 6382,
          "protocol": "redis"
        },
        "postgres": {
          "name": "postgres-hun",
          "containerName": "hun-postgres-hun-1",
          "internalPort": 5432,
          "externalPort": 5435,
          "protocol": "postgresql"
        },
        "opa": {
          "name": "opa-hun",
          "containerName": "hun-opa-hun-1",
          "internalPort": 8181,
          "externalPort": 8184,
          "protocol": "http"
        }
      }
    }
  },
  "federation": {
    "model": "hub-spoke",
    "matrix": {
      "usa": [
        "fra",
        "gbr",
        "deu",
        "hun"
      ],
      "fra": [
        "usa",
        "gbr",
        "deu"
      ],
      "gbr": [
        "usa",
        "fra",
        "deu"
      ],
      "deu": [
        "usa",
        "fra",
        "gbr"
      ],
      "hun": [
        "usa",
        "fra",
        "gbr",
        "deu"
      ]
    },
    "defaultEnabled": true,
    "trustModel": "bilateral",
    "attributeMapping": {
      "clearance": {
        "required": true,
        "claim": "clearance",
        "type": "string",
        "enum": [
          "UNCLASSIFIED",
          "CONFIDENTIAL",
          "SECRET",
          "TOP_SECRET"
        ]
      },
      "countryOfAffiliation": {
        "required": true,
        "claim": "countryOfAffiliation",
        "type": "string",
        "format": "ISO-3166-1-alpha-3"
      },
      "uniqueID": {
        "required": true,
        "claim": "uniqueID",
        "type": "string"
      },
      "acpCOI": {
        "required": false,
        "claim": "acpCOI",
        "type": "array",
        "items": {
          "type": "string",
          "enum": [
            "NATO",
            "NATO-COSMIC",
            "FVEY",
            "CAN-US",
            "US-ONLY"
          ]
        }
      }
    }
  },
  "gcp": {
    "projectId": "dive25",
    "region": "us-east4",
    "services": {
      "secretManager": {
        "enabled": true,
        "replicationPolicy": "user-managed",
        "locations": [
          "us-east4"
        ]
      },
      "logging": {
        "enabled": true,
        "retention": "90d"
      },
      "monitoring": {
        "enabled": true,
        "alerting": true
      }
    }
  },
  "monitoring": {
    "prometheus": {
      "port": 9090,
      "scrapeInterval": "30s"
    },
    "grafana": {
      "port": 3333,
      "adminUser": "admin"
    },
    "statusPage": {
      "port": 8888,
      "checkInterval": "60s"
    },
    "blacklistRedis": {
      "port": 6399,
      "network": "dive-v3-shared-network"
    }
  }
}
