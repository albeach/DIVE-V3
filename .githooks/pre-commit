#!/usr/bin/env bash
#
# Git pre-commit hook for DIVE V3
# Prevents committing hardcoded localhost URLs and debug telemetry
#

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "üîç Running DIVE V3 pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}‚úÖ No files to check${NC}"
  exit 0
fi

# Track if any issues are found
ISSUES_FOUND=0

# Check 1: Hardcoded localhost/127.0.0.1 URLs (DISABLED - too noisy for local dev)
# Localhost URLs are acceptable in:
# - Test files (playwright.config.ts, test helpers, test fixtures)
# - Local development configuration
# - Instance configuration files (instances/*/config.json)
# Production deployments use environment variables automatically
echo "  Checking for hardcoded localhost URLs... SKIPPED"

# Check 2: Debug telemetry endpoints (port 7243)
echo "  Checking for debug telemetry calls..."
if echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null; then
  TELEMETRY_MATCHES=$(git diff --cached | grep -E "^\+.*127\.0\.0\.1:7243" || true)

  if [ -n "$TELEMETRY_MATCHES" ]; then
    echo "${RED}‚ùå ERROR: Debug telemetry calls found (port 7243):${NC}"
    echo "$TELEMETRY_MATCHES" | head -3
    echo ""
    echo "${YELLOW}üí° Remove debug telemetry or use environment variable:${NC}"
    echo "   const DEBUG_URL = process.env.DEBUG_TELEMETRY_URL;"
    echo "   if (DEBUG_URL) { fetch(DEBUG_URL, ...); }"
    echo ""
    ISSUES_FOUND=1
  fi
fi

# Check 3: #region agent log comments
echo "  Checking for debug region markers..."
if echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null; then
  AGENT_LOG_MATCHES=$(git diff --cached | grep -E "^\+.*#region agent log" || true)

  if [ -n "$AGENT_LOG_MATCHES" ]; then
    echo "${RED}‚ùå ERROR: Debug '#region agent log' markers found:${NC}"
    echo "$AGENT_LOG_MATCHES"
    echo ""
    echo "${YELLOW}üí° Remove debug regions before committing${NC}"
    echo ""
    ISSUES_FOUND=1
  fi
fi

# Check 4: Hardcoded secrets patterns (basic check)
echo "  Checking for potential hardcoded secrets..."
if echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|yml|yaml)$' > /dev/null; then
  SECRET_PATTERNS=$(git diff --cached | grep -iE "^\+.*(password|secret|api_key|apikey|access_token).*['\"]=['\"][^'\"]{8,}" || true)

  if [ -n "$SECRET_PATTERNS" ]; then
    echo "${YELLOW}‚ö†Ô∏è  WARNING: Possible hardcoded secrets detected:${NC}"
    echo "$SECRET_PATTERNS" | head -3
    echo ""
    echo "${YELLOW}üí° Use GCP Secret Manager or environment variables${NC}"
    echo "   See: backend/src/utils/gcp-secrets.ts"
    echo ""
    # This is a warning, not a blocker
  fi
fi

# Check 5: Verify no dive-v3-* container names in federation registry
echo "  Checking federation registry for incorrect container names..."
if echo "$STAGED_FILES" | grep -q "federation-registry.json"; then
  WRONG_CONTAINERS=$(git diff --cached -- "**/federation-registry.json" | grep -E "^\+.*containerName.*dive-v3-(backend|frontend|keycloak)" || true)

  if [ -n "$WRONG_CONTAINERS" ]; then
    echo "${RED}‚ùå ERROR: Incorrect container names in federation registry:${NC}"
    echo "$WRONG_CONTAINERS"
    echo ""
    echo "${YELLOW}üí° USA hub containers should use 'dive-hub-*' prefix${NC}"
    echo "   Example: dive-hub-backend (not dive-v3-backend)"
    echo ""
    ISSUES_FOUND=1
  fi
fi

# Final result
echo ""
if [ $ISSUES_FOUND -eq 1 ]; then
  echo "${RED}‚ùå Pre-commit checks FAILED${NC}"
  echo ""
  echo "To bypass this check (not recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
else
  echo "${GREEN}‚úÖ All pre-commit checks passed${NC}"
  exit 0
fi
