# =============================================================================
# DIVE V3 Spoke Instance: {{INSTANCE_CODE_UPPER}} ({{INSTANCE_NAME}})
# =============================================================================
# Template Version: 2.8.1
# Template Last Updated: {{TEMPLATE_LAST_UPDATED}}
# Template Hash: {{TEMPLATE_HASH}}
# Generated At: {{TIMESTAMP}}
# Spoke ID: {{SPOKE_ID}}
# =============================================================================
#
# BREAKING CHANGES in 2.5.0:
# - Unified network naming: 'internal' instead of 'dive-${code}-network'
# - Simplified volume declarations (no code prefix, relies on project name)
# - Keycloak 24.0.0 (from 23.0.0)
# - MongoDB 7.0 (from 6.0)
# - OPA 0.68.0 (from 0.60.0)
#
# FIXES in 2.5.1:
# - Explicitly mapped MongoDB /data/configdb to named volume (mongodb_config)
# - Explicitly mapped OPAL client cache to named volume (opal_cache)
# - Eliminates anonymous Docker volumes created by base images
#
# CRITICAL FIX in 2.6.0:
# - Added container_name directives to all 9 services
# - Prevents Docker Compose auto-naming with -1 suffix
# - Ensures SSOT compliance: dive-spoke-{code}-{service}
# - No more "dive-spoke-pol-keycloak-pol-1" (now "dive-spoke-pol-keycloak")
#
# VERSION ALIGNMENT in 2.7.0:
# - Fixed Redis version: redis:alpine → redis:7-alpine (matches Hub)
# - Fixed OPA version: openpolicyagent/opa:0.68.0 → openpolicyagent/opa:1.12.1 (latest stable)
# - Ensures Hub and Spoke use identical base image versions
# - See DOCKER_IMAGE_VERSION_SSOT.md for complete version matrix
#
# NETWORK FIX in 2.8.0:
# - Backend now on BOTH dive-internal AND dive-shared networks
# - CRITICAL: dive-shared required for Hub federation and OPAL policy sync
# - Fixes "getaddrinfo ENOTFOUND hub.dive25.com" errors
#
# HUB_URL FIX in 2.8.1:
# - Changed default HUB_URL from https://hub.dive25.com to https://dive-hub-backend:4000
# - Uses Docker internal container name for local deployment
# - External deployments can override with HUB_URL environment variable
# =============================================================================
#
# This is a STANDALONE spoke stack - completely separate from Hub.
#
# Placeholders (auto-replaced by ./dive spoke init):
#   {{INSTANCE_CODE_UPPER}} - 3-letter uppercase code (e.g., NZL)
#   {{INSTANCE_CODE_LOWER}} - 3-letter lowercase code (e.g., nzl)
#   {{INSTANCE_NAME}}       - Human-readable name
#   {{SPOKE_ID}}            - Unique spoke identifier
#   {{IDP_HOSTNAME}}        - Keycloak hostname
#   {{API_URL}}             - Backend API URL
#   {{BASE_URL}}            - Frontend URL
#   {{IDP_URL}}             - Keycloak IdP URL
#   {{KEYCLOAK_HOST_PORT}}  - Keycloak HTTPS port (e.g., 18443)
#   {{BACKEND_HOST_PORT}}   - Backend port (e.g., 14000)
#   {{FRONTEND_HOST_PORT}}  - Frontend port (e.g., 13000)
#   {{OPA_HOST_PORT}}       - OPA port (e.g., 18181)
#   {{KAS_HOST_PORT}}       - KAS port (e.g., 18085)
#
# Usage:
#   cd instances/{{INSTANCE_CODE_LOWER}}
#   docker compose --env-file .env up -d
#
# =============================================================================

# Project name ensures complete isolation from Hub
name: dive-spoke-{{INSTANCE_CODE_LOWER}}

networks:
  dive-internal:
    driver: bridge
  dive-shared:
    external: true

volumes:
  postgres_data:
  mongodb_data:
  mongodb_config:  # MongoDB config directory (prevent anonymous volume)
  redis_data:
  opal_cache:
  frontend_modules:
  frontend_next:
  backend_node_modules:
  backend_logs:
  kas_logs:

services:
  # ==========================================================================
  # DATABASE SERVICES
  # ==========================================================================

  postgres-{{INSTANCE_CODE_LOWER}}:
    image: postgres:15-alpine
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-postgres
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - dive-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mongodb-{{INSTANCE_CODE_LOWER}}:
    image: mongo:7-jammy
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-mongodb
    environment:
      MONGO_INITDB_DATABASE: dive-v3-{{INSTANCE_CODE_LOWER}}
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb  # Prevent anonymous volume creation
    networks:
      - dive-internal
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-{{INSTANCE_CODE_LOWER}}:
    image: redis:7-alpine
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-redis
    volumes:
      - redis_data:/data
    networks:
      - dive-internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==========================================================================
  # IDENTITY & ACCESS MANAGEMENT
  # ==========================================================================

  keycloak-{{INSTANCE_CODE_LOWER}}:
    build:
      context: ../../keycloak
      dockerfile: Dockerfile
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-keycloak
    entrypoint: ["/bin/bash", "/opt/keycloak/scripts/import-realm.sh"]
    command: ["start-dev", "--spi-login-protocol-openid-connect-suppress-logout-confirmation-screen=true", "--features=scripts"]
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-{{INSTANCE_CODE_LOWER}}:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD}
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME: {{IDP_HOSTNAME}}
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/certs/certificate.pem
      KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/certs/key.pem
      KC_HTTPS_PORT: "8443"
      KC_LOG_LEVEL: info
      KC_FEATURES: scripts
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      # Realm import environment variables (CRITICAL: Must match frontend secrets)
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      APP_URL: {{BASE_URL}}
      API_URL: {{API_URL}}
      USA_IDP_URL: https://keycloak-{{INSTANCE_CODE_LOWER}}:8443
      USA_IDP_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-DiveAdminSecure2025!}
      TEST_USER_PASSWORD: ${TEST_USER_PASSWORD:-DiveTestSecure2025!}
      INSTANCE_CODE: {{INSTANCE_CODE_UPPER}}
    ports:
      - "{{KEYCLOAK_HOST_PORT}}:8443"
      - "{{KEYCLOAK_HTTP_PORT}}:8080"
    volumes:
      - ./certs:/opt/keycloak/certs:ro
      - ../../keycloak/themes:/opt/keycloak/themes:ro
      - ../../keycloak/realms:/opt/keycloak/realm-templates:ro
    depends_on:
      postgres-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
    networks:
      - dive-internal
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

  # ==========================================================================
  # POLICY ENGINE
  # ==========================================================================

  opa-{{INSTANCE_CODE_LOWER}}:
    image: openpolicyagent/opa:1.12.1
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-opa
    platform: linux/amd64
    command: run --server --addr :8181 /policies/base /policies/entrypoints /policies/tenant /policies/org /policies/compat
    ports:
      - "{{OPA_HOST_PORT}}:8181"
    volumes:
      - ../../policies:/policies:ro
      - ./cache/policies:/var/opa/cache
    networks:
      - dive-internal
    healthcheck:
      test: ["CMD", "/opa", "eval", "true"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  opal-client-{{INSTANCE_CODE_LOWER}}:
    build:
      context: ../../docker
      dockerfile: opal-client.Dockerfile
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-opal-client
    environment:
      # Hub OPAL Server URL - from environment variable (required)
      OPAL_SERVER_URL: ${HUB_OPAL_URL:?HUB_OPAL_URL required - set in .env}
      # Authentication - token and public key from Hub
      OPAL_CLIENT_TOKEN: ${SPOKE_OPAL_TOKEN:?SPOKE_OPAL_TOKEN required - obtain from Hub}
      OPAL_AUTH_PUBLIC_KEY: ${OPAL_AUTH_PUBLIC_KEY}
      OPAL_INLINE_OPA_ENABLED: "false"
      OPAL_OPA_URL: http://opa-{{INSTANCE_CODE_LOWER}}:8181
      OPAL_SUBSCRIPTION_ID: {{SPOKE_ID}}
      # Data topics to subscribe to (must match Hub topics)
      OPAL_DATA_TOPICS: policy_data
      OPAL_LOG_LEVEL: INFO
      OPAL_KEEP_ALIVE_TIMEOUT: 60
      OPAL_RECONNECT_INTERVAL: 5
      OPAL_RECONNECT_MAX_INTERVAL: 300
      OPAL_POLICY_REFRESH_INTERVAL: 60
      # Local OPA policy/data store
      OPAL_POLICY_STORE_URL: http://opa-{{INSTANCE_CODE_LOWER}}:8181/v1/policies
      OPAL_DATA_STORE_URL: http://opa-{{INSTANCE_CODE_LOWER}}:8181/v1/data
    volumes:
      - opal_cache:/var/opal/cache
      - ./certs:/var/opal/certs:ro
    depends_on:
      opa-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
    networks:
      - dive-internal
    extra_hosts:
      - "localhost:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    # NO profiles restriction - ALWAYS start for policy sync with Hub

  # ==========================================================================
  # BACKEND API
  # ==========================================================================

  backend-{{INSTANCE_CODE_LOWER}}:
    build:
      context: ../../backend
      dockerfile: Dockerfile.dev
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-backend
    command: ["/bin/sh","-c","mkdir -p /app/certs/crl && npm install && npm run dev"]
    environment:
      NODE_ENV: development
      # SECURITY: Trust mkcert CA instead of disabling TLS verification
      NODE_EXTRA_CA_CERTS: /app/certs/ca/rootCA.pem
      PORT: "4000"
      INSTANCE_CODE: {{INSTANCE_CODE_UPPER}}
      INSTANCE_NAME: "{{INSTANCE_NAME}}"
      SPOKE_ID: {{SPOKE_ID}}
      SPOKE_MODE: "true"
      # MongoDB
      MONGODB_URI: mongodb://admin:${MONGO_PASSWORD}@mongodb-{{INSTANCE_CODE_LOWER}}:27017/dive-v3-{{INSTANCE_CODE_LOWER}}?authSource=admin
      MONGODB_URL: mongodb://admin:${MONGO_PASSWORD}@mongodb-{{INSTANCE_CODE_LOWER}}:27017/dive-v3-{{INSTANCE_CODE_LOWER}}?authSource=admin
      MONGODB_DATABASE: dive-v3-{{INSTANCE_CODE_LOWER}}
      REDIS_URL: redis://redis-{{INSTANCE_CODE_LOWER}}:6379
      # Keycloak
      KEYCLOAK_URL: {{IDP_BASE_URL}}
      KEYCLOAK_REALM: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      KEYCLOAK_ISSUER: {{IDP_BASE_URL}}/realms/dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      # CRITICAL: Include Hub issuer for cross-instance federation
      TRUSTED_ISSUERS: {{IDP_BASE_URL}}/realms/dive-v3-broker-{{INSTANCE_CODE_LOWER}},https://keycloak-{{INSTANCE_CODE_LOWER}}:8443/realms/dive-v3-broker-{{INSTANCE_CODE_LOWER}},https://localhost:8443/realms/dive-v3-broker,https://keycloak:8443/realms/dive-v3-broker,https://usa-idp.dive25.com/realms/dive-v3-broker
      KEYCLOAK_ADMIN_USER: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      # OPA
      OPA_URL: http://opa-{{INSTANCE_CODE_LOWER}}:8181
      # API URL for Swagger/OpenAPI documentation
      API_URL: {{API_URL}}
      # CORS
      NEXT_PUBLIC_BASE_URL: {{BASE_URL}}
      FEDERATION_ALLOWED_ORIGINS: {{BASE_URL}},{{API_URL}},{{IDP_URL}}
      # Hub federation - use Docker internal container name for local deployment
      HUB_URL: ${HUB_URL:-https://dive-hub-backend:4000}
      SPOKE_TOKEN: ${SPOKE_OPAL_TOKEN}
      SPOKE_CONFIG_PATH: /app/config/config.json
      DIVE_POLICY_CACHE_PATH: /app/cache/policies
      DIVE_AUDIT_QUEUE_PATH: /app/cache/audit
    ports:
      - "{{BACKEND_HOST_PORT}}:4000"
    volumes:
      - ../../backend:/app
      - backend_node_modules:/app/node_modules
      - ./certs:/app/certs:rw
      - ./certs:/opt/keycloak/certs:ro
      - ../../certs/mkcert:/app/certs/ca:ro  # mkcert root CA for TLS trust
      - ./config.json:/app/config/config.json:ro
      - ../../config:/app/config/shared:ro
      - ./cache:/app/cache
      - backend_logs:/app/logs
    depends_on:
      mongodb-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
      opa-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
    networks:
      - dive-internal      # Internal spoke communication
      - dive-shared        # CRITICAL: Required for Hub federation and OPAL policy sync
    healthcheck:
      test: ["CMD", "curl", "-sf", "https://localhost:4000/health", "-k"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================================================================
  # KAS - Key Access Service
  # ==========================================================================

  kas-{{INSTANCE_CODE_LOWER}}:
    build:
      context: ../../kas
      dockerfile: Dockerfile
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-kas
    environment:
      NODE_ENV: development
      KAS_PORT: 8080
      HTTPS_ENABLED: "true"
      CERT_PATH: /opt/app/certs
      KEY_FILE: key.pem
      CERT_FILE: certificate.pem
      BACKEND_URL: https://backend-{{INSTANCE_CODE_LOWER}}:4000
      # SECURITY: Trust mkcert CA instead of disabling TLS verification
      NODE_EXTRA_CA_CERTS: /opt/app/certs/ca/rootCA.pem
      OPA_URL: http://opa-{{INSTANCE_CODE_LOWER}}:8181
      MONGODB_URL: mongodb://admin:${MONGO_PASSWORD}@mongodb-{{INSTANCE_CODE_LOWER}}:27017?authSource=admin
      MONGODB_DATABASE: dive-v3-{{INSTANCE_CODE_LOWER}}
      LOG_LEVEL: info
      KEYCLOAK_URL: https://keycloak-{{INSTANCE_CODE_LOWER}}:8443
      KEYCLOAK_REALM: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      KEYCLOAK_CLIENT_ID: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
    ports:
      - "{{KAS_HOST_PORT}}:8080"
    depends_on:
      opa-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
      mongodb-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
    networks:
      - dive-internal
    volumes:
      - ./certs:/opt/app/certs:ro
      - ../../certs/mkcert:/opt/app/certs/ca:ro  # mkcert root CA for TLS trust
      - ../../kas/src:/app/src
      - kas_logs:/app/logs
      - ../../config:/app/config:ro
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate -q -O- https://localhost:8080/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    command: npm run dev
    restart: unless-stopped

  # ==========================================================================
  # FRONTEND
  # ==========================================================================

  frontend-{{INSTANCE_CODE_LOWER}}:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.dev
    container_name: dive-spoke-{{INSTANCE_CODE_LOWER}}-frontend
    # IMPORTANT: Use hash-based detection to reinstall when package.json changes
    # This ensures new dependencies are installed even when node_modules volume exists
    command: ["/bin/sh","-c","rm -f /app/.env.local && if [ ! -f /app/node_modules/.package-hash ] || [ \"$(md5sum /app/package.json | cut -d' ' -f1)\" != \"$(cat /app/node_modules/.package-hash 2>/dev/null)\" ]; then echo 'Package.json changed - reinstalling dependencies...' && npm install && md5sum /app/package.json | cut -d' ' -f1 > /app/node_modules/.package-hash; else echo 'Dependencies up to date'; fi && npm run dev"]
    environment:
      NODE_ENV: development
      # SECURITY: Trust mkcert CA instead of disabling TLS verification
      NODE_EXTRA_CA_CERTS: /app/certs/ca/rootCA.pem
      NEXT_PUBLIC_INSTANCE: {{INSTANCE_CODE_UPPER}}
      NEXT_PUBLIC_INSTANCE_NAME: "{{INSTANCE_NAME}}"
      # Public URLs for client-side requests
      NEXT_PUBLIC_API_URL: {{API_URL}}
      NEXT_PUBLIC_KEYCLOAK_URL: {{IDP_BASE_URL}}
      NEXT_PUBLIC_KEYCLOAK_REALM: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      NEXT_PUBLIC_BACKEND_URL: {{API_URL}}
      # Internal URL for SSR requests
      BACKEND_URL: https://backend-{{INSTANCE_CODE_LOWER}}:4000
      NEXTAUTH_URL: {{BASE_URL}}
      NEXTAUTH_SECRET: ${AUTH_SECRET}
      # Database for NextAuth sessions
      DATABASE_URL: postgres://keycloak:${POSTGRES_PASSWORD}@postgres-{{INSTANCE_CODE_LOWER}}:5432/keycloak
      # Keycloak OAuth config
      KEYCLOAK_URL: {{IDP_BASE_URL}}
      KEYCLOAK_REALM: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      KEYCLOAK_CLIENT_ID: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      # NextAuth v5 Keycloak provider
      AUTH_KEYCLOAK_ID: dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      AUTH_KEYCLOAK_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      AUTH_KEYCLOAK_ISSUER: {{IDP_BASE_URL}}/realms/dive-v3-broker-{{INSTANCE_CODE_LOWER}}
      AUTH_POST_LOGOUT_REDIRECT: {{BASE_URL}}
    ports:
      - "{{FRONTEND_HOST_PORT}}:3000"
    volumes:
      - ../../frontend:/app
      - frontend_modules:/app/node_modules
      - frontend_next:/app/.next
      - ./certs:/app/certs:ro
      - ./certs:/opt/app/certs:ro
      - ../../certs/mkcert:/app/certs/ca:ro  # mkcert root CA for TLS trust
    extra_hosts:
      - "localhost:host-gateway"
    depends_on:
      backend-{{INSTANCE_CODE_LOWER}}:
        condition: service_healthy
    networks:
      - dive-internal
    restart: unless-stopped

  # ==========================================================================
  # CLOUDFLARE TUNNEL (Optional - uncomment if using dive25.com)
  # ==========================================================================

  # cloudflared-{{INSTANCE_CODE_LOWER}}:
  #   image: cloudflare/cloudflared:latest
  #   command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
  #   environment:
  #     TUNNEL_TOKEN: ${TUNNEL_TOKEN}
  #   networks:
  #     - dive-{{INSTANCE_CODE_LOWER}}-network
  #   restart: unless-stopped
