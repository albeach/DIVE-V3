version: "3.8"

# Local/VM override (non-pilot). Keeps base compose untouched and fixes
# env/logging without impacting localhost defaults.
services:
  keycloak:
    environment:
      KC_HOSTNAME: usa-idp.dive25.com
      KC_HOSTNAME_URL: https://usa-idp.dive25.com
      KC_HOSTNAME_ADMIN_URL: https://usa-idp.dive25.com
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_PROXY_HEADERS: xforwarded
      # Correct log format with colons (base compose uses = by default)
      KC_LOG_LEVEL: "DEBUG,org.keycloak.broker:DEBUG,org.keycloak.broker.oidc:DEBUG,org.keycloak.events:DEBUG"

  cloudflared:
    # Faster, reliable DNS for tunnel resolution on VM
    dns:
      - 1.1.1.1
      - 1.0.0.1
    healthcheck:
      disable: true  # distroless image lacks /bin/sh; rely on container status/logs

  # Explicitly disable pilot mode for any services that read this env
  backend:
    environment:
      PILOT_MODE: "false"
      # Tunnel-first; keep localhost as secondary for direct access
      CORS_ALLOWED_ORIGINS: "https://usa-app.dive25.com,https://usa-api.dive25.com,https://usa-idp.dive25.com,http://localhost:3000,https://localhost:3000,http://localhost:4000,https://localhost:4000"
      NEXT_PUBLIC_BASE_URL: "https://usa-app.dive25.com"
      NEXT_PUBLIC_API_URL: "https://usa-api.dive25.com"
      NEXT_PUBLIC_BACKEND_URL: "https://usa-api.dive25.com"
    volumes:
      # Writable CRL directory to satisfy backend CRL manager (base compose mounts certs read-only)
      - backend-crl:/app/certs/crl
  frontend:
    environment:
      PILOT_MODE: "false"
      # Tunnel-first; localhost remains usable for direct dev
      NEXT_PUBLIC_BASE_URL: "https://usa-app.dive25.com"
      NEXT_PUBLIC_API_URL: "https://usa-api.dive25.com"
      NEXT_PUBLIC_BACKEND_URL: "https://usa-api.dive25.com"
      NEXTAUTH_URL: "https://usa-app.dive25.com"
      NEXT_PUBLIC_KEYCLOAK_URL: "https://usa-idp.dive25.com"
      KEYCLOAK_ISSUER: "https://usa-idp.dive25.com/realms/dive-v3-broker"
      AUTH_KEYCLOAK_ISSUER: "https://usa-idp.dive25.com/realms/dive-v3-broker"
  opal-server:
    environment:
      PILOT_MODE: "false"
  opal-client:
    environment:
      PILOT_MODE: "false"

  kas:
    environment:
      PILOT_MODE: "false"
    healthcheck:
      test: ["CMD-SHELL", "curl -ksf https://localhost:8080/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  backend-crl:
